{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h1>
        <p class="text-gray-600 mt-2">Ø¹Ø±Ø¶ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… - Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø¯Ø« Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„ÙŠÙ‡</p>
      </div>
      <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
        <button onclick="exportActivity()" class="btn-success flex items-center justify-center">
          <i class="fas fa-download ml-2"></i>
          ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        </button>
        <button onclick="refreshActivity()" class="btn-primary flex items-center justify-center">
          <i class="fas fa-sync-alt ml-2"></i>
          ØªØ­Ø¯ÙŠØ«
        </button>
      </div>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙÙ„Ø§ØªØ± -->
  <div class="card p-6 mb-6">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <h3 class="text-lg font-semibold text-gray-900">ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
      
      <div class="flex flex-col sm:flex-row gap-4 flex-1 lg:justify-end">
        <!-- ÙÙ„ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
        <div class="flex-1 sm:flex-none">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <select id="user-filter" onchange="applyFilters()" class="form-select">
            <option value="all" {% if user_filter == 'all' %}selected{% endif %}>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>
            {% for user in users %}
            <option value="{{ user }}" {% if user_filter == user %}selected{% endif %}>{{ user }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- ÙÙ„ØªØ± Ø§Ù„ÙØªØ±Ø© -->
        <div class="flex-1 sm:flex-none">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙØªØ±Ø©</label>
          <select id="period-filter" onchange="applyFilters()" class="form-select">
            <option value="all" {% if period_filter == 'all' %}selected{% endif %}>ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª</option>
            <option value="today" {% if period_filter == 'today' %}selected{% endif %}>Ø§Ù„ÙŠÙˆÙ…</option>
            <option value="week" {% if period_filter == 'week' %}selected{% endif %}>Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
            <option value="month" {% if period_filter == 'month' %}selected{% endif %}>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
          </select>
        </div>

        <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† -->
        <div class="flex-1 sm:flex-none flex items-end">
          <button onclick="resetFilters()" class="btn-warning w-full sm:w-auto flex items-center justify-center">
            <i class="fas fa-undo ml-2"></i>
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
          </button>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="mt-6 pt-6 border-t border-gray-200">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center p-3 bg-blue-50 rounded-lg">
          <div class="text-lg font-bold text-blue-600">{{ activities|length }}</div>
          <div class="text-xs text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
        </div>
        <div class="text-center p-3 bg-green-50 rounded-lg">
          <div class="text-lg font-bold text-green-600" id="today-count">{{ today_count }}</div>
          <div class="text-xs text-green-800">Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="text-center p-3 bg-purple-50 rounded-lg">
          <div class="text-lg font-bold text-purple-600">{{ users|length }}</div>
          <div class="text-xs text-purple-800">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</div>
        </div>
        <div class="text-center p-3 bg-orange-50 rounded-lg">
          <div class="text-lg font-bold text-orange-600" id="orders-count">{{ orders_count }}</div>
          <div class="text-xs text-orange-800">Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -->
  <div class="card p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-900">ğŸ•’ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ØµÙØ§Ø©</h3>
      <div class="flex items-center space-x-2 space-x-reverse text-sm text-gray-600">
        <span>Ø¹Ø±Ø¶</span>
        <span class="font-bold text-blue-600" id="filtered-count">{{ activities|length }}</span>
        <span>Ø­Ø¯Ø«</span>
      </div>
    </div>

    {% if activities %}
    <div class="space-y-4" id="activities-list">
      {% for activity in activities %}
      <div class="activity-item flex items-start p-4 {{ get_activity_bg(activity.activity_type) }} rounded-lg border {{ get_activity_border(activity.activity_type) }} hover:shadow-md transition-all duration-200 cursor-pointer"
           onclick="navigateToActivity('{{ activity.activity_type }}', {{ activity.id }}, {{ activity.order_id or 'null' }})"
           title="Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ {{ get_activity_type_arabic(activity.change_type) }}">
        <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div class="text-xl ml-4 mt-1 flex-shrink-0">
          {{ get_activity_icon(activity.activity_type, activity.change_type) }}
        </div>
        
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø· -->
        <div class="flex-1 min-w-0">
          <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„ -->
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
            <div class="flex-1">
              <h4 class="font-semibold {{ get_activity_text_color(activity.activity_type) }} text-sm leading-relaxed">
                {{ activity.details }}
                <span class="inline-block ml-2 text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">
                  <i class="fas fa-external-link-alt"></i>
                </span>
              </h4>
              
              <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
              <div class="flex flex-wrap items-center gap-4 mt-2">
                {% if activity.order_id %}
                <span class="inline-flex items-center text-xs {{ get_activity_badge_color(activity.activity_type) }} px-2 py-1 rounded-full">
                  <i class="fas fa-hashtag ml-1 text-xs"></i>
                  Ø§Ù„Ø·Ù„Ø¨ÙŠØ© #{{ activity.order_id }}
                </span>
                {% endif %}
                
                <span class="inline-flex items-center text-xs {{ get_type_badge_color(activity.change_type) }} px-2 py-1 rounded-full">
                  {{ get_activity_type_arabic(activity.change_type) }}
                </span>

                {% if activity.amount and activity.amount > 0 %}
                <span class="inline-flex items-center text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full">
                  <i class="fas fa-money-bill-wave ml-1 text-xs"></i>
                  {{ activity.amount }} Ø¯Ø¬
                </span>
                {% endif %}

                <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ù†Ù‚Ø± -->
                <span class="inline-flex items-center text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                  <i class="fas fa-mouse-pointer ml-1 text-xs"></i>
                  Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„
                </span>
              </div>
            </div>
            
            <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
            <div class="flex flex-col items-end text-right flex-shrink-0">
              <div class="text-sm font-medium text-gray-900">
                {{ activity.user }}
              </div>
              <div class="text-xs text-gray-500 mt-1">
                {{ activity.timestamp.strftime('%Y-%m-%d') }}
              </div>
              <div class="text-xs text-gray-400">
                {{ activity.timestamp.strftime('%H:%M') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Ø³Ù‡Ù… Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="mr-2 mt-1 text-gray-400 group-hover:text-blue-500 transition-colors">
          <i class="fas fa-chevron-left"></i>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Ø§Ù„ØªØ±Ù‚ÙŠÙ… -->
    <div class="mt-6 flex items-center justify-between">
      <div class="text-sm text-gray-600">
        Ø¹Ø±Ø¶ <span class="font-medium">{{ activities|length }}</span> Ù…Ù† <span class="font-medium">{{ activities|length }}</span> Ø­Ø¯Ø«
      </div>
      
      <div class="flex space-x-2 space-x-reverse">
        <button class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50">
          Ø§Ù„Ø³Ø§Ø¨Ù‚
        </button>
        <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
          1
        </button>
        <button class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50">
          Ø§Ù„ØªØ§Ù„ÙŠ
        </button>
      </div>
    </div>

    {% else %}
    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø­Ø¯Ø§Ø« -->
    <div class="text-center py-12">
      <div class="text-4xl mb-4">ğŸ“­</div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø«</h3>
      <p class="text-gray-600 mb-6">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø§Ø« ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.</p>
      <button onclick="resetFilters()" class="btn-primary">
        <i class="fas fa-undo ml-2"></i>
        Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- JavaScript -->
<script>
  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯Ø«
  function navigateToActivity(activityType, activityId, orderId) {
    let url = '';
    
    switch(activityType) {
      case 'order':
        if (orderId) {
          url = `/orders#order-${orderId}`;
        } else {
          url = '/orders';
        }
        break;
      
      case 'worker':
        url = `/workers#worker-${activityId}`;
        break;
      
      case 'expense':
        url = `/expenses#expense-${activityId}`;
        break;
      
      case 'transport':
        url = `/transport#transport-${activityId}`;
        break;
      
      case 'debt':
        url = `/debts#debt-${activityId}`;
        break;
      
      default:
        url = '/dashboard';
    }
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    window.location.href = url;
  }

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
  function applyFilters() {
    const userFilter = document.getElementById('user-filter').value;
    const periodFilter = document.getElementById('period-filter').value;
    
    const params = new URLSearchParams();
    if (userFilter !== 'all') params.append('user', userFilter);
    if (periodFilter !== 'all') params.append('period', periodFilter);
    
    window.location.href = '/activity?' + params.toString();
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
  function resetFilters() {
    window.location.href = '/activity';
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
  function refreshActivity() {
    window.location.reload();
  }
  
  // ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  function exportActivity() {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„...', 'info');
    setTimeout(() => {
      const userFilter = document.getElementById('user-filter').value;
      const periodFilter = document.getElementById('period-filter').value;
      
      let filename = 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø£Ø­Ø¯Ø§Ø«';
      if (userFilter !== 'all') filename += `_${userFilter}`;
      if (periodFilter !== 'all') filename += `_${periodFilter}`;
      
      showToast(`ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${filename}.pdf`, 'success');
    }, 1500);
  }
  
  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 left-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 ${
      type === 'success' ? 'bg-green-500 text-white' : 
      type === 'error' ? 'bg-red-500 text-white' : 
      'bg-blue-500 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('opacity-100');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('opacity-100');
      toast.classList.add('opacity-0');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„
  document.addEventListener('DOMContentLoaded', function() {
    const activityItems = document.querySelectorAll('.activity-item');
    
    activityItems.forEach(item => {
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„ÙØ£Ø±Ø©
      item.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.borderColor = '#3b82f6';
      });
      
      item.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.borderColor = '';
      });
      
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
      item.addEventListener('mousedown', function() {
        this.style.transform = 'translateY(0)';
        this.style.opacity = '0.8';
      });
      
      item.addEventListener('mouseup', function() {
        this.style.opacity = '1';
      });
    });
  });
</script>

<!-- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù„Ø¨ -->
<style>
  .activity-item {
    transition: all 0.3s ease;
    position: relative;
  }
  
  .activity-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  
  .activity-item::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 0 8px 8px 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .activity-item:hover::after {
    opacity: 1;
  }
  
  .group:hover .group-hover\:opacity-100 {
    opacity: 1;
  }
</style>
{% endblock %}

{% macro get_activity_bg(activity_type) %}
  {% if activity_type == 'order' %}bg-blue-50
  {% elif activity_type == 'worker' %}bg-green-50
  {% elif activity_type == 'expense' %}bg-orange-50
  {% elif activity_type == 'transport' %}bg-indigo-50
  {% elif activity_type == 'debt' %}bg-red-50
  {% else %}bg-gray-50
  {% endif %}
{% endmacro %}

{% macro get_activity_border(activity_type) %}
  {% if activity_type == 'order' %}border-blue-200
  {% elif activity_type == 'worker' %}border-green-200
  {% elif activity_type == 'expense' %}border-orange-200
  {% elif activity_type == 'transport' %}border-indigo-200
  {% elif activity_type == 'debt' %}border-red-200
  {% else %}border-gray-200
  {% endif %}
{% endmacro %}

{% macro get_activity_text_color(activity_type) %}
  {% if activity_type == 'order' %}text-blue-800
  {% elif activity_type == 'worker' %}text-green-800
  {% elif activity_type == 'expense' %}text-orange-800
  {% elif activity_type == 'transport' %}text-indigo-800
  {% elif activity_type == 'debt' %}text-red-800
  {% else %}text-gray-800
  {% endif %}
{% endmacro %}

{% macro get_activity_badge_color(activity_type) %}
  {% if activity_type == 'order' %}text-blue-700 bg-blue-100
  {% elif activity_type == 'worker' %}text-green-700 bg-green-100
  {% elif activity_type == 'expense' %}text-orange-700 bg-orange-100
  {% elif activity_type == 'transport' %}text-indigo-700 bg-indigo-100
  {% elif activity_type == 'debt' %}text-red-700 bg-red-100
  {% else %}text-gray-700 bg-gray-100
  {% endif %}
{% endmacro %}

{% macro get_type_badge_color(change_type) %}
  {% if 'Ø¯ÙØ¹Ø©' in change_type %}text-green-700 bg-green-100
  {% elif 'Ù†Ù‚Ù„' in change_type %}text-indigo-700 bg-indigo-100
  {% elif 'Ù…ØµØ±ÙˆÙ' in change_type %}text-orange-700 bg-orange-100
  {% elif 'Ø·Ù„Ø¨ÙŠØ©' in change_type %}text-blue-700 bg-blue-100
  {% elif 'Ø¹Ø§Ù…Ù„' in change_type %}text-teal-700 bg-teal-100
  {% elif 'Ø¯ÙŠÙ†' in change_type %}text-red-700 bg-red-100
  {% else %}text-purple-700 bg-purple-100
  {% endif %}
{% endmacro %}

{% macro get_activity_icon(activity_type, change_type) %}
  {% if activity_type == 'order' %}
    {% if 'Ø¯ÙØ¹Ø©' in change_type %}ğŸ’°
    {% elif 'Ù†Ù‚Ù„' in change_type %}ğŸšš
    {% elif 'Ù…ØµØ±ÙˆÙ' in change_type %}ğŸ§¾
    {% else %}ğŸ“¦
    {% endif %}
  {% elif activity_type == 'worker' %}
    ğŸ‘·
  {% elif activity_type == 'expense' %}
    ğŸ’¸
  {% elif activity_type == 'transport' %}
    ğŸš›
  {% elif activity_type == 'debt' %}
    ğŸ“‹
  {% else %}
    â„¹ï¸
  {% endif %}
{% endmacro %}

{% macro get_activity_type_arabic(change_type) %}
  {% if 'Ø¯ÙØ¹Ø©' in change_type %}Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©
  {% elif 'Ù†Ù‚Ù„' in change_type %}Ø¹Ù…Ù„ÙŠØ© Ù†Ù‚Ù„
  {% elif 'Ù…ØµØ±ÙˆÙ' in change_type %}Ù…ØµØ±ÙˆÙ
  {% elif 'Ø·Ù„Ø¨ÙŠØ©' in change_type %}Ø·Ù„Ø¨ÙŠØ©
  {% elif 'Ø¹Ø§Ù…Ù„' in change_type %}Ø¹Ø§Ù…Ù„
  {% elif 'Ø¯ÙŠÙ†' in change_type %}Ø¯ÙŠÙ†
  {% else %}{{ change_type }}
  {% endif %}
{% endmacro %}