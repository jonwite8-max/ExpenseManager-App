<!-- templates/orders/orders_scripts.html -->
<script>
// ======================= //
// ğŸ“¦ GLOBAL VARIABLES & INITIALIZATION
// ======================= //
let originalHistoryData = null;
let currentOrderId = null;
let currentRemaining = 0;
let currentUploadedFiles = [];
let attachmentNotesList = [];
let attachmentLabel = '';
let activeModals = new Set();
let isInitialized = false;
let currentHistoryData = [];
let debtMonitoringInterval = null;

// Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const appState = {
    currentOrderId: null,
    activeFilters: {},
    pendingOperations: 0,
    isOnline: navigator.onLine,
    timeouts: {}
};

// Ø­Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ø¬Ù„
const historyFiltersState = {
    user: '',
    type: '',
    dateFrom: '',
    dateTo: '',
    searchText: ''
};

// ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ URL.revokeObjectURL
function safeRevokeObjectURL(url) {
    try {
        if (url && typeof URL !== 'undefined' && URL.revokeObjectURL) {
            URL.revokeObjectURL(url);
        }
    } catch (error) {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø±ÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·:', error);
    }
}

// ======================= //
// ğŸ¯ CORE MODAL MANAGEMENT
// ======================= //

function showModal(modalId) {
    // âœ… Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù†ÙˆØ§ÙØ° Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
    closeAllModals();
    
    if (activeModals.size >= 3) {
        showToast('ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø©', 'warning');
        return;
    }
    
    const modal = document.getElementById(modalId);
    if (modal) {
        // âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            activeModals.add(modalId);
        }, 50);
        
        // âœ… ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
        if (isMobileDevice()) {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.margin = '1rem';
                modalContent.style.maxHeight = 'calc(100vh - 2rem)';
            }
        }
    } else {
        console.error(`Modal ${modalId} not found`);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
        
        activeModals.delete(modalId);
        
        if (activeModals.size === 0) {
            document.body.style.overflow = 'auto';
            document.body.classList.remove('modal-open');
        }
    }
}

// ======================= //
// ğŸ“± MOBILE ENHANCEMENTS
// ======================= //

function isMobileDevice() {
    return window.innerWidth <= 768;
}

function toggleMobilePhoneOptions(phoneNumber, orderId) {
    const callBtn = document.getElementById('mobileCallBtn');
    const whatsappBtn = document.getElementById('mobileWhatsappBtn');
    const copyBtn = document.getElementById('mobileCopyBtn');
    
    if (callBtn) callBtn.href = `tel:${phoneNumber}`;
    if (whatsappBtn) whatsappBtn.href = `https://wa.me/${phoneNumber.replace('+', '').replace(' ', '')}`;
    
    if (copyBtn) {
        copyBtn.onclick = () => {
            copyPhoneNumber(phoneNumber);
        };
    }
    
    showModal('mobilePhoneModal');
}

function editMobileOrder(orderId) {
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    fetch(`/api/orders/${orderId}/basic-info`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('modalTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©';
                document.getElementById('orderForm').action = '/orders/edit/' + orderId;
                document.getElementById('order_id').value = orderId;
                
                document.getElementById('order_name').value = data.order.name || '';
                document.getElementById('order_wilaya').value = data.order.wilaya || '';
                document.getElementById('order_product').value = data.order.product || '';
                document.getElementById('order_paid').value = data.order.paid || '0';
                document.getElementById('order_total').value = data.order.total || '0';
                document.getElementById('order_note').value = data.order.note || '';
                document.getElementById('order_status').value = data.order.status_id || '';
                document.getElementById('order_phone').value = data.order.phone || '';

                showModal('orderModal');
            } else {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading order data:', error);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©', 'error');
        });
}

function initScrollToTop() {
    const scrollButton = document.getElementById('scrollToTop');
    if (scrollButton) {
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                scrollButton.classList.remove('hidden');
            } else {
                scrollButton.classList.add('hidden');
            }
        });
        
        scrollButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
}

function showMobileLoader() {
    const loader = document.getElementById('mobileLoader');
    if (loader) loader.classList.remove('hidden');
}

function hideMobileLoader() {
    const loader = document.getElementById('mobileLoader');
    if (loader) loader.classList.add('hidden');
}

// ======================= //
// ğŸ”” NOTIFICATION SYSTEM
// ======================= //

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${getToastColor(type)}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

function getToastColor(type) {
    const colors = {
        'success': 'toast-success',
        'warning': 'toast-warning',
        'error': 'toast-error',
        'info': 'toast-info'
    };
    return colors[type] || colors.info;
}

// ======================= //
// ğŸ” SMART SEARCH & FILTERS
// ======================= //

function setupSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const workerFilter = document.getElementById('workerFilter');
    const healthFilter = document.getElementById('healthFilter');
    
    if (!searchInput) {
        console.error('âŒ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    // âœ… Ø¨Ø­Ø« Ø°ÙƒÙŠ Ù…Ø¹ ØªØ£Ø®ÙŠØ±
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSmartSearch();
        }, 300);
    });
    
    // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ÙÙ„Ø§ØªØ±
    [statusFilter, workerFilter, healthFilter].forEach(filter => {
        if (filter) {
            filter.addEventListener('change', performSmartSearch);
        }
    });
    
    // âœ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙˆÙ† Ù…Ø¹ Ø§Ù„ÙÙ„Ø§ØªØ±
    performSmartSearch();
}

function performSmartSearch() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const workerFilter = document.getElementById('workerFilter');
    const healthFilter = document.getElementById('healthFilter');
    
    if (!searchInput) {
        console.error('Search input not found');
        return;
    }
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    const statusValue = statusFilter?.value || '';
    const workerValue = workerFilter?.value || '';
    const healthValue = healthFilter?.value || '';
    
    const rows = document.querySelectorAll('#ordersTable tr[data-order-id], .order-card');
    let visibleCount = 0;
    const processedOrders = new Set();
    
    if (rows.length === 0) {
        console.warn('No rows found for filtering');
        return;
    }
    
    rows.forEach(row => {
        try {
            const orderId = row.getAttribute('data-order-id');
            
            if (processedOrders.has(orderId)) {
                row.style.display = 'none';
                return;
            }
            
            processedOrders.add(orderId);
            
            const searchIndex = row.getAttribute('data-search-index') || '';
            const rowStatus = row.dataset.status || '';
            const rowWorkerIds = row.dataset.workerIds || '';
            const rowHealthStatus = row.dataset.healthStatus || '';
            
            const matchesSearch = !searchTerm || searchIndex.includes(searchTerm);
            const matchesStatus = !statusValue || rowStatus === statusValue;
            const matchesWorker = !workerValue || rowWorkerIds.includes(workerValue);
            const matchesHealth = !healthValue || rowHealthStatus === healthValue;
            
            const shouldShow = matchesSearch && matchesStatus && matchesWorker && matchesHealth;
            
            row.style.display = shouldShow ? '' : 'none';
            if (shouldShow) visibleCount++;
            
        } catch (error) {
            console.error('Error filtering row:', error);
            row.style.display = '';
        }
    });
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ø¬Ø¯ÙŠØ¯
    loadOrdersHealthStats();
    
    // âœ… Ø¥Ø´Ø¹Ø§Ø± Ø°ÙƒÙŠ Ø¨Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
    if (searchTerm || statusValue || workerValue || healthValue) {
        const message = visibleCount === 0 ? 
            'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬' : 
            `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${visibleCount} Ø·Ù„Ø¨ÙŠØ©`;
        showToast(message, visibleCount > 0 ? 'success' : 'warning');
    }
}

// ======================= //
// ğŸ’° COST MANAGEMENT SYSTEM
// ======================= //

async function loadTotalCosts() {
    try {
        console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©...');
        
        const response = await fetch('/api/orders/total-costs');
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:', data.costs);
            updateCostsDisplay(data.costs);
            
            // âœ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            updateAdditionalCostStats(data.costs);
            
        } else {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:', data.error);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ', 'error');
            setDefaultCostsValues();
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ', 'error');
        setDefaultCostsValues();
    }
}

function updateCostsDisplay(costs) {
    if (!costs) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙƒØ§Ù„ÙŠÙ Ù„Ù„Ø¹Ø±Ø¶');
        return;
    }
    
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:', costs);
    
    const purchasesCost = document.getElementById('totalPurchasesCost');
    const transportCost = document.getElementById('totalTransportCost');
    const combinedCost = document.getElementById('totalCombinedCost');
    const averageCost = document.getElementById('averageCostPerOrder');
    const purchasesPercentage = document.getElementById('purchasesPercentage');
    const transportPercentage = document.getElementById('transportPercentage');
    const progressBar = document.getElementById('costProgressBar');
    const transportProgressBar = document.getElementById('transportProgressBar');
    const distribution = document.getElementById('costDistribution');
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ©
    if (purchasesCost) purchasesCost.textContent = formatCurrency(costs.total_purchases);
    if (transportCost) transportCost.textContent = formatCurrency(costs.total_transport);
    if (combinedCost) combinedCost.textContent = formatCurrency(costs.total_combined);
    if (averageCost) averageCost.textContent = formatCurrency(costs.average_per_order) + '/Ø·Ù„Ø¨';
    
    const total = costs.total_combined || 1;
    const purchasesPercentageValue = total > 0 ? (costs.total_purchases / total) * 100 : 0;
    const transportPercentageValue = total > 0 ? (costs.total_transport / total) * 100 : 0;
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
    if (purchasesPercentage) purchasesPercentage.textContent = purchasesPercentageValue.toFixed(1) + '%';
    if (transportPercentage) transportPercentage.textContent = transportPercentageValue.toFixed(1) + '%';
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
    if (progressBar) {
        progressBar.style.width = purchasesPercentageValue + '%';
    }
    
    if (transportProgressBar) {
        transportProgressBar.style.width = transportPercentageValue + '%';
        transportProgressBar.style.left = purchasesPercentageValue + '%';
    }
    
    // âœ… ØªØ­Ø¯ÙŠØ« ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    if (distribution) {
        distribution.textContent = 
            `${purchasesPercentageValue.toFixed(1)}% Ù…Ø´ØªØ±ÙŠØ§Øª | ${transportPercentageValue.toFixed(1)}% Ù†Ù‚Ù„`;
    }
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø£Ø´Ø±Ø·Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
    updateProgressBarColors(purchasesPercentageValue, transportPercentageValue);
    
    // âœ… Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    animateCostsUpdate();
}

function updateProgressBarColors(purchasesPercent, transportPercent) {
    const progressBar = document.getElementById('costProgressBar');
    const transportBar = document.getElementById('transportProgressBar');
    
    if (!progressBar || !transportBar) return;
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    if (purchasesPercent < 30) {
        progressBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-green-400 to-emerald-400 transition-all duration-1000';
    } else if (purchasesPercent < 60) {
        progressBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-yellow-400 to-amber-400 transition-all duration-1000';
    } else {
        progressBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-red-400 to-pink-400 transition-all duration-1000';
    }
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ù‚Ù„
    if (transportPercent < 20) {
        transportBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 transition-all duration-1000';
    } else if (transportPercent < 40) {
        transportBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 transition-all duration-1000';
    } else {
        transportBar.className = 'absolute top-0 left-0 h-3 rounded-full bg-gradient-to-r from-indigo-400 to-purple-400 transition-all duration-1000';
    }
}

function animateCostsUpdate() {
    const costElements = [
        'totalPurchasesCost',
        'totalTransportCost', 
        'totalCombinedCost',
        'averageCostPerOrder'
    ];
    
    costElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('cost-value-updating');
            setTimeout(() => {
                element.classList.remove('cost-value-updating');
            }, 1000);
        }
    });
}

function setDefaultCostsValues() {
    const elements = {
        'totalPurchasesCost': '0 Ø¯Ø¬',
        'totalTransportCost': '0 Ø¯Ø¬',
        'totalCombinedCost': '0 Ø¯Ø¬',
        'averageCostPerOrder': '0 Ø¯Ø¬/Ø·Ù„Ø¨',
        'purchasesPercentage': '0%',
        'transportPercentage': '0%'
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = elements[id];
    });
    
    const progressBar = document.getElementById('costProgressBar');
    const transportBar = document.getElementById('transportProgressBar');
    const distribution = document.getElementById('costDistribution');
    
    if (progressBar) progressBar.style.width = '0%';
    if (transportBar) transportBar.style.width = '0%';
    if (distribution) distribution.textContent = '0% Ù…Ø´ØªØ±ÙŠØ§Øª | 0% Ù†Ù‚Ù„';
}

function updateAdditionalCostStats(costs) {
    console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:', costs);
}

function formatCurrency(amount) {
    const numAmount = parseFloat(amount) || 0;
    return new Intl.NumberFormat('ar-DZ', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(numAmount) + ' Ø¯Ø¬';
}

// ======================= //
// ğŸ“Š COSTS REPORT SYSTEM
// ======================= //

function showCostsReportModal() {
    showModal('costsReportModal');
    loadCostsReport();
}

async function loadCostsReport() {
    try {
        showMobileLoader();
        
        const userFilter = document.getElementById('costReportUserFilter')?.value || '';
        const dateFrom = document.getElementById('costReportDateFrom')?.value || '';
        const dateTo = document.getElementById('costReportDateTo')?.value || '';
        
        const params = new URLSearchParams();
        if (userFilter) params.append('user', userFilter);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        const response = await fetch(`/api/orders/costs-report?${params}`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateCostsReportUI(data.report);
        } else {
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ', 'error');
        }
    } catch (error) {
        console.error('Error loading costs report:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ', 'error');
    } finally {
        hideMobileLoader();
    }
}

function updateCostsReportUI(report) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const statsElement = document.getElementById('costsReportStats');
    if (statsElement && report.categories) {
        statsElement.textContent = `${report.categories.length} ØªØµÙ†ÙŠÙ`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
    updateCostsCategoriesGrid(report.categories || []);
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    updateCostsDetailsTable(report.details || []);
}

function updateCostsCategoriesGrid(categories) {
    const container = document.getElementById('costsCategoriesGrid');
    if (!container) return;
    
    if (categories && categories.length > 0) {
        let html = '';
        categories.forEach(category => {
            const percentage = category.percentage || 0;
            const color = getCostCategoryColor(percentage);
            
            html += `
                <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 ${color}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-900">${category.name}</h4>
                        <span class="text-sm font-bold ${color.replace('border-', 'text-')}">
                            ${percentage.toFixed(1)}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 mb-1">
                        ${formatCurrency(category.total_amount)}
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span>${category.transaction_count} Ø¹Ù…Ù„ÙŠØ©</span>
                        <span>${category.user_count} Ù…Ø³ØªØ®Ø¯Ù…</span>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state col-span-3">
                <i class="fas fa-chart-bar"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>
            </div>
        `;
    }
}

function updateCostsDetailsTable(details) {
    const container = document.getElementById('costsDetailsTable');
    if (!container) return;
    
    if (details && details.length > 0) {
        let html = '';
        details.forEach(item => {
            html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${item.category}</td>
                    <td class="p-3">${item.user}</td>
                    <td class="p-3 text-center">${item.transaction_count}</td>
                    <td class="p-3 font-semibold">${formatCurrency(item.total_amount)}</td>
                    <td class="p-3 text-center">${item.percentage?.toFixed(1) || 0}%</td>
                    <td class="p-3">
                        <button onclick="viewCategoryDetails('${item.category}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-eye ml-1"></i>
                            Ø¹Ø±Ø¶
                        </button>
                    </td>
                </tr>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="p-6 text-center text-gray-500">
                    <i class="fas fa-chart-bar text-4xl mb-3 text-gray-300"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>
                </td>
            </tr>
        `;
    }
}

function getCostCategoryColor(percentage) {
    if (percentage >= 30) return 'border-red-500';
    if (percentage >= 15) return 'border-orange-500';
    if (percentage >= 5) return 'border-yellow-500';
    return 'border-green-500';
}

function resetCostsReportFilters() {
    const userFilter = document.getElementById('costReportUserFilter');
    const dateFrom = document.getElementById('costReportDateFrom');
    const dateTo = document.getElementById('costReportDateTo');
    
    if (userFilter) userFilter.value = '';
    if (dateFrom) dateFrom.value = '';
    if (dateTo) dateTo.value = '';
    
    loadCostsReport();
    showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±', 'success');
}

function exportCostsReport() {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªØµØ¯ÙŠØ±...', 'info');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµØ¯ÙŠØ± Ù‡Ù†Ø§
    setTimeout(() => {
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }, 2000);
}

function viewCategoryDetails(categoryName) {
    showToast(`Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ ${categoryName}...`, 'info');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§
}

// ======================= //
// ğŸ’³ DEBT MANAGEMENT SYSTEM
// ======================= //

function showOrdersWithDebts() {
    showModal('ordersDebtsModal');
    loadOrdersWithDebts();
}

async function loadOrdersWithDebts() {
    try {
        showMobileLoader();
        
        const response = await fetch('/api/orders/with_debts');
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateOrdersDebtsUI(data.orders, data.statistics);
        } else {
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙˆÙ†', 'error');
        }
    } catch (error) {
        console.error('Error loading orders with debts:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙˆÙ†', 'error');
    } finally {
        hideMobileLoader();
    }
}

function updateOrdersDebtsUI(orders, statistics) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    updateDebtsStatistics(statistics);
    
    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª
    updateOrdersDebtsList(orders);
}

function updateDebtsStatistics(stats) {
    const totalDebts = document.getElementById('modalTotalDebts');
    const affectedOrders = document.getElementById('modalAffectedOrders');
    const averageDebt = document.getElementById('modalAverageDebt');
    const debtFreeOrders = document.getElementById('modalDebtFreeOrders');
    const summary = document.getElementById('ordersDebtsSummary');
    
    if (totalDebts) totalDebts.textContent = formatCurrency(stats.total_debts);
    if (affectedOrders) affectedOrders.textContent = stats.affected_orders;
    if (averageDebt) averageDebt.textContent = formatCurrency(stats.average_debt);
    if (debtFreeOrders) debtFreeOrders.textContent = stats.debt_free_orders;
    if (summary) {
        summary.textContent = `${stats.affected_orders} Ø·Ù„Ø¨ÙŠØ© Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${formatCurrency(stats.total_debts)} Ø¯ÙŠÙˆÙ†`;
    }
}

function updateOrdersDebtsList(orders) {
    const container = document.getElementById('ordersDebtsList');
    if (!container) return;
    
    if (orders && orders.length > 0) {
        let html = '';
        orders.forEach(order => {
            const statusColor = getDebtStatusColor(order.status);
            
            html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-semibold">#${order.order_id}</td>
                    <td class="p-3">${order.customer_name}</td>
                    <td class="p-3 font-semibold">${formatCurrency(order.total_amount)}</td>
                    <td class="p-3 font-bold text-red-600">${formatCurrency(order.debt_amount)}</td>
                    <td class="p-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">
                            ${order.debt_percentage.toFixed(1)}%
                        </span>
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${getDebtStatusBadgeColor(order.status)}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="p-3">
                        <div class="flex gap-2">
                            <button onclick="showOrderDetails(${order.order_id})" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="showDebtDetails(${order.order_id})" 
                                    class="text-purple-600 hover:text-purple-800 text-sm">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </button>
                            <button onclick="showPaymentModal(${order.order_id}, ${order.debt_amount})" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <tr>
                <td colspan="7" class="p-6 text-center text-gray-500">
                    <i class="fas fa-check-circle text-4xl mb-3 text-green-300"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ù‡Ø§ Ø¯ÙŠÙˆÙ†</p>
                    <p class="text-sm text-gray-400 mt-1">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø³Ù„ÙŠÙ…Ø© Ù…Ø§Ù„ÙŠØ§Ù‹</p>
                </td>
            </tr>
        `;
    }
}

function getDebtStatusColor(status) {
    switch(status) {
        case 'Ø¯ÙŠÙˆÙ† Ù‚Ù„ÙŠÙ„Ø©': return 'bg-green-100 text-green-800';
        case 'Ø¯ÙŠÙˆÙ† Ù…ØªÙˆØ³Ø·Ø©': return 'bg-yellow-100 text-yellow-800';
        case 'Ø¯ÙŠÙˆÙ† Ø¹Ø§Ù„ÙŠØ©': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getDebtStatusBadgeColor(status) {
    switch(status) {
        case 'Ø¯ÙŠÙˆÙ† Ù‚Ù„ÙŠÙ„Ø©': return 'bg-green-500 text-white';
        case 'Ø¯ÙŠÙˆÙ† Ù…ØªÙˆØ³Ø·Ø©': return 'bg-yellow-500 text-white';
        case 'Ø¯ÙŠÙˆÙ† Ø¹Ø§Ù„ÙŠØ©': return 'bg-red-500 text-white';
        default: return 'bg-gray-500 text-white';
    }
}

function showDebtDetails(orderId) {
    currentOrderId = orderId;
    showHistory(orderId);
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ†...', 'info');
}

// ======================= //
// ğŸ“‹ ORDER MANAGEMENT SYSTEM
// ======================= //

function showAddForm() {
    const modalTitle = document.getElementById('modalTitle');
    const orderForm = document.getElementById('orderForm');
    
    if (modalTitle) modalTitle.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©';
    if (orderForm) {
        orderForm.action = "{{ url_for('orders.add_order') }}";
        orderForm.reset();
    }
    
    const statusSelect = document.getElementById('order_status');
    const orderId = document.getElementById('order_id');
    
    if (statusSelect) statusSelect.value = '';
    if (orderId) orderId.value = '';
    
    showModal('orderModal');
}

function editOrder(button) {
    if (!button) return;
    
    const orderId = button.dataset.id;
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    const modalTitle = document.getElementById('modalTitle');
    const orderForm = document.getElementById('orderForm');
    
    if (modalTitle) modalTitle.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©';
    if (orderForm) orderForm.action = '/orders/edit/' + orderId;
    
    const orderIdInput = document.getElementById('order_id');
    if (orderIdInput) orderIdInput.value = orderId;
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const fields = ['name', 'wilaya', 'product', 'paid', 'total', 'note', 'status', 'phones'];
    fields.forEach(field => {
        const element = document.getElementById('order_' + field);
        if (element) {
            element.value = button.dataset[field] || '';
        }
    });

    showModal('orderModal');
}

function showOrderDetails(orderId) {
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    currentOrderId = orderId;
    const detailsOrderId = document.getElementById('detailsOrderId');
    const assignOrderId = document.getElementById('assign_order_id');
    
    if (detailsOrderId) detailsOrderId.textContent = orderId;
    if (assignOrderId) assignOrderId.value = orderId;
    
    loadOrderDetails(orderId);
    showModal('detailsModal');
}

function loadOrderDetails(orderId) {
    showMobileLoader();
    fetch(`/api/orders/${orderId}/details`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                updateDetailsUI(data);
                loadAutoPerformanceEvaluation(orderId);
                loadPostInstallationIssues(orderId);
            } else {
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading order details:', error);
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
}

function updateDetailsUI(data) {
    if (!data || !data.order) return;
    
    const detailsOrderId = document.getElementById('detailsOrderId');
    const detailsCustomerName = document.getElementById('detailsCustomerName');
    
    if (detailsOrderId) detailsOrderId.textContent = data.order.id;
    if (detailsCustomerName) detailsCustomerName.textContent = data.order.customer_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
    const fields = {
        'production_details': data.order.production_details,
        'start_date': data.order.start_date,
        'expected_delivery': data.order.expected_delivery,
        'actual_delivery': data.order.actual_delivery
    };
    
    Object.keys(fields).forEach(field => {
        const element = document.getElementById(field);
        if (element) element.value = fields[field] || '';
    });
    
    updateAssignmentsUI(data.assignments || []);
}

function updateAssignmentsUI(assignments) {
    const container = document.getElementById('currentAssignments');
    if (!container) return;
    
    if (assignments && assignments.length > 0) {
        let html = '';
        assignments.forEach(assignment => {
            const assignmentType = getAssignmentTypeText(assignment.assignment_type);
            
            html += `
                <div class="assignment-item">
                    <div class="assignment-content">
                        <div class="assignment-avatar">
                            ${assignment.worker_name?.charAt(0) || '?'}
                        </div>
                        <div class="assignment-details">
                            <div class="assignment-name">${assignment.worker_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                            <div class="assignment-meta">
                                <span class="assignment-type">${assignmentType}</span>
                                <span class="assignment-date">${assignment.assigned_date || ''}</span>
                            </div>
                            ${assignment.notes ? `<div class="assignment-notes">${assignment.notes}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="deassignWorker(${assignment.id})" class="assignment-action">
                        <i class="fas fa-user-times"></i>
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-user-clock"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹ÙŠÙŠÙ†Ø§Øª Ø­Ø§Ù„ÙŠØ©</p>
                <p class="text-xs">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© ØªØ¹ÙŠÙŠÙ† Ø¬Ø¯ÙŠØ¯</p>
            </div>
        `;
    }
}

function getAssignmentTypeText(type) {
    const types = {
        'workshop': 'ÙˆØ±Ø´Ø©',
        'travel': 'Ø³ÙØ±',
        'installation': 'ØªØ±ÙƒÙŠØ¨',
        'maintenance': 'ØµÙŠØ§Ù†Ø©'
    };
    return types[type] || type;
}

// Ø¥Ø¯Ø§Ø±Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…Ø§Ù„
document.addEventListener('DOMContentLoaded', function() {
    const assignForm = document.getElementById('assignWorkerForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            assignWorker();
        });
    }
});

function assignWorker() {
    const formData = new FormData();
    const orderId = document.getElementById('assign_order_id');
    const workerId = document.getElementById('assign_worker_id');
    const assignmentType = document.getElementById('assign_type');
    const notes = document.getElementById('assign_notes');
    
    if (!orderId || !workerId || !assignmentType) {
        showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹ÙŠÙŠÙ† ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©', 'error');
        return;
    }
    
    formData.append('order_id', orderId.value);
    formData.append('worker_id', workerId.value);
    formData.append('assignment_type', assignmentType.value);
    formData.append('notes', notes?.value || '');
    
    showMobileLoader();
    fetch('/api/orders/assign-worker', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            loadOrderDetails(currentOrderId);
            const form = document.getElementById('assignWorkerForm');
            if (form) form.reset();
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'error');
        }
    })
    .catch(error => {
        console.error('Error assigning worker:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

function deassignWorker(assignmentId) {
    if (!assignmentId) return;
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ØªØ¹ÙŠÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ')) {
        showMobileLoader();
        fetch(`/api/orders/deassign-worker/${assignmentId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
                loadOrderDetails(currentOrderId);
            } else {
                showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'error');
            }
        })
        .catch(error => {
            console.error('Error deassigning worker:', error);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
    }
}

function saveOrderDetails() {
    const formData = new FormData();
    formData.append('order_id', currentOrderId);
    
    const fields = ['production_details', 'start_date', 'expected_delivery', 'actual_delivery'];
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) formData.append(field, element.value);
    });
    
    showMobileLoader();
    fetch('/api/orders/update-details', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            hideModal('detailsModal');
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving details:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// â­ AUTO PERFORMANCE EVALUATION
// ======================= //

async function loadAutoPerformanceEvaluation(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/auto-evaluation`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateAutoPerformanceUI(data.evaluation);
        }
    } catch (error) {
        console.error('Error loading auto performance evaluation:', error);
    }
}

function updateAutoPerformanceUI(evaluation) {
    if (!evaluation) return;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    const scores = {
        'autoTimeScore': evaluation.time_score || 0,
        'autoCostScore': evaluation.cost_score || 0,
        'autoQualityScore': evaluation.quality_score || 0,
        'autoWorkerScore': evaluation.worker_score || 0
    };
    
    Object.keys(scores).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = scores[id] + '%';
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
            if (scores[id] >= 80) {
                element.className = element.className.replace(/(text-(red|yellow|orange))-600/, 'text-green-600');
            } else if (scores[id] >= 60) {
                element.className = element.className.replace(/(text-(red|green|orange))-600/, 'text-yellow-600');
            } else {
                element.className = element.className.replace(/(text-(green|yellow|orange))-600/, 'text-red-600');
            }
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    const overallScore = evaluation.overall_score || 0;
    const scoreElement = document.getElementById('overall_score');
    const progressElement = document.getElementById('score_progress');
    const summaryElement = document.getElementById('performanceSummary');
    
    if (scoreElement) scoreElement.textContent = overallScore + '%';
    if (progressElement) progressElement.style.width = overallScore + '%';
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    if (overallScore >= 80) {
        scoreElement.className = 'text-2xl font-bold text-green-600';
        progressElement.className = 'h-2 rounded-full bg-green-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² - Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØªØ³ÙŠØ± Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯';
    } else if (overallScore >= 60) {
        scoreElement.className = 'text-2xl font-bold text-yellow-600';
        progressElement.className = 'h-2 rounded-full bg-yellow-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'Ø£Ø¯Ø§Ø¡ Ù…Ù‚Ø¨ÙˆÙ„ - Ù‡Ù†Ø§Ùƒ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ†';
    } else {
        scoreElement.className = 'text-2xl font-bold text-red-600';
        progressElement.className = 'h-2 rounded-full bg-red-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'Ø£Ø¯Ø§Ø¡ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† - Ù‡Ù†Ø§Ùƒ Ù…Ø´Ø§ÙƒÙ„ ØªØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
    }
    
    // ØªØ­Ø¯ÙŠØ« ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡
    updatePerformanceInsights(evaluation.insights || []);
}

function updatePerformanceInsights(insights) {
    const container = document.getElementById('performanceInsights');
    if (!container) return;
    
    if (insights && insights.length > 0) {
        let html = '';
        insights.forEach(insight => {
            const icon = getInsightIcon(insight.type);
            const color = getInsightColor(insight.severity);
            
            html += `
                <div class="flex items-start gap-2 p-2 bg-white rounded-lg border ${color}">
                    <i class="fas fa-${icon} mt-1 text-sm"></i>
                    <div class="flex-1">
                        <div class="text-sm font-medium">${insight.title}</div>
                        <div class="text-xs text-gray-600">${insight.description}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
        `;
    }
}

function getInsightIcon(type) {
    const icons = {
        'time': 'clock',
        'cost': 'money-bill-wave',
        'quality': 'star',
        'worker': 'user',
        'material': 'box',
        'transport': 'truck'
    };
    return icons[type] || 'info-circle';
}

function getInsightColor(severity) {
    const colors = {
        'high': 'border-red-200 bg-red-50',
        'medium': 'border-yellow-200 bg-yellow-50',
        'low': 'border-green-200 bg-green-50',
        'info': 'border-blue-200 bg-blue-50'
    };
    return colors[severity] || 'border-gray-200 bg-gray-50';
}

function refreshAutoEvaluation() {
    if (!currentOrderId) return;
    
    showMobileLoader();
    fetch(`/api/orders/${currentOrderId}/refresh-evaluation`, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            loadAutoPerformanceEvaluation(currentOrderId);
        } else {
            showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
        }
    })
    .catch(error => {
        console.error('Error refreshing evaluation:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// âš ï¸ POST-INSTALLATION ISSUES SYSTEM
// ======================= //

async function loadPostInstallationIssues(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/post-installation-issues`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updatePostInstallationIssuesUI(data.issues);
            updateRootCauseAnalysis(data.analysis);
        }
    } catch (error) {
        console.error('Error loading post-installation issues:', error);
    }
}

function updatePostInstallationIssuesUI(issues) {
    const container = document.getElementById('postInstallationIssues');
    if (!container) return;
    
    if (issues && issues.length > 0) {
        let html = '';
        issues.forEach(issue => {
            const severityColor = getIssueSeverityColor(issue.severity);
            const statusIcon = issue.resolved ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            
            html += `
                <div class="issue-item p-3 bg-white rounded-lg border border-gray-200 mb-2">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-medium">${issue.type}</span>
                            <span class="text-xs ${severityColor} ml-2 px-2 py-1 rounded-full">${getSeverityText(issue.severity)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas ${statusIcon}"></i>
                            <span class="text-xs text-gray-500">${formatDate(issue.issue_date)}</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${issue.description}</div>
                    ${issue.cause ? `<div class="text-xs text-gray-500 mb-1"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${issue.cause}</div>` : ''}
                    ${issue.solution ? `<div class="text-xs text-green-600"><strong>Ø§Ù„Ø­Ù„:</strong> ${issue.solution}</div>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tools"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ Ù…Ø³Ø¬Ù„Ø©</p>
            </div>
        `;
    }
}

function updateRootCauseAnalysis(analysis) {
    const container = document.getElementById('rootCauseAnalysis');
    if (!container) return;
    
    if (analysis && analysis.issues_count > 0) {
        let html = `
            <div class="mb-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠØ©</span>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${analysis.issues_count} Ù…Ø´ÙƒÙ„Ø©</span>
                </div>
        `;
        
        if (analysis.common_causes && analysis.common_causes.length > 0) {
            html += `<div class="space-y-1">`;
            analysis.common_causes.forEach(cause => {
                html += `
                    <div class="flex items-center gap-2 text-sm">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        <span>${cause}</span>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        if (analysis.recommendations && analysis.recommendations.length > 0) {
            html += `<div class="mt-3 pt-2 border-t border-yellow-200">`;
            analysis.recommendations.forEach(rec => {
                html += `
                    <div class="flex items-center gap-2 text-sm text-green-700">
                        <i class="fas fa-lightbulb"></i>
                        <span>${rec}</span>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        html += `</div>`;
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <p class="text-sm text-yellow-800 text-center">Ø³ÙŠØ¸Ù‡Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„</p>
        `;
    }
}

function getIssueSeverityColor(severity) {
    const colors = {
        'critical': 'bg-red-100 text-red-800',
        'high': 'bg-orange-100 text-orange-800',
        'medium': 'bg-yellow-100 text-yellow-800',
        'low': 'bg-green-100 text-green-800'
    };
    return colors[severity] || 'bg-gray-100 text-gray-800';
}

function getSeverityText(severity) {
    const texts = {
        'critical': 'Ø­Ø±Ø¬Ø©',
        'high': 'Ø¹Ø§Ù„ÙŠØ©',
        'medium': 'Ù…ØªÙˆØ³Ø·Ø©',
        'low': 'Ù…Ù†Ø®ÙØ¶Ø©'
    };
    return texts[severity] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
}

function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG');
    } catch {
        return dateString;
    }
}

function showIssueReportModal() {
    if (!currentOrderId) {
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø·Ù„Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }
    
    const issueOrderId = document.getElementById('issue_order_id');
    if (issueOrderId) issueOrderId.value = currentOrderId;
    
    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
    const issueDate = document.getElementById('issue_date');
    if (issueDate) {
        const today = new Date().toISOString().split('T')[0];
        issueDate.value = today;
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const form = document.getElementById('issueReportForm');
    if (form) form.reset();
    
    showModal('issueReportModal');
}

// Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
document.addEventListener('DOMContentLoaded', function() {
    const issueForm = document.getElementById('issueReportForm');
    if (issueForm) {
        issueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitIssueReport();
        });
    }
});

function submitIssueReport() {
    const formData = new FormData();
    formData.append('order_id', currentOrderId);
    
    const fields = ['issue_type', 'issue_severity', 'issue_description', 'issue_cause', 'issue_solution', 'issue_date', 'estimated_repair_time'];
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) formData.append(field, element.value);
    });
    
    const resolved = document.querySelector('input[name="issue_resolved"]:checked');
    if (resolved) {
        formData.append('resolved', resolved.value);
    }
    
    showMobileLoader();
    fetch('/api/orders/report-issue', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­');
            hideModal('issueReportModal');
            loadPostInstallationIssues(currentOrderId);
            refreshAutoEvaluation(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
        }
    })
    .catch(error => {
        console.error('Error reporting issue:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// ğŸ’° PAYMENT MANAGEMENT
// ======================= //

function showPaymentModal(orderId, remaining) {
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    currentOrderId = orderId;
    currentRemaining = parseFloat(remaining) || 0;
    
    const paymentOrderId = document.getElementById('payment_order_id');
    const remainingAmount = document.getElementById('remainingAmount');
    const paymentAmount = document.getElementById('payment_amount');
    
    if (paymentOrderId) paymentOrderId.value = orderId;
    if (remainingAmount) remainingAmount.textContent = currentRemaining.toFixed(2);
    if (paymentAmount) {
        paymentAmount.value = '';
        paymentAmount.max = currentRemaining;
    }
    
    showModal('paymentModal');
}

// Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙØ¹
document.addEventListener('DOMContentLoaded', function() {
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitPayment();
        });
    }
});

function submitPayment() {
    const paymentAmount = document.getElementById('payment_amount');
    const amount = parseFloat(paymentAmount?.value) || 0;
    
    if (amount <= 0) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­', 'error');
        return;
    }
    
    if (amount > currentRemaining) {
        showToast('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'error');
        return;
    }
    
    const formData = new FormData(document.getElementById('paymentForm'));
    
    showMobileLoader();
    fetch(`/orders/payment/${currentOrderId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
            hideModal('paymentModal');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ
            updateOrderRow(currentOrderId, {
                new_paid: data.new_paid,
                new_remaining: data.new_remaining,
                is_paid: data.is_paid
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updateStatisticsAfterPayment(data.new_paid, data.new_remaining);
            
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
        }
    })
    .catch(error => {
        console.error('Payment error:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

function updateOrderRow(orderId, newData) {
    const row = document.querySelector(`tr[data-order-id="${orderId}"], .md\\:hidden .order-card[data-order-id="${orderId}"]`);
    
    if (row) {
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        row.classList.add('order-row-updating');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
        if (newData.new_paid !== undefined) {
            const paidElements = row.querySelectorAll('.text-green-600');
            paidElements.forEach(el => {
                if (el.textContent.includes('Ø¯Ø¬') && el.textContent.includes('Ø§Ù„Ù…Ø¯ÙÙˆØ¹')) {
                    el.innerHTML = `<span class="font-bold text-lg text-green-600">${newData.new_paid.toFixed(0)}</span><span class="text-xs text-green-600 block">Ø¯Ø¬</span>`;
                }
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
        if (newData.new_remaining !== undefined) {
            const remainingElements = row.querySelectorAll('td:nth-child(8), .bg-gray-50 .text-center:nth-child(3)');
            remainingElements.forEach(el => {
                if (el.textContent.includes('Ø¯Ø¬')) {
                    if (newData.new_remaining > 0) {
                        el.innerHTML = `<span class="font-semibold text-red-600">${newData.new_remaining.toFixed(0)} Ø¯Ø¬</span>`;
                    } else {
                        el.innerHTML = `<span class="font-semibold text-green-600">0 Ø¯Ø¬</span>`;
                    }
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            const healthStatusElements = row.querySelectorAll('td:nth-child(10), .flex-col .bg-green-100, .flex-col .bg-red-100');
            healthStatusElements.forEach(el => {
                if (newData.new_remaining <= 0) {
                    el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                        <i class="fas fa-check-circle ml-1"></i>
                        Ø³Ù„ÙŠÙ…Ø©
                    </span>`;
                    row.dataset.healthStatus = 'healthy';
                } else {
                    el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                        <i class="fas fa-exclamation-triangle ml-1"></i>
                        Ø¨Ù‡Ø§ Ø¯ÙŠÙˆÙ†
                    </span>`;
                    row.dataset.healthStatus = 'debt';
                }
            });
            
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¯ÙØ¹ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            const paymentButton = row.querySelector('.payment-btn');
            if (paymentButton && newData.new_remaining <= 0) {
                paymentButton.style.display = 'none';
            }
        }
        
        // Ø¥Ø²Ø§Ù„Ø© ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ ÙØªØ±Ø©
        setTimeout(() => {
            row.classList.remove('order-row-updating');
        }, 1000);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
        reapplyFiltersToRow(row);
    }
}

function updateStatisticsAfterPayment(newPaid, newRemaining) {
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    const paidCard = document.querySelector('.bg-gradient-to-r.from-green-500.to-green-600 .text-2xl');
    if (paidCard) {
        const currentPaid = parseFloat(paidCard.textContent.replace(' Ø¯Ø¬', '')) || 0;
        paidCard.textContent = (currentPaid + newPaid).toFixed(0) + ' Ø¯Ø¬';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    const remainingCard = document.querySelector('.bg-gradient-to-r.from-indigo-500.to-indigo-600 .text-2xl');
    if (remainingCard) {
        const currentRemaining = parseFloat(remainingCard.textContent.replace(' Ø¯Ø¬', '')) || 0;
        remainingCard.textContent = (currentRemaining - newPaid).toFixed(0) + ' Ø¯Ø¬';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
    updateOrdersHealthStats();
}

// ======================= //
// ğŸ“Š HEALTH STATISTICS
// ======================= //

function updateOrdersHealthStats() {
    const rows = document.querySelectorAll('#ordersTable tr[data-order-id], .order-card');
    let healthyCount = 0;
    let debtCount = 0;
    let totalRealDebts = 0;
    
    const processedOrders = new Set();
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const orderId = row.getAttribute('data-order-id');
            
            if (!processedOrders.has(orderId)) {
                processedOrders.add(orderId);
                
                const realDebts = parseFloat(row.getAttribute('data-real-debts')) || 0;
                const remainingAmount = parseFloat(row.getAttribute('data-remaining')) || 0;
                
                if (realDebts > 0) {
                    debtCount++;
                    totalRealDebts += realDebts;
                } else {
                    healthyCount++;
                }
            }
        }
    });
    
    document.getElementById('healthyOrdersCount').textContent = healthyCount;
    document.getElementById('ordersDebtsTotal').textContent = Math.round(totalRealDebts) + ' Ø¯Ø¬';
    document.getElementById('affectedOrdersCount').textContent = debtCount;
}

async function loadOrdersHealthStats() {
    try {
        const response = await fetch('/api/orders/health-stats');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                updateHealthStatsDisplay(data.stats);
            }
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµØ­Ø©:', error);
        updateOrdersHealthStats();
    }
}

function updateHealthStatsDisplay(stats) {
    document.getElementById('healthyOrdersCount').textContent = stats.healthy_orders;
    document.getElementById('ordersDebtsTotal').textContent = Math.round(stats.total_debts_amount) + ' Ø¯Ø¬';
    document.getElementById('affectedOrdersCount').textContent = stats.debt_orders;
    
    const modalTotalDebts = document.getElementById('modalTotalDebts');
    const modalAffectedOrders = document.getElementById('modalAffectedOrders');
    const modalAverageDebt = document.getElementById('modalAverageDebt');
    const modalDebtFreeOrders = document.getElementById('modalDebtFreeOrders');
    
    if (modalTotalDebts) modalTotalDebts.textContent = Math.round(stats.total_debts_amount) + ' Ø¯Ø¬';
    if (modalAffectedOrders) modalAffectedOrders.textContent = stats.debt_orders;
    if (modalAverageDebt) {
        const avgDebt = stats.debt_orders > 0 ? stats.total_debts_amount / stats.debt_orders : 0;
        modalAverageDebt.textContent = Math.round(avgDebt) + ' Ø¯Ø¬';
    }
    if (modalDebtFreeOrders) modalDebtFreeOrders.textContent = stats.healthy_orders;
}

// ======================= //
// ğŸ“Š HISTORY SYSTEM
// ======================= //

async function showHistory(orderId) {
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/orders/history/${orderId}`);
        if (!response.ok) throw new Error('Network error');
        
        const historyData = await response.json();
        
        console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:', historyData);
        
        const historyOrderId = document.getElementById('historyOrderId');
        if (historyOrderId) historyOrderId.textContent = orderId;
        
        if (historyData.order_info) {
            updateHistoryStatistics(historyData.order_info);
        }
        
        window.originalHistoryData = historyData.history || [];
        window.currentHistoryData = [...window.originalHistoryData];
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${window.originalHistoryData.length} Ø³Ø¬Ù„`);
        
        try {
            const debtsResponse = await fetch(`/api/orders/${orderId}/debts`);
            if (debtsResponse.ok) {
                const debtsData = await debtsResponse.json();
                
                if (debtsData.success && debtsData.debts_info.has_debts) {
                    debtsData.debts_info.debt_records.forEach(debt => {
                        const debtRecord = {
                            change_type: "Ø¯ÙŠÙ†",
                            details: `${debt.type}: ${debt.description} - Ø§Ù„Ù…Ø¨Ù„Øº: ${debt.debt_amount} Ø¯Ø¬ - Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${debt.paid_amount} Ø¯Ø¬ - Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${debt.remaining} Ø¯Ø¬`,
                            timestamp: debt.date,
                            user: "Ø§Ù„Ù†Ø¸Ø§Ù…",
                            debt_data: debt,
                            is_debt: true
                        };
                        window.originalHistoryData.push(debtRecord);
                    });
                    
                    console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${debtsData.debts_info.debt_records.length} Ø³Ø¬Ù„ Ø¯ÙŠÙˆÙ†`);
                }
            }
        } catch (debtError) {
            console.error('Error loading debts:', debtError);
        }
        
        updateUnifiedHistoryUI(window.currentHistoryData);
        setupEnhancedHistoryFilters();
        resetHistoryFilters(true);
        startDebtMonitoring(orderId);
        
        showModal('historyModal');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„', 'error');
        updateUnifiedHistoryUI([]);
    } finally {
        hideMobileLoader();
    }
}

function updateHistoryStatistics(orderInfo) {
    if (!orderInfo) return;
    
    const total = orderInfo.total_amount || 0;
    const paid = orderInfo.paid_amount || 0;
    const remaining = orderInfo.remaining_amount || 0;
    const costs = orderInfo.total_costs || 0;
    const profit = total - costs;
    const profitPercentage = total > 0 ? (profit / total) * 100 : 0;
    const costPercentage = total > 0 ? (costs / total) * 100 : 0;
    
    const elements = {
        'historyTotalAmount': total.toFixed(0) + ' Ø¯Ø¬',
        'historyPaidAmount': paid.toFixed(0) + ' Ø¯Ø¬',
        'historyRemainingAmount': remaining.toFixed(0) + ' Ø¯Ø¬',
        'historyCostAmount': costs.toFixed(0) + ' Ø¯Ø¬',
        'historyProfitAmount': profit.toFixed(0) + ' Ø¯Ø¬',
        'historyProfitPercentage': profitPercentage.toFixed(1) + '%',
        'costPercentage': costPercentage.toFixed(1) + '%',
        'profitPercentage': profitPercentage.toFixed(1) + '%'
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = elements[id];
    });
    
    const costBar = document.getElementById('costBar');
    const profitBar = document.getElementById('profitBar');
    
    if (costBar) costBar.style.width = costPercentage + '%';
    if (profitBar) {
        profitBar.style.width = profitPercentage + '%';
        profitBar.style.left = costPercentage + '%';
    }
}

// ======================= //
// ğŸ” ENHANCED HISTORY FILTERS
// ======================= //

function setupEnhancedHistoryFilters() {
    console.log('ğŸ¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø©...');
    
    const userFilter = document.getElementById('historyUserFilter');
    const typeFilter = document.getElementById('historyTypeFilter');
    const searchText = document.getElementById('historySearchText');
    const dateFrom = document.getElementById('historyDateFrom');
    const dateTo = document.getElementById('historyDateTo');
    
    [userFilter, typeFilter, searchText, dateFrom, dateTo].forEach(element => {
        if (element) {
            element.replaceWith(element.cloneNode(true));
        }
    });
    
    const newUserFilter = document.getElementById('historyUserFilter');
    const newTypeFilter = document.getElementById('historyTypeFilter');
    const newSearchText = document.getElementById('historySearchText');
    const newDateFrom = document.getElementById('historyDateFrom');
    const newDateTo = document.getElementById('historyDateTo');
    
    if (newUserFilter) {
        newUserFilter.addEventListener('change', function() {
            console.log('ğŸ‘¤ ØªØºÙŠÙŠØ± ÙÙ„ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', this.value);
            historyFiltersState.user = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newTypeFilter) {
        newTypeFilter.addEventListener('change', function() {
            console.log('ğŸ¯ ØªØºÙŠÙŠØ± ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹:', this.value);
            historyFiltersState.type = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newSearchText) {
        newSearchText.addEventListener('input', function() {
            historyFiltersState.searchText = this.value.toLowerCase().trim();
            applySmartHistoryFilters();
        });
    }
    
    if (newDateFrom) {
        newDateFrom.addEventListener('change', function() {
            historyFiltersState.dateFrom = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newDateTo) {
        newDateTo.addEventListener('change', function() {
            historyFiltersState.dateTo = this.value;
            applySmartHistoryFilters();
        });
    }
    
    loadRealUsersForFilter();
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ù†Ø¬Ø§Ø­');
}

function applySmartHistoryFilters() {
    console.log('ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±:', historyFiltersState);
    
    if (!window.originalHistoryData || window.originalHistoryData.length === 0) {
        console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ØµÙ„ÙŠØ© Ù„Ù„ØªØµÙÙŠØ©');
        return;
    }
    
    const filteredData = window.originalHistoryData.filter(item => {
        if (historyFiltersState.user && historyFiltersState.user !== '') {
            const userName = extractReliableUserName(item);
            if (userName !== historyFiltersState.user) {
                return false;
            }
        }
        
        if (historyFiltersState.type && historyFiltersState.type !== '') {
            const itemType = getSmartItemType(item);
            if (itemType !== historyFiltersState.type) {
                return false;
            }
        }
        
        if (historyFiltersState.dateFrom || historyFiltersState.dateTo) {
            const itemDate = new Date(item.timestamp);
            
            if (historyFiltersState.dateFrom) {
                const fromDate = new Date(historyFiltersState.dateFrom);
                if (itemDate < fromDate) return false;
            }
            
            if (historyFiltersState.dateTo) {
                const toDate = new Date(historyFiltersState.dateTo);
                toDate.setHours(23, 59, 59, 999);
                if (itemDate > toDate) return false;
            }
        }
        
        if (historyFiltersState.searchText && historyFiltersState.searchText.trim() !== '') {
            const searchableText = [
                item.details || '',
                item.description || '',
                item.change_type || '',
                extractReliableUserName(item)
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(historyFiltersState.searchText.toLowerCase())) {
                return false;
            }
        }
        
        return true;
    });
    
    console.log(`ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙÙ„ØªØ±Ø©: ${filteredData.length} Ù…Ù† ${window.originalHistoryData.length}`);
    
    window.currentHistoryData = filteredData;
    updateUnifiedHistoryUI(window.currentHistoryData);
    updateFilterStats(filteredData.length, window.originalHistoryData.length);
}

function getSmartItemType(item) {
    if (!item) return 'other';
    
    const changeType = (item.change_type || '').toLowerCase();
    const details = (item.details || '').toLowerCase();
    
    console.log('ğŸ” ØªØ­Ù„ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:', { changeType, details });
    
    if (changeType.includes('Ø¯ÙŠÙ†') || details.includes('Ø¯ÙŠÙ†') || item.is_debt || item.debt_data) {
        return 'Ø¯ÙŠÙˆÙ†';
    }
    else if (changeType.includes('Ù…Ø´ÙƒÙ„Ø©') || details.includes('Ù…Ø´ÙƒÙ„Ø©') || details.includes('Ø¥ØµÙ„Ø§Ø­')) {
        return 'Ù…Ø´ÙƒÙ„Ø©';
    }
    else if (changeType.includes('Ø¯ÙØ¹Ø©') || details.includes('Ø¯ÙØ¹Ø©') || details.includes('Ø¯ÙØ¹')) {
        return 'Ø¯ÙØ¹Ø©';
    }
    else if (changeType.includes('Ù…ØµØ±ÙˆÙ') || details.includes('Ù…ØµØ±ÙˆÙ') || details.includes('ØªÙƒÙ„ÙØ©')) {
        return 'Ù…ØµØ±ÙˆÙ';
    }
    else if (changeType.includes('Ù†Ù‚Ù„') || details.includes('Ù†Ù‚Ù„') || details.includes('Ø´Ø­Ù†')) {
        return 'Ù†Ù‚Ù„';
    }
    else if (changeType.includes('ØªØ¹ÙŠÙŠÙ†') || details.includes('Ø¹Ø§Ù…Ù„') || details.includes('Ø¹Ù…Ø§Ù„')) {
        return 'ØªØ¹ÙŠÙŠÙ†';
    }
    else if (changeType.includes('ØªØ¹Ø¯ÙŠÙ„') || details.includes('ØªØ¹Ø¯ÙŠÙ„') || details.includes('ØªØºÙŠÙŠØ±')) {
        return 'ØªØ¹Ø¯ÙŠÙ„';
    }
    else if (changeType.includes('Ø¥Ù†Ø´Ø§Ø¡') || details.includes('Ø¥Ù†Ø´Ø§Ø¡') || details.includes('Ø¬Ø¯ÙŠØ¯')) {
        return 'Ø¥Ù†Ø´Ø§Ø¡';
    }
    else if (changeType.includes('Ø­Ø°Ù') || details.includes('Ø­Ø°Ù') || details.includes('Ù…Ø³Ø­')) {
        return 'Ø­Ø°Ù';
    }
    else if (changeType.includes('ØªÙ‚ÙŠÙŠÙ…') || details.includes('ØªÙ‚ÙŠÙŠÙ…') || details.includes('ØªÙ‚ÙŠÙŠÙ…')) {
        return 'ØªÙ‚ÙŠÙŠÙ…';
    }
    else {
        return 'Ø£Ø®Ø±Ù‰';
    }
}

function updateFilterStats(filteredCount, totalCount) {
    const statsElement = document.getElementById('filterStats');
    if (!statsElement) return;
    
    if (filteredCount === totalCount) {
        statsElement.textContent = `Ø¹Ø±Ø¶ ${totalCount} Ø¹Ù…Ù„ÙŠØ©`;
        statsElement.className = 'text-green-600 font-medium text-xs';
    } else {
        const percentage = ((filteredCount / totalCount) * 100).toFixed(1);
        statsElement.textContent = `Ø¹Ø±Ø¶ ${filteredCount} Ù…Ù† ${totalCount} Ø¹Ù…Ù„ÙŠØ© (${percentage}%)`;
        statsElement.className = 'text-blue-600 font-medium text-xs';
    }
}

function resetHistoryFilters(silent = false) {
    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±');
    
    Object.keys(historyFiltersState).forEach(key => {
        historyFiltersState[key] = '';
    });
    
    const elements = {
        'historyUserFilter': '',
        'historyTypeFilter': '',
        'historySearchText': '',
        'historyDateFrom': '',
        'historyDateTo': ''
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = elements[id];
    });
    
    if (window.originalHistoryData) {
        window.currentHistoryData = [...window.originalHistoryData];
        updateUnifiedHistoryUI(window.currentHistoryData);
        updateFilterStats(window.currentHistoryData.length, window.originalHistoryData.length);
    }
    
    if (!silent) {
        showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'success');
    }
    
    console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
}

// ======================= //
// ğŸ¯ ENHANCED HISTORY DISPLAY
// ======================= //

function updateUnifiedHistoryUI(history) {
    const container = document.getElementById('unifiedHistoryContent');
    const statsElement = document.getElementById('historyStats');
    
    if (!container) return;
    
    const displayData = Array.isArray(history) ? history : [];
    
    if (displayData.length > 0) {
        let html = '';
        
        displayData.forEach((item, index) => {
            const userName = extractReliableUserName(item);
            const itemType = getSmartItemType(item);
            const itemIcon = getSmartHistoryIcon(item);
            const itemColor = getSmartHistoryColor(itemType);
            
            if (item.change_type === "Ø¯ÙŠÙ†" || item.is_debt || item.debt_data) {
                const debt = item.debt_data;
                const status = debt.status === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                const statusColor = debt.status === 'paid' ? 'text-green-600' : 'text-red-600';
                const statusBadge = debt.status === 'paid' ? 'badge-success' : 'badge-danger';
                
                html += `
                    <div class="history-item history-item-debt">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas fa-file-invoice-dollar ${statusColor}"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">Ø¯ÙŠÙ† ${debt.type}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">
                                    <strong>${debt.description}</strong>
                                    <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                                        <div class="text-center">
                                            <div class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº</div>
                                            <div class="font-bold text-red-600">${debt.debt_amount} Ø¯Ø¬</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-gray-600">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                                            <div class="font-bold text-green-600">${debt.paid_amount} Ø¯Ø¬</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-gray-600">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                            <div class="font-bold text-orange-600">${debt.remaining} Ø¯Ø¬</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        Ø§Ù„Ù†Ø¸Ø§Ù…
                                    </div>
                                    <span class="history-badge ${statusBadge}">
                                        ${status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } 
            else if (itemType === 'Ù…Ø´ÙƒÙ„Ø©') {
                const severity = item.severity || 'medium';
                const severityColor = getIssueSeverityColor(severity);
                const resolved = item.resolved || false;
                const statusIcon = resolved ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
                
                html += `
                    <div class="history-item history-item-issue">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">Ù…Ø´ÙƒÙ„Ø© ${item.issue_type}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">
                                    <strong>${item.issue_description}</strong>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-xs ${severityColor} px-2 py-1 rounded-full">${getSeverityText(severity)}</span>
                                        <i class="fas ${statusIcon}"></i>
                                    </div>
                                    ${item.issue_cause ? `<div class="text-xs text-gray-600 mt-1"><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${item.issue_cause}</div>` : ''}
                                    ${item.issue_solution ? `<div class="text-xs text-green-600 mt-1"><strong>Ø§Ù„Ø­Ù„:</strong> ${item.issue_solution}</div>` : ''}
                                </div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        ${userName}
                                    </div>
                                    <span class="history-badge ${resolved ? 'badge-success' : 'badge-warning'}">
                                        ${resolved ? 'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            else {
                html += `
                    <div class="history-item ${itemColor}" 
                         data-type="${itemType}" 
                         data-user="${userName}"
                         data-date="${item.timestamp}">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas ${itemIcon}"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">${getActionTitle(item)}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">${cleanDescription(item.details || item.description)}</div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        Ø¨ÙˆØ§Ø³Ø·Ø©: ${userName}
                                    </div>
                                    <span class="history-badge ${getTypeBadgeColor(itemType)}">
                                        ${getTypeArabicName(itemType)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        if (statsElement) {
            statsElement.textContent = `${displayData.length} Ø¹Ù…Ù„ÙŠØ©`;
        }
        
        if (window.originalHistoryData) {
            updateFilterStats(displayData.length, window.originalHistoryData.length);
        }
        
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>
                ${window.originalHistoryData && window.originalHistoryData.length > 0 ? 
                  '<p class="text-sm text-gray-400 mt-1">Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>' : 
                  '<p class="text-sm text-gray-400 mt-1">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>'}
            </div>
        `;
        if (statsElement) {
            statsElement.textContent = '0 Ø¹Ù…Ù„ÙŠØ©';
        }
        if (window.originalHistoryData) {
            updateFilterStats(0, window.originalHistoryData.length);
        }
    }
}

function getActionTitle(item) {
    const changeType = item.change_type || '';
    if (changeType) return changeType;
    
    const type = getSmartItemType(item);
    const typeTitles = {
        'Ø¯ÙØ¹Ø©': 'Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©',
        'Ù…ØµØ±ÙˆÙ': 'Ù…ØµØ±ÙˆÙ',
        'Ù†Ù‚Ù„': 'ØªÙƒÙ„ÙØ© Ù†Ù‚Ù„',
        'ØªØ¹ÙŠÙŠÙ†': 'ØªØ¹ÙŠÙŠÙ† Ø¹Ø§Ù…Ù„',
        'ØªØ¹Ø¯ÙŠÙ„': 'ØªØ¹Ø¯ÙŠÙ„',
        'Ø¥Ù†Ø´Ø§Ø¡': 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ©',
        'Ø­Ø°Ù': 'Ø­Ø°Ù',
        'ØªÙ‚ÙŠÙŠÙ…': 'ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡',
        'Ø¯ÙŠÙˆÙ†': 'Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ†',
        'Ù…Ø´ÙƒÙ„Ø©': 'Ù…Ø´ÙƒÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ¨'
    };
    
    return typeTitles[type] || 'Ø¹Ù…Ù„ÙŠØ©';
}

function getSmartHistoryIcon(item) {
    const type = getSmartItemType(item);
    const icons = {
        'Ø¯ÙØ¹Ø©': 'fa-money-bill-wave',
        'Ù…ØµØ±ÙˆÙ': 'fa-receipt',
        'Ù†Ù‚Ù„': 'fa-truck',
        'ØªØ¹ÙŠÙŠÙ†': 'fa-user-plus',
        'ØªØ¹Ø¯ÙŠÙ„': 'fa-edit',
        'Ø¥Ù†Ø´Ø§Ø¡': 'fa-plus-circle',
        'Ø­Ø°Ù': 'fa-trash',
        'ØªÙ‚ÙŠÙŠÙ…': 'fa-star',
        'Ø¯ÙŠÙˆÙ†': 'fa-file-invoice-dollar',
        'Ù…Ø´ÙƒÙ„Ø©': 'fa-exclamation-triangle'
    };
    return icons[type] || 'fa-history';
}

function getSmartHistoryColor(type) {
    const colors = {
        'Ø¯ÙØ¹Ø©': 'history-item-payment',
        'Ù…ØµØ±ÙˆÙ': 'history-item-expense',
        'Ù†Ù‚Ù„': 'history-item-transport',
        'ØªØ¹ÙŠÙŠÙ†': 'history-item-assignment',
        'ØªØ¹Ø¯ÙŠÙ„': 'history-item-modification',
        'Ø¥Ù†Ø´Ø§Ø¡': 'history-item-creation',
        'Ø­Ø°Ù': 'history-item-deletion',
        'ØªÙ‚ÙŠÙŠÙ…': 'history-item-evaluation',
        'Ø¯ÙŠÙˆÙ†': 'history-item-debt',
        'Ù…Ø´ÙƒÙ„Ø©': 'history-item-issue'
    };
    return colors[type] || 'history-item-modification';
}

function getTypeBadgeColor(type) {
    const colors = {
        'Ø¯ÙØ¹Ø©': 'badge-success',
        'Ù…ØµØ±ÙˆÙ': 'badge-error',
        'Ù†Ù‚Ù„': 'badge-warning',
        'ØªØ¹ÙŠÙŠÙ†': 'badge-info',
        'ØªØ¹Ø¯ÙŠÙ„': 'badge-primary',
        'Ø¥Ù†Ø´Ø§Ø¡': 'badge-success',
        'Ø­Ø°Ù': 'badge-error',
        'ØªÙ‚ÙŠÙŠÙ…': 'badge-warning',
        'Ø¯ÙŠÙˆÙ†': 'badge-danger',
        'Ù…Ø´ÙƒÙ„Ø©': 'badge-danger'
    };
    return colors[type] || 'badge-primary';
}

function getTypeArabicName(type) {
    const names = {
        'Ø¯ÙØ¹Ø©': 'Ø¯ÙØ¹Ø©',
        'Ù…ØµØ±ÙˆÙ': 'Ù…ØµØ±ÙˆÙ',
        'Ù†Ù‚Ù„': 'Ù†Ù‚Ù„',
        'ØªØ¹ÙŠÙŠÙ†': 'ØªØ¹ÙŠÙŠÙ†',
        'ØªØ¹Ø¯ÙŠÙ„': 'ØªØ¹Ø¯ÙŠÙ„',
        'Ø¥Ù†Ø´Ø§Ø¡': 'Ø¥Ù†Ø´Ø§Ø¡',
        'Ø­Ø°Ù': 'Ø­Ø°Ù',
        'ØªÙ‚ÙŠÙŠÙ…': 'ØªÙ‚ÙŠÙŠÙ…',
        'Ø¯ÙŠÙˆÙ†': 'Ø¯ÙŠÙˆÙ†',
        'Ù…Ø´ÙƒÙ„Ø©': 'Ù…Ø´ÙƒÙ„Ø©'
    };
    return names[type] || 'Ø¹Ù…Ù„ÙŠØ©';
}

function extractReliableUserName(item) {
    if (!item) return 'Ø§Ù„Ù†Ø¸Ø§Ù…';
    
    if (item.user && item.user !== 'Ø§Ù„Ù†Ø¸Ø§Ù…' && item.user !== 'undefined' && item.user !== 'null') {
        return item.user;
    }
    
    if (item.user_name && item.user_name !== 'Ø§Ù„Ù†Ø¸Ø§Ù…') {
        return item.user_name;
    }
    
    if (item.details) {
        const userMatch = item.details.match(/Ø¨ÙˆØ§Ø³Ø·Ø©[:\s]*([^.-]+)/);
        if (userMatch && userMatch[1]) {
            return userMatch[1].trim();
        }
    }
    
    return 'Ø§Ù„Ù†Ø¸Ø§Ù…';
}

function cleanDescription(description) {
    if (!description) return '';
    return description.replace(/Ø¨ÙˆØ§Ø³Ø·Ø©[^.]*\.?/g, '').trim();
}

function formatHistoryDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString;
    }
}

async function loadRealUsersForFilter() {
    try {
        const userFilter = document.getElementById('historyUserFilter');
        if (!userFilter) return;

        const allUsersOption = userFilter.querySelector('option[value=""]');
        userFilter.innerHTML = '';
        if (allUsersOption) {
            userFilter.appendChild(allUsersOption);
        } else {
            userFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>';
        }

        const historyItems = document.querySelectorAll('.history-item');
        const usersFromHistory = new Set();
        
        historyItems.forEach(item => {
            const user = item.getAttribute('data-user');
            if (user && user !== 'Ø§Ù„Ù†Ø¸Ø§Ù…' && user !== 'undefined' && user !== 'null') {
                usersFromHistory.add(user);
            }
        });

        usersFromHistory.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userFilter.appendChild(option);
        });

        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', Array.from(usersFromHistory));

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
    }
}

// ======================= //
// ğŸ“ ATTACHMENTS SYSTEM
// ======================= //

// ======================= //
// ğŸš€ INITIALIZATION
// ======================= //

function showAttachments(orderId) {
    if (!orderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    currentOrderId = orderId;
    const attachmentsOrderId = document.getElementById('attachmentsOrderId');
    if (attachmentsOrderId) attachmentsOrderId.textContent = orderId;
    
    // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    resetAttachmentModal();
    
    loadCurrentAttachments(orderId);
    loadAttachmentNotes(orderId);
    setupAttachmentsSearch();
    showModal('attachmentsModal');
}
// âœ… Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø§ÙØ°Ø©
function resetAttachmentModal() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    const searchInput = document.getElementById('attachmentsSearch');
    if (searchInput) searchInput.value = '';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ØªØ³Ù…ÙŠØ©
    const labelInput = document.getElementById('attachmentLabel');
    if (labelInput) labelInput.value = '';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    const notesInput = document.getElementById('attachmentNotes');
    if (notesInput) {
        notesInput.value = '';
        document.getElementById('notesCounter').textContent = '0/500';
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ÙØ¹
    const uploadPreview = document.getElementById('uploadPreview');
    const labelSection = document.getElementById('attachmentLabelSection');
    if (uploadPreview) uploadPreview.classList.add('hidden');
    if (labelSection) labelSection.classList.add('hidden');
    
    // Ù…Ø³Ø­ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    currentUploadedFiles = [];
    const fileInput = document.getElementById('newFileInput');
    if (fileInput) fileInput.value = '';
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
document.addEventListener('DOMContentLoaded', function() {
    setupNotesCounter();
    setupLabelCounter();
});

function loadCurrentAttachments(orderId) {
    if (!orderId) {
        console.error('âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­');
        return;
    }
    
    showMobileLoader();
    
    fetch(`/api/orders/${orderId}/attachments`)
        .then(response => {
            if (!response.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: ${response.status}`);
            return response.json();
        })
        .then(data => {
            currentAttachmentsData = data.attachments || [];
            updateAttachmentsGrid(currentAttachmentsData);
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);
            showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
}

// ======================= //
// ğŸ·ï¸ ENHANCED ATTACHMENTS MANAGEMENT SYSTEM
// ======================= //

let currentAttachmentsData = [];

function updateAttachmentsGrid(attachments) {
    const container = document.getElementById('currentAttachmentsList');
    const countElement = document.getElementById('attachmentsCount');
    
    if (!container || !countElement) return;
    
    currentAttachmentsData = attachments || [];
    
    if (currentAttachmentsData.length > 0) {
        countElement.textContent = currentAttachmentsData.length;
        
        let html = currentAttachmentsData.map(attachment => {
            const isImage = attachment.file_type === 'image';
            const isVideo = attachment.file_type === 'video';
            const isPDF = attachment.file_type === 'pdf';
            const fileSize = formatFileSize(attachment.file_size);
            
            // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ© ÙÙ‚Ø·
            const displayLabel = attachment.label || 'Ø¨Ø¯ÙˆÙ† ØªØ³Ù…ÙŠØ©';
            const hasCustomLabel = attachment.has_custom_label;
            
            return `
                <div class="attachment-card" 
                     data-label="${displayLabel}"
                     data-uploader="${attachment.captured_by}"
                     data-file-type="${attachment.file_type}">
                    
                    <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
                    <div class="attachment-preview">
                        ${isImage ? `
                            <img src="/api/attachments/${attachment.id}/view" 
                                 alt="${displayLabel}"
                                 class="attachment-thumbnail"
                                 onclick="openFullScreenViewer(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}', 'image')">
                        ` : isVideo ? `
                            <div class="attachment-video-preview" onclick="openFullScreenViewer(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}', 'video')">
                                <div class="video-thumbnail">
                                    <i class="fas fa-play-circle video-play-icon"></i>
                                    <div class="video-duration">ÙÙŠØ¯ÙŠÙˆ</div>
                                </div>
                            </div>
                        ` : isPDF ? `
                            <div class="attachment-icon pdf" onclick="openFullScreenViewer(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}', 'pdf')">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                        ` : `
                            <div class="attachment-icon file" onclick="openFullScreenViewer(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}', 'file')">
                                <i class="fas fa-file"></i>
                            </div>
                        `}
                        
                        <div class="attachment-overlay">
                            <button onclick="openFullScreenViewer(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}', '${attachment.file_type}')" 
                                    class="overlay-btn view" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="/api/attachments/${attachment.id}/download" class="overlay-btn download" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="fas fa-download"></i>
                            </a>
                            <button onclick="showEditLabelModal(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}')" class="overlay-btn edit" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ³Ù…ÙŠØ©">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAttachmentPermanently(${attachment.id})" class="overlay-btn delete" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© - Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ -->
                    <div class="attachment-info">
                        <!-- âœ… Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ© -->
                        <div class="attachment-label-container">
                            <div class="attachment-label ${hasCustomLabel ? 'has-custom-label' : 'default-label'}" 
                                 title="${displayLabel}">
                                ${displayLabel}
                                ${hasCustomLabel ? '<i class="fas fa-tag ml-1 text-xs text-blue-500"></i>' : ''}
                            </div>
                            ${hasCustomLabel ? `
                                <button onclick="showEditLabelModal(${attachment.id}, '${displayLabel.replace(/'/g, "\\'")}')" 
                                        class="edit-label-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ³Ù…ÙŠØ©">
                                    <i class="fas fa-edit text-xs"></i>
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù (Ø§Ù„Ø­Ø¬Ù… ÙÙ‚Ø·) -->
                        <div class="attachment-file-info">
                            <div class="file-type-badge">
                                <i class="fas ${getFileTypeIcon(attachment.file_type)} ml-1"></i>
                                ${getFileTypeName(attachment.file_type)}
                            </div>
                            <div class="file-size-badge">
                                ${fileSize}
                            </div>
                        </div>
                        
                        <!-- âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙØ¹ -->
                        <div class="attachment-upload-info">
                            <div class="attachment-uploader">
                                <i class="fas fa-user ml-1 text-xs text-gray-500"></i>
                                ${attachment.captured_by}
                            </div>
                            <div class="upload-date">
                                <i class="fas fa-clock ml-1 text-xs text-gray-500"></i>
                                ${formatDate(attachment.captured_at)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    } else {
        countElement.textContent = '0';
        container.innerHTML = `
            <div class="empty-attachments">
                <i class="fas fa-folder-open text-4xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø­Ø§Ù„ÙŠØ©</p>
                <p class="text-sm text-gray-400 mt-1">Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø³Ù… Ø§Ù„Ø±ÙØ¹ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰</p>
            </div>
        `;
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
function getFileTypeIcon(fileType) {
    const icons = {
        'image': 'fa-image',
        'video': 'fa-video',
        'pdf': 'fa-file-pdf',
        'document': 'fa-file-word',
        'other': 'fa-file'
    };
    return icons[fileType] || 'fa-file';
}

function getFileTypeName(fileType) {
    const names = {
        'image': 'ØµÙˆØ±Ø©',
        'video': 'ÙÙŠØ¯ÙŠÙˆ',
        'pdf': 'PDF',
        'document': 'Ù…Ø³ØªÙ†Ø¯',
        'other': 'Ù…Ù„Ù'
    };
    return names[fileType] || 'Ù…Ù„Ù';
}

// ======================= //
// ğŸ“ ENHANCED ATTACHMENT NOTES SYSTEM - FIXED
// ======================= //

async function saveAttachmentNotes() {
    const notesInput = document.getElementById('attachmentNotes');
    const notes = notesInput ? notesInput.value.trim() : '';
    
    if (!currentOrderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙØ§Ø±ØºØ©ØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø­ÙØ¸ Ø´ÙŠØ¡
    if (!notes) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø­ÙØ¸', 'info');
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch('/api/orders/save-attachment-notes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                order_id: currentOrderId,
                notes: notes 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            notesInput.value = '';
            document.getElementById('notesCounter').textContent = '0/500';
            loadAttachmentNotes(currentOrderId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'error');
        }
    } catch (error) {
        console.error('Error saving attachment notes:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'error');
    } finally {
        hideMobileLoader();
    }
}


async function loadAttachmentNotes(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/attachment-notes`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateAttachmentNotesUI(data.notes);
        } else {
            console.error('Error loading notes:', data.error);
        }
    } catch (error) {
        console.error('Error loading attachment notes:', error);
    }
}

function validateFilesBeforeUpload(files) {
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    const MAX_TOTAL_SIZE = 40 * 1024 * 1024; // 40MB
    
    let totalSize = 0;
    let invalidFiles = [];
    
    for (let file of files) {
        if (file.size > MAX_FILE_SIZE) {
            invalidFiles.push(`${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`);
        }
        totalSize += file.size;
    }
    
    if (invalidFiles.length > 0) {
        return {
            valid: false,
            error: `Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯: 10MB): ${invalidFiles.join(', ')}`
        };
    }
    
    if (totalSize > MAX_TOTAL_SIZE) {
        return {
            valid: false,
            error: `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª (${(totalSize/1024/1024).toFixed(1)}MB) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (40MB)`
        };
    }
    
    return { valid: true };
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© handleFileSelection
function handleFileSelection(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    const validation = validateFilesBeforeUpload(files);
    if (!validation.valid) {
        showToast(validation.error, 'error');
        event.target.value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        return;
    }
    
    currentUploadedFiles = files;
    showUploadPreview(files);
}
// ======================= //
// ğŸ·ï¸ EDIT ATTACHMENT LABEL SYSTEM
// ======================= //

function showEditLabelModal(attachmentId, currentLabel) {
    const modalHtml = `
        <div id="editLabelModal" class="modal active">
            <div class="modal-content modern-modal compact">
                <div class="modal-header">
                    <h3 class="text-lg font-bold text-gray-900">âœï¸ ØªØ¹Ø¯ÙŠÙ„ ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø±ÙÙ‚</h3>
                    <button type="button" onclick="hideEditLabelModal()" class="modal-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newAttachmentLabel" class="form-label">Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="text" id="newAttachmentLabel" class="form-input" 
                               value="${currentLabel.replace(/'/g, "&apos;")}" 
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©..." 
                               maxlength="100">
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</span>
                            <span id="editLabelCounter" class="text-xs text-gray-500">${currentLabel.length}/100</span>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="hideEditLabelModal()" class="btn-secondary">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="button" onclick="updateAttachmentLabel(${attachmentId})" class="btn-primary">
                        <i class="fas fa-save ml-2"></i>
                        Ø­ÙØ¸ Ø§Ù„ØªØ³Ù…ÙŠØ©
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¥Ù„Ù‰ DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø±Ù
    const labelInput = document.getElementById('newAttachmentLabel');
    const counter = document.getElementById('editLabelCounter');
    
    if (labelInput && counter) {
        labelInput.addEventListener('input', function() {
            const length = this.value.length;
            counter.textContent = `${length}/100`;
            
            if (length > 100) {
                counter.classList.add('text-red-500');
            } else {
                counter.classList.remove('text-red-500');
            }
        });
        
        labelInput.focus();
        labelInput.select();
    }
}

async function updateAttachmentLabel(attachmentId) {
    const newLabelInput = document.getElementById('newAttachmentLabel');
    const newLabel = newLabelInput ? newLabelInput.value.trim() : '';
    
    if (!newLabel) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ³Ù…ÙŠØ© Ù„Ù„Ù…Ø±ÙÙ‚', 'warning');
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/api/attachments/${attachmentId}/update-label`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ label: newLabel })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            hideEditLabelModal();
            loadCurrentAttachments(currentOrderId);
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ù…ÙŠØ©', 'error');
        }
    } catch (error) {
        console.error('Error updating attachment label:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ù…ÙŠØ©', 'error');
    } finally {
        hideMobileLoader();
    }
}

function hideEditLabelModal() {
    const modal = document.getElementById('editLabelModal');
    if (modal) {
        modal.remove();
    }
}

// ======================= //
// ğŸ“ ENHANCED ATTACHMENT NOTES SYSTEM
// ======================= //

async function loadAttachmentNotes(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/attachment-notes`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateAttachmentNotesUI(data.notes);
        }
    } catch (error) {
        console.error('Error loading attachment notes:', error);
    }
}

function updateAttachmentNotesUI(notes) {
    const container = document.getElementById('savedNotesDisplay');
    if (!container) return;
    
    if (notes && notes.length > 0) {
        let html = `
            <div class="notes-header">
                <h6 class="notes-title">
                    <i class="fas fa-sticky-note ml-1"></i>
                    Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                </h6>
                <div class="notes-header-actions">
                    <span class="notes-count">${notes.length} Ù…Ù„Ø§Ø­Ø¸Ø©</span>
                    <button onclick="showAddNoteModal()" class="notes-add-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="notes-list">
        `;
        
        notes.forEach(note => {
            html += `
                <div class="note-item" data-note-id="${note.id}">
                    <div class="note-content">
                        <p class="note-text">${note.content}</p>
                        <div class="note-meta">
                            <span class="note-author">
                                <i class="fas fa-user ml-1"></i>
                                ${note.created_by}
                            </span>
                            <span class="note-date">
                                <i class="fas fa-clock ml-1"></i>
                                ${note.created_at}
                            </span>
                        </div>
                    </div>
                    <div class="note-actions">
                        <button onclick="deleteAttachmentNote(${note.id})" class="note-delete-btn" title="Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
            <div class="notes-actions">
                <button onclick="showAddNoteModal()" class="btn-outline w-full mb-2">
                    <i class="fas fa-plus ml-2"></i>
                    Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
                ${notes.length > 1 ? `
                <button onclick="clearAllAttachmentNotes()" class="btn-secondary w-full">
                    <i class="fas fa-trash ml-2"></i>
                    Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </button>
                ` : ''}
            </div>
        `;
        
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-notes">
                <i class="fas fa-sticky-note text-gray-300 text-2xl mb-2"></i>
                <p class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
                <button onclick="showAddNoteModal()" class="btn-outline mt-3">
                    <i class="fas fa-plus ml-2"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©
                </button>
            </div>
        `;
    }
}

// ======================= //
// ğŸ› ï¸ UTILITY FUNCTIONS
// ======================= //

function getFileTypeIcon(fileType) {
    const icons = {
        'image': 'fa-image',
        'pdf': 'fa-file-pdf',
        'video': 'fa-file-video',
        'document': 'fa-file-word',
        'other': 'fa-file'
    };
    return icons[fileType] || 'fa-file';
}

function getFileTypeName(fileType) {
    const names = {
        'image': 'ØµÙˆØ±Ø©',
        'pdf': 'PDF',
        'video': 'ÙÙŠØ¯ÙŠÙˆ',
        'document': 'Ù…Ø³ØªÙ†Ø¯',
        'other': 'Ù…Ù„Ù'
    };
    return names[fileType] || 'Ù…Ù„Ù';
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
function filterAttachments(searchTerm) {
    const attachmentCards = document.querySelectorAll('.attachment-card');
    let visibleCount = 0;
    
    attachmentCards.forEach(card => {
        const label = card.getAttribute('data-label') || '';
        const uploader = card.getAttribute('data-uploader') || '';
        
        const searchableText = (label + ' ' + uploader).toLowerCase();
        
        if (searchableText.includes(searchTerm) || searchTerm === '') {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    const countElement = document.getElementById('attachmentsCount');
    if (countElement && searchTerm) {
        countElement.textContent = `${visibleCount} Ù…Ù† ${currentAttachmentsData.length}`;
    } else if (countElement) {
        countElement.textContent = currentAttachmentsData.length;
    }
}
function showAddNoteModal() {
    const modalHtml = `
        <div id="addNoteModal" class="modal active">
            <div class="modal-content modern-modal compact">
                <div class="modal-header">
                    <h3 class="text-lg font-bold text-gray-900">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <button type="button" onclick="hideAddNoteModal()" class="modal-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newNoteContent" class="form-label">Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                        <textarea id="newNoteContent" rows="4" class="form-textarea" 
                                  placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..." maxlength="500"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ³Ø§Ø¹Ø¯ ÙÙŠ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„</span>
                            <span id="newNoteCounter" class="text-xs text-gray-500">0/500</span>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="hideAddNoteModal()" class="btn-secondary">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="button" onclick="saveNewAttachmentNote()" class="btn-primary">
                        <i class="fas fa-save ml-2"></i>
                        Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø±Ù
    setupNoteCounter('newNoteContent', 'newNoteCounter');
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ
    const noteInput = document.getElementById('newNoteContent');
    if (noteInput) noteInput.focus();
}
// âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø±Ù
function setupNoteCounter(textareaId, counterId) {
    const textarea = document.getElementById(textareaId);
    const counter = document.getElementById(counterId);
    
    if (textarea && counter) {
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            counter.textContent = `${length}/500`;
            
            if (length > 500) {
                counter.classList.add('text-red-500');
            } else {
                counter.classList.remove('text-red-500');
            }
        });
    }
}

// âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
async function saveNewAttachmentNote() {
    const noteInput = document.getElementById('newNoteContent');
    const noteContent = noteInput ? noteInput.value.trim() : '';
    
    if (!noteContent) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'warning');
        return;
    }
    
    if (!currentOrderId) {
        showToast('Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/api/orders/${currentOrderId}/attachment-notes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ note: noteContent })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
            hideAddNoteModal();
            loadAttachmentNotes(currentOrderId);
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
        }
    } catch (error) {
        console.error('Error saving new note:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
    } finally {
        hideMobileLoader();
    }
}

function hideAddNoteModal() {
    const modal = document.getElementById('addNoteModal');
    if (modal) {
        modal.remove();
    }
}

async function deleteAttachmentNote(noteId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) return;
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/api/orders/${currentOrderId}/attachment-notes`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ note_id: noteId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
            loadAttachmentNotes(currentOrderId);
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
        }
    } catch (error) {
        console.error('Error deleting attachment note:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', 'error');
    } finally {
        hideMobileLoader();
    }
}

async function clearAllAttachmentNotes() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) return;
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/api/orders/${currentOrderId}/attachment-notes`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            loadAttachmentNotes(currentOrderId);
        } else {
            showToast(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'error');
        }
    } catch (error) {
        console.error('Error clearing attachment notes:', error);
        showToast('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'error');
    } finally {
        hideMobileLoader();
    }
}


function openFullScreenViewer(attachmentId, label, fileType = 'image') {
    const viewerHtml = `
        <div id="fullScreenViewer" class="full-screen-viewer active">
            <div class="viewer-header">
                <h3 class="viewer-title">${label}</h3>
                <button onclick="closeFullScreenViewer()" class="viewer-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="viewer-content">
                ${fileType === 'video' ? `
                    <video controls autoplay class="viewer-video">
                        <source src="/api/attachments/${attachmentId}/view-video" type="video/mp4">
                        Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    </video>
                ` : `
                    <img src="/api/attachments/${attachmentId}/view" 
                         alt="${label}"
                         class="viewer-image"
                         onclick="closeFullScreenViewer()">
                `}
            </div>
            <div class="viewer-footer">
                <button onclick="closeFullScreenViewer()" class="btn-primary">
                    <i class="fas fa-times ml-2"></i>
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
                <a href="/api/attachments/${attachmentId}/download" class="btn-success">
                    <i class="fas fa-download ml-2"></i>
                    ØªØ­Ù…ÙŠÙ„
                </a>
                ${fileType === 'video' ? `
                    <button onclick="toggleVideoFullscreen()" class="btn-info">
                        <i class="fas fa-expand ml-2"></i>
                        Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
                    </button>
                ` : ''}
            </div>
        </div>
    `;
    
    const viewerElement = document.createElement('div');
    viewerElement.innerHTML = viewerHtml;
    document.body.appendChild(viewerElement);
    
    document.body.style.overflow = 'hidden';
}

function toggleVideoFullscreen() {
    const video = document.querySelector('.viewer-video');
    if (!video) return;
    
    if (!document.fullscreenElement) {
        if (video.requestFullscreen) {
            video.requestFullscreen();
        } else if (video.webkitRequestFullscreen) {
            video.webkitRequestFullscreen();
        } else if (video.msRequestFullscreen) {
            video.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function closeFullScreenViewer() {
    const viewer = document.getElementById('fullScreenViewer');
    if (viewer) {
        viewer.remove();
    }
    document.body.style.overflow = 'auto';
}

// ======================= //
// ğŸ“¤ ATTACHMENTS UPLOAD SYSTEM
// ======================= //

function handleFileSelection(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    currentUploadedFiles = files;
    showUploadPreview(files);
}

function showUploadPreview(files) {
    const previewContainer = document.getElementById('previewContainer');
    const uploadPreviewSection = document.getElementById('uploadPreview');
    const filesCount = document.getElementById('filesCount');
    const labelSection = document.getElementById('attachmentLabelSection');
    
    if (!previewContainer || !uploadPreviewSection || !filesCount) return;
    
    let html = '';
    
    files.forEach((file, index) => {
        const fileType = file.type.split('/')[0];
        const isImage = fileType === 'image';
        const isPDF = file.type === 'application/pdf';
        const isVideo = fileType === 'video';
        const fileSize = formatFileSize(file.size);
        
        html += `
            <div class="preview-card-compact" data-file-index="${index}">
                <div class="preview-header-compact">
                    <div class="preview-icon-compact">
                        ${isImage ? `
                            <div class="image-preview-compact">
                                <img src="${URL.createObjectURL(file)}" 
                                     alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" 
                                     class="preview-thumbnail-compact"
                                     onload="safeRevokeObjectURL(this.src)">
                            </div>
                        ` : isPDF ? `
                            <div class="file-icon-compact pdf">
                                <i class="fas fa-file-pdf text-red-500"></i>
                            </div>
                        ` : isVideo ? `
                            <div class="file-icon-compact video">
                                <i class="fas fa-file-video text-purple-500"></i>
                            </div>
                        ` : `
                            <div class="file-icon-compact file">
                                <i class="fas fa-file text-gray-500"></i>
                            </div>
                        `}
                    </div>
                    <button onclick="removeFileFromUpload(${index})" 
                            class="preview-remove-btn-compact" 
                            title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                <div class="preview-body-compact">
                    <div class="preview-filename-compact" title="${file.name}">
                        ${truncateFilename(file.name, 15)}
                    </div>
                    <div class="preview-meta-compact">
                        <span class="preview-size-compact">${fileSize}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    previewContainer.innerHTML = html;
    filesCount.textContent = files.length;
    uploadPreviewSection.classList.remove('hidden');
    
    if (labelSection) {
        labelSection.classList.remove('hidden');
        
        const labelInput = document.getElementById('attachmentLabel');
        if (labelInput && files.length > 0) {
            const defaultLabel = files[0].name.split('.')[0];
            labelInput.value = defaultLabel;
            labelInput.focus();
        }
    }
}

// ======================= //
// ğŸš€ UPLOAD ENHANCEMENTS
// ======================= //

async function uploadSelectedFiles() {
    console.log('=== ğŸš€ Ø¨Ø¯Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ===');
    
    const labelInput = document.getElementById('attachmentLabel');
    const notesInput = document.getElementById('attachmentNotes');
    const label = labelInput ? labelInput.value.trim() : '';
    const notes = notesInput ? notesInput.value.trim() : '';
    
    console.log('ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', { 
        orderId: currentOrderId, 
        label, 
        notes, 
        filesCount: currentUploadedFiles.length 
    });
    
    if (currentUploadedFiles.length === 0) {
        showToast('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª Ù„Ù„Ø±ÙØ¹', 'error');
        return;
    }
    
    if (!currentOrderId) {
        showToast('âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
        return;
    }
    
    showMobileLoader();
    
    try {
        const formData = new FormData();
        formData.append('order_id', currentOrderId);
        formData.append('label', label);
        formData.append('notes', notes); // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        
        currentUploadedFiles.forEach(file => {
            formData.append('attachments', file);
        });
        
        const response = await fetch('/api/orders/upload-attachments-real', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­:', data);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (labelInput) labelInput.value = '';
            if (notesInput) notesInput.value = '';
            
            const notesCounter = document.getElementById('notesCounter');
            if (notesCounter) notesCounter.textContent = '0/500';
            
            const uploadPreview = document.getElementById('uploadPreview');
            const labelSection = document.getElementById('attachmentLabelSection');
            if (uploadPreview) uploadPreview.classList.add('hidden');
            if (labelSection) labelSection.classList.add('hidden');
            
            const fileInput = document.getElementById('newFileInput');
            if (fileInput) fileInput.value = '';
            currentUploadedFiles = [];
            
            const successMessage = label ? 
                `âœ… ØªÙ… Ø±ÙØ¹ "${label}" Ø¨Ù†Ø¬Ø§Ø­` : 
                `âœ… ØªÙ… Ø±ÙØ¹ ${data.files?.length || 0} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`;
            
            showToast(successMessage);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            setTimeout(() => {
                loadCurrentAttachments(currentOrderId);
                loadAttachmentNotes(currentOrderId);
            }, 500);
            
        } else {
            throw new Error(data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø±ÙØ¹');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:', error);
        showToast(`âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª: ${error.message}`, 'error');
        
        showUploadPreview(currentUploadedFiles);
    } finally {
        hideMobileLoader();
    }
}

function clearUploadSelection() {
    currentUploadedFiles = [];
    
    const uploadPreview = document.getElementById('uploadPreview');
    const labelSection = document.getElementById('attachmentLabelSection');
    const fileInput = document.getElementById('newFileInput');
    const labelInput = document.getElementById('attachmentLabel');
    const notesInput = document.getElementById('attachmentNotes');
    
    if (uploadPreview) uploadPreview.classList.add('hidden');
    if (labelSection) labelSection.classList.add('hidden');
    if (fileInput) fileInput.value = '';
    if (labelInput) labelInput.value = '';
    
    if (notesInput) {
        notesInput.value = '';
        document.getElementById('notesCounter').textContent = '0/500';
    }
    
    showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª', 'info');
}

function removeFileFromUpload(index) {
    if (currentUploadedFiles.length > index) {
        currentUploadedFiles.splice(index, 1);
        if (currentUploadedFiles.length > 0) {
            showUploadPreview(currentUploadedFiles);
        } else {
            const uploadPreview = document.getElementById('uploadPreview');
            if (uploadPreview) uploadPreview.classList.add('hidden');
        }
    }
}

// ======================= //
// ğŸ—‘ï¸ ATTACHMENT DELETION
// ======================= //

async function deleteAttachmentPermanently(attachmentId) {
    if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/api/attachments/${attachmentId}/delete`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            loadCurrentAttachments(currentOrderId);
        } else {
            throw new Error(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚:', error);
        showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚', 'error');
    } finally {
        hideMobileLoader();
    }
}
// ======================= //
// ğŸ” ATTACHMENTS SEARCH
// ======================= //

function setupAttachmentsSearch() {
    const searchInput = document.getElementById('attachmentsSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterAttachments(this.value.toLowerCase());
        });
    }
}

function filterAttachments(searchTerm) {
    const attachmentCards = document.querySelectorAll('.attachment-card');
    let visibleCount = 0;
    
    attachmentCards.forEach(card => {
        const label = card.getAttribute('data-label') || '';
        const filename = card.getAttribute('data-filename') || '';
        const uploader = card.getAttribute('data-uploader') || '';
        
        const searchableText = (label + ' ' + filename + ' ' + uploader).toLowerCase();
        
        if (searchableText.includes(searchTerm) || searchTerm === '') {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    const countElement = document.getElementById('attachmentsCount');
    if (countElement && searchTerm) {
        countElement.textContent = `${visibleCount} Ù…Ù† ${currentAttachmentsData.length}`;
    } else if (countElement) {
        countElement.textContent = currentAttachmentsData.length;
    }
}


async function logAttachmentActivity(activityData) {
    try {
        const response = await fetch('/api/orders/log-attachment-activity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ...activityData,
                timestamp: new Date().toISOString(),
                user: getCurrentUserName()
            })
        });
        
        if (response.ok) {
            console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø¬Ù„:', activityData);
        } else {
            console.warn('âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø¬Ù„');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:', error);
    }
}

function getCurrentUserName() {
    return 'Ø§Ù„Ù†Ø¸Ø§Ù…';
}

// ======================= //
// ğŸ“ PHONE MANAGEMENT
// ======================= //

function togglePhoneOptions(phoneNumber) {
    if (!phoneNumber) return;
    
    const menuId = `phoneOptions-${phoneNumber.replace(/\+/g, '').replace(/ /g, '')}`;
    const menu = document.getElementById(menuId);
    
    document.querySelectorAll('.phone-options-popup').forEach(popup => {
        if (popup.id !== menuId) {
            popup.classList.add('hidden');
        }
    });
    
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function copyPhoneNumber(phoneNumber) {
    if (!phoneNumber) return;
    
    navigator.clipboard.writeText(phoneNumber).then(() => {
        showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…: ' + phoneNumber);
        document.querySelectorAll('.phone-options-popup').forEach(menu => {
            menu.classList.add('hidden');
        });
        hideModal('mobilePhoneModal');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('âŒ ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…', 'error');
    });
}

// ======================= //
// ğŸ› ï¸ UTILITY FUNCTIONS
// ======================= //

function getFileIcon(fileType) {
    const icons = {
        'image': 'file-image',
        'video': 'file-video',
        'pdf': 'file-pdf',
        'document': 'file-word'
    };
    return icons[fileType] || 'file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function truncateFilename(filename, maxLength) {
    if (filename.length <= maxLength) return filename;
    const extension = filename.split('.').pop();
    const nameWithoutExt = filename.substring(0, filename.length - extension.length - 1);
    return nameWithoutExt.substring(0, maxLength - 3) + '...' + extension;
}

function reapplyFiltersToRow(row) {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØµÙ
    performSmartSearch();
}

function startDebtMonitoring(orderId) {
    // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¯ÙŠÙˆÙ†
    if (debtMonitoringInterval) {
        clearInterval(debtMonitoringInterval);
    }
    
    debtMonitoringInterval = setInterval(() => {
        updateDebtCard(orderId);
    }, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
}

function updateDebtCard(orderId) {
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†
    const debtCard = document.getElementById('orderDebtCard');
    if (debtCard) {
        debtCard.classList.add('updating');
        setTimeout(() => {
            debtCard.classList.remove('updating');
        }, 1000);
    }
}

function showAddStatusModal() {
    showToast('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø©...', 'info');
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ù†Ø§
}

// ======================= //
// ğŸš€ INITIALIZATION
// ======================= //

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª...');
    
    setupSearchAndFilters();
    setupCostsAutoRefresh();
    initScrollToTop();
    
    loadTotalCosts();
    loadOrdersHealthStats();
    
    setupFormListeners();
    
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­');
});

function setupFormListeners() {
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            const name = document.getElementById('order_name').value.trim();
            const wilaya = document.getElementById('order_wilaya').value.trim();
            const product = document.getElementById('order_product').value.trim();
            const total = parseFloat(document.getElementById('order_total').value) || 0;
            
            if (!name) {
                e.preventDefault();
                showToast('âŒ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨', 'error');
                document.getElementById('order_name').focus();
                return;
            }
            
            if (!wilaya) {
                e.preventDefault();
                showToast('âŒ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                document.getElementById('order_wilaya').focus();
                return;
            }
            
            if (!product) {
                e.preventDefault();
                showToast('âŒ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨', 'error');
                document.getElementById('order_product').focus();
                return;
            }
            
            if (total <= 0) {
                e.preventDefault();
                showToast('âŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±', 'error');
                document.getElementById('order_total').focus();
                return;
            }
            
            console.log('âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ø¬Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        });
    }
}

function setupCostsAutoRefresh() {
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', function() {
            setTimeout(loadTotalCosts, 1000);
        });
    }
    
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function() {
            setTimeout(loadTotalCosts, 1000);
        });
    }
    
    setInterval(loadTotalCosts, 30000);
}
</script>