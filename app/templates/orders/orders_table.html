<!-- ======================= -->
<!-- ğŸ“‹ ORDERS TABLE -->
<!-- ======================= -->
<div class="bg-white rounded-2xl shadow-md overflow-hidden">
    <!-- Desktop Table -->
    <div class="hidden md:block overflow-x-auto">
      <table class="w-full text-sm text-right">
        <thead class="bg-gray-100 border-b">
          <tr class="text-gray-700 font-medium">
            <th class="p-3">#</th>
            <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
            <th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th class="p-3">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th>
            <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th class="p-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th class="p-3">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="p-3">Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th>
            <th class="p-3">Ø§Ù„Ø¹Ù…Ø§Ù„</th>
            <th class="p-3">Ø§Ù„Ø±Ø¨Ø­ÙŠØ©</th>
            <th class="p-3">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
          </tr>
        </thead>
        <tbody id="ordersTable">
          {% for o in orders %}
          <tr class="border-b hover:bg-gray-50 transition" 
              data-order-id="{{ o.id }}"
              data-status="{{ o.status.name if o.status else '' }}"
              data-worker-ids="{{ o.assigned_workers|map(attribute='id')|join(',') }}"
              data-health-status="{{ 'healthy' if o.total_related_debts == 0 else 'debt' }}"
              data-search-index="{{ o.name.lower() }} {{ o.wilaya.lower() }} {{ o.product.lower() }} {{ o.phones[0].number if o.phones else '' }}">
            <td class="p-3 text-gray-700">{{ o.id }}</td>
            <td class="p-3 font-medium text-gray-900">{{ o.name }}</td>

            <!-- Phone Cell -->
            <td class="p-3">
              {% if o.phones and o.phones|length > 0 %}
                {% set phone = o.phones[0] %}
                <div class="phone-display-container">
                  <div class="phone-number-display cursor-pointer" onclick="togglePhoneOptions('{{ phone.number }}')" role="button" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ">
                    {{ phone.number }}
                    <i class="fas fa-chevron-down ml-1 text-xs"></i>
                  </div>
                  
                  <div id="phoneOptions-{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                       class="phone-options-popup hidden">
                    <div class="flex gap-2 p-2 bg-white rounded-lg shadow-lg border">
                      <a href="tel:{{ phone.number }}" class="phone-btn bg-green-500 text-white" aria-label="Ø§ØªØµØ§Ù„">
                        <i class="fas fa-phone"></i>
                      </a>
                      <a href="https://wa.me/{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                         target="_blank" class="phone-btn bg-green-600 text-white" aria-label="ÙˆØ§ØªØ³Ø§Ø¨">
                        <i class="fab fa-whatsapp"></i>
                      </a>
                      <button onclick="copyPhoneNumber('{{ phone.number }}')" 
                              class="phone-btn bg-blue-500 text-white" aria-label="Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% else %}
                <span class="text-gray-400 text-xs">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
              {% endif %}
            </td>

            <td class="p-3 text-gray-700">{{ o.wilaya }}</td>
            <td class="p-3 text-gray-700">{{ o.product }}</td>
            
            <!-- Total Amount -->
            <td class="p-3">
              <div class="text-right">
                <span class="font-bold text-lg text-purple-700">{{ "%.0f"|format(o.total) }}</span>
                <span class="text-xs text-purple-600 block">Ø¯Ø¬</span>
              </div>
            </td>
            
            <!-- Paid Amount -->
            <td class="p-3">
              <div class="text-right">
                <span class="font-bold text-lg text-green-600">{{ "%.0f"|format(o.paid) }}</span>
                <span class="text-xs text-green-600 block">Ø¯Ø¬</span>
              </div>
            </td>

            <td class="p-3 {% if o.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %} font-semibold">
              {{ "%.0f"|format(o.remaining) }} Ø¯Ø¬
            </td>

            <!-- Status -->
            <td class="p-3">
              {% if o.status %}
                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold"
                      style="background: {{ o.status.color }}22; color: {{ o.status.color }}">
                  {{ o.status.name }}
                </span>
              {% else %}
                <span class="inline-block px-3 py-1 rounded-full text-xs bg-gray-100 text-gray-700">Ø¨Ø¯ÙˆÙ† Ø­Ø§Ù„Ø©</span>
              {% endif %}
            </td>

            <!-- Health Status - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<td class="p-3">
    {% if o.total_related_debts == 0 %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
            <i class="fas fa-check-circle ml-1"></i>
            Ø³Ù„ÙŠÙ…Ø©
        </span>
    {% else %}
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
            <i class="fas fa-exclamation-triangle ml-1"></i>
            Ø¨Ù‡Ø§ Ø¯ÙŠÙˆÙ† ({{ "%.0f"|format(o.total_related_debts) }} Ø¯Ø¬)
        </span>
    {% endif %}
</td>

            <!-- Workers -->
            <td class="p-3">
              {% if o.assigned_workers %}
                <div class="flex flex-wrap gap-1">
                  {% for worker in o.assigned_workers %}
                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full" 
                          data-worker-id="{{ worker.id }}">
                      {{ worker.name }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-gray-400 text-xs">ØºÙŠØ± Ù…Ø¹ÙŠÙ†</span>
              {% endif %}
            </td>

            <!-- Profitability -->
            <td class="p-3">
              {% set profit_info = calculate_order_profitability(o.id) if calculate_order_profitability %}
              {% if profit_info %}
                <div class="flex items-center gap-2">
                  <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-{{ 'green' if profit_info.is_profitable else 'red' }}-500 h-2 rounded-full" 
                         style="width: {{ profit_info.profit_percentage|abs|int }}%"></div>
                  </div>
                  <span class="text-xs {{ 'text-green-600' if profit_info.is_profitable else 'text-red-600' }}">
                    {{ "%.1f"|format(profit_info.profit_percentage) }}%
                  </span>
                </div>
              {% else %}
                <span class="text-gray-400 text-sm">-</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td class="p-3">
              <div class="flex gap-2 flex-wrap">
                <!-- Details Button -->
                <button class="details-btn text-purple-600 hover:text-purple-800 p-2 rounded-lg hover:bg-purple-50 transition-colors" 
                        title="ØªÙØ§ØµÙŠÙ„ ÙˆØªØ¹ÙŠÙŠÙ†"
                        data-id="{{ o.id }}"
                        onclick="showOrderDetails({{ o.id }})"
                        aria-label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©">
                  <i class="fa-solid fa-list text-lg"></i>
                </button>

                <!-- Edit Button -->
                <button class="edit-btn text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors" 
                        title="ØªØ¹Ø¯ÙŠÙ„"
                        data-id="{{ o.id }}"
                        data-name="{{ o.name }}"
                        data-wilaya="{{ o.wilaya }}"
                        data-product="{{ o.product }}"
                        data-paid="{{ '%.0f'|format(o.paid) }}"
                        data-total="{{ '%.0f'|format(o.total) }}"
                        data-note="{{ o.note }}"
                        data-phones="{{ o.phones[0].number if o.phones else '' }}"
                        data-status="{{ o.status.id if o.status else '' }}"
                        onclick="editOrder(this)"
                        aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©">
                  <i class="fa-solid fa-pen-to-square text-lg"></i>
                </button>

                <!-- History Button -->
                <button class="history-btn text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-50 transition-colors" 
                        title="Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª" 
                        data-id="{{ o.id }}"
                        onclick="showHistory({{ o.id }})"
                        aria-label="Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©">
                  <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                </button>
                
                <!-- Attachments Button -->
                <button class="attachments-btn text-purple-600 hover:text-purple-800 p-2 rounded-lg hover:bg-purple-50 transition-colors" 
                        title="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª"
                        data-id="{{ o.id }}"
                        onclick="showAttachments({{ o.id }})"
                        aria-label="Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©">
                  <i class="fa-solid fa-paperclip text-lg"></i>
                </button>

                <!-- Payment Button -->
                {% if o.remaining > 0 %}
                <button class="payment-btn text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors" 
                        title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©" 
                        data-id="{{ o.id }}" 
                        data-remaining="{{ o.remaining }}"
                        onclick="showPaymentModal({{ o.id }}, {{ o.remaining }})"
                        aria-label="Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©">
                  <i class="fa-solid fa-money-bill-wave text-lg"></i>
                </button>
                {% endif %}

                <!-- Delete Button -->
                <a href="{{ url_for('orders.delete_order', id=o.id) }}"
                   class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors inline-block"
                   title="Ø­Ø°Ù"
                   onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŸ');"
                   aria-label="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ÙŠØ©">
                  <i class="fa-solid fa-trash text-lg"></i>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="13" class="p-6 text-center text-gray-500">
              <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
              <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ø¹Ø¯</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile Cards -->
    <div class="block md:hidden space-y-3 p-3">
      {% for o in orders %}
      <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 order-card" 
           data-order-id="{{ o.id }}"
           data-status="{{ o.status.name if o.status else '' }}"
           data-worker-ids="{{ o.assigned_workers|map(attribute='id')|join(',') }}"
           data-health-status="{{ 'healthy' if o.total_related_debts == 0 else 'debt' }}"
           data-search-index="{{ o.name.lower() }} {{ o.wilaya.lower() }} {{ o.product.lower() }} {{ o.phones[0].number if o.phones else '' }}">
        
        <!-- Header -->
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1">
            <h3 class="font-bold text-gray-900 text-base">#{{ o.id }} - {{ o.name }}</h3>
            <p class="text-sm text-gray-600 truncate">{{ o.product }}</p>
          </div>
          <div class="flex flex-col items-end gap-1 ml-2">
            {% if o.status %}
            <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold"
                  style="background: {{ o.status.color }}22; color: {{ o.status.color }}">
              {{ o.status.name }}
            </span>
            {% endif %}
            <!-- Health Status Badge - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
{% if o.total_related_debts == 0 %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 mt-1">
    <i class="fas fa-check-circle ml-1"></i>
    Ø³Ù„ÙŠÙ…Ø©
</span>
{% else %}
<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 mt-1">
    <i class="fas fa-exclamation-triangle ml-1"></i>
    Ø¨Ù‡Ø§ Ø¯ÙŠÙˆÙ† ({{ "%.0f"|format(o.total_related_debts) }} Ø¯Ø¬)
</span>
{% endif %}
          </div>
        </div>

        <!-- Details -->
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <p class="text-xs text-gray-500">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</p>
            <p class="text-sm font-medium truncate">{{ o.wilaya }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">Ø§Ù„Ù‡Ø§ØªÙ</p>
            {% if o.phones and o.phones|length > 0 %}
            <div class="flex items-center gap-1">
              <p class="text-sm font-medium truncate">{{ o.phones[0].number }}</p>
              <button onclick="toggleMobilePhoneOptions('{{ o.phones[0].number }}', {{ o.id }})" 
                      class="text-blue-500 text-xs p-1">
                <i class="fas fa-ellipsis-h"></i>
              </button>
            </div>
            {% else %}
            <p class="text-sm text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>
            {% endif %}
          </div>
        </div>

        <!-- Financial -->
        <div class="grid grid-cols-3 gap-2 mb-3 p-3 bg-gray-50 rounded-lg">
          <div class="text-center">
            <p class="text-xs text-gray-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
            <p class="text-sm font-bold text-purple-700">{{ "%.0f"|format(o.total) }} Ø¯Ø¬</p>
          </div>
          <div class="text-center">
            <p class="text-xs text-gray-500">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
            <p class="text-sm font-bold text-green-600">{{ "%.0f"|format(o.paid) }} Ø¯Ø¬</p>
          </div>
          <div class="text-center">
            <p class="text-xs text-gray-500">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
            <p class="text-sm font-bold {% if o.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %}">
              {{ "%.0f"|format(o.remaining) }} Ø¯Ø¬
            </p>
          </div>
        </div>

        <!-- Workers -->
        <div class="mb-3">
          <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¹ÙŠÙ†ÙŠÙ†</p>
          {% if o.assigned_workers %}
          <div class="flex flex-wrap gap-1">
            {% for worker in o.assigned_workers %}
            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full truncate max-w-[120px]">
              {{ worker.name }}
            </span>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-sm text-gray-400">ØºÙŠØ± Ù…Ø¹ÙŠÙ†</p>
          {% endif %}
        </div>

        <!-- Profitability -->
        <div class="mb-4">
          <p class="text-xs text-gray-500 mb-1">Ø§Ù„Ø±Ø¨Ø­ÙŠØ©</p>
          {% set profit_info = calculate_order_profitability(o.id) if calculate_order_profitability %}
          {% if profit_info %}
          <div class="flex items-center gap-2">
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-{{ 'green' if profit_info.is_profitable else 'red' }}-500 h-2 rounded-full" 
                   style="width: {{ profit_info.profit_percentage|abs|int }}%"></div>
            </div>
            <span class="text-xs {{ 'text-green-600' if profit_info.is_profitable else 'text-red-600' }} min-w-[40px] text-left">
              {{ "%.1f"|format(profit_info.profit_percentage) }}%
            </span>
          </div>
          {% else %}
          <p class="text-sm text-gray-400">-</p>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center border-t pt-3">
          <div class="flex gap-1">
            <button onclick="showOrderDetails({{ o.id }})" 
                    class="text-purple-600 p-2 rounded-lg hover:bg-purple-50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                    title="ØªÙØ§ØµÙŠÙ„">
              <i class="fa-solid fa-list"></i>
            </button>
            <button onclick="editMobileOrder({{ o.id }})" 
                    class="text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                    title="ØªØ¹Ø¯ÙŠÙ„">
              <i class="fa-solid fa-pen-to-square"></i>
            </button>
            <button onclick="showHistory({{ o.id }})" 
                    class="text-gray-600 p-2 rounded-lg hover:bg-gray-50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                    title="Ø§Ù„Ø³Ø¬Ù„">
              <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
          </div>
          <div class="flex gap-1">
            {% if o.remaining > 0 %}
            <button onclick="showPaymentModal({{ o.id }}, {{ o.remaining }})" 
                    class="text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
                    title="Ø¯ÙØ¹Ø©">
              <i class="fa-solid fa-money-bill-wave"></i>
            </button>
            {% endif %}
            <a href="{{ url_for('orders.delete_order', id=o.id) }}"
               class="text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center"
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŸ');"
               title="Ø­Ø°Ù">
              <i class="fa-solid fa-trash"></i>
            </a>
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ø¹Ø¯</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¬ÙˆØ§Ù„
function initializeMobileTable() {
    // ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    const orderCards = document.querySelectorAll('.order-card');
    
    orderCards.forEach(card => {
        card.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        
        card.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const buttons = document.querySelectorAll('.order-card button, .order-card a');
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.opacity = '0.7';
        });
        
        button.addEventListener('touchend', function() {
            this.style.opacity = '1';
        });
    });
}

// ØªÙ‡ÙŠØ¦Ø© ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
document.addEventListener('DOMContentLoaded', function() {
    initializeMobileTable();
});

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„
function toggleMobilePhoneOptions(phoneNumber, orderId) {
    const modal = document.getElementById('mobilePhoneModal');
    const callBtn = document.getElementById('mobileCallBtn');
    const whatsappBtn = document.getElementById('mobileWhatsappBtn');
    const copyBtn = document.getElementById('mobileCopyBtn');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    callBtn.href = `tel:${phoneNumber}`;
    whatsappBtn.href = `https://wa.me/${phoneNumber.replace('+', '').replace(' ', '')}`;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø¯Ø« Ø§Ù„Ù†Ø³Ø®
    copyBtn.onclick = function() {
        copyPhoneNumber(phoneNumber);
    };
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    showModal('mobilePhoneModal');
}
</script>