{% extends "base_worker.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-gray-900">ğŸ“‹ Ù…Ù‡Ø§Ù…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h1>
                <p class="text-gray-600 mt-1 text-sm md:text-base">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙˆÙƒÙ„Ø© Ø¥Ù„ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
            <div class="flex items-center space-x-3 space-x-reverse">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs md:text-sm font-medium">
                    {{ active_tasks|length }} Ù…Ù‡Ø§Ù… Ù†Ø´Ø·Ø©
                </span>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø© -->
    <div class="grid gap-6">
        {% for task_item in active_tasks %}
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all duration-300">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
            <div class="flex items-start justify-between mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-tasks text-white text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900">{{ task_item.title }}</h2>
                        <div class="flex items-center gap-3 mt-2">
                            <span class="px-3 py-1 rounded-full text-xs font-medium 
                                {% if task_item.priority == 'critical' %}bg-red-100 text-red-800
                                {% elif task_item.priority == 'high' %}bg-orange-100 text-orange-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ 'Ø­Ø±Ø¬Ø©' if task_item.priority == 'critical' else 'Ø¹Ø§Ù„ÙŠØ©' if task_item.priority == 'high' else 'Ù…ØªÙˆØ³Ø·Ø©' }}
                            </span>
                            
                            <span class="px-3 py-1 rounded-full text-xs font-medium 
                                {% if task_item.status == 'in_progress' %}bg-green-100 text-green-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' if task_item.status == 'in_progress' else 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' }}
                            </span>

                            {% if task_item.is_overdue %}
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                âš ï¸ Ù…ØªØ£Ø®Ø±Ø©
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ© -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200 mb-6">
                <h3 class="text-lg font-bold text-blue-900 mb-4 flex items-center">
                    <i class="fas fa-info-circle ml-2 text-blue-600"></i>
                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                            <div class="text-lg font-bold text-gray-900">
                                {% if task_item.related_order %}
                                    {{ task_item.related_order.name }}
                                {% else %}
                                    {{ task_item.title|replace('Ø¥Ù†Ø¬Ø§Ø² Ø·Ù„Ø¨ÙŠØ© - ', '') }}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-map-marker-alt text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                            <div class="text-lg font-bold text-gray-900">
                                {% if task_item.related_order %}
                                    {{ task_item.related_order.wilaya }}
                                {% else %}
                                    ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ù…Ù†ØªØ¬ -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-box text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">Ø§Ù„Ù…Ù†ØªØ¬</div>
                            <div class="text-lg font-bold text-gray-900">
                                {% if task_item.related_order %}
                                    {{ task_item.related_order.product }}
                                {% else %}
                                    ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ù†ÙˆØ¹ Ø§Ù„ØªØ¹ÙŠÙŠÙ† -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-briefcase text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">Ù†ÙˆØ¹ Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>
                            <div class="text-lg font-bold text-gray-900">
                                {% if task_item.assignment_type %}
                                    {{ task_item.assignment_type }}
                                {% elif task_item.related_order and task_item.related_order.is_travel_assignment %}
                                    Ø³ÙØ± ÙˆØªØ±ÙƒÙŠØ¨
                                {% else %}
                                    ÙˆØ±Ø´Ø© Ø¹Ù…Ù„
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-calendar-check text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                            <div class="text-lg font-bold text-gray-900 {% if task_item.is_overdue %}text-red-600{% endif %}">
                                {% if task_item.due_date %}
                                    {{ task_item.due_date.strftime('%Y-%m-%d') }}
                                {% elif task_item.related_order and task_item.related_order.expected_delivery_date %}
                                    {{ task_item.related_order.expected_delivery_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                                {% endif %}
                            </div>
                            {% if task_item.is_overdue %}
                            <div class="text-xs text-red-600 mt-1">âš ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ -->
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-sm border border-blue-200">
                            <i class="fas fa-clock text-blue-600"></i>
                        </div>
                        <div>
                            <div class="text-sm text-blue-700 font-medium mb-1">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</div>
                            <div class="text-lg font-bold text-gray-900">
                                {{ task_item.created_at.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="flex flex-col sm:flex-row gap-4 justify-end">
                {% if task_item.status == 'pending' %}
                <button onclick="startTask({{ task_item.id }})" 
                        class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3 text-lg shadow-lg">
                    <i class="fas fa-play"></i>
                    Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°
                </button>
                {% elif task_item.status == 'in_progress' %}
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="completeTask({{ task_item.id }})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3 text-lg shadow-lg">
                        <i class="fas fa-check"></i>
                        Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
                    </button>
                    
                    <button onclick="showSuspensionModal({{ task_item.id }})" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-3 text-lg shadow-lg">
                        <i class="fas fa-pause"></i>
                        Ø·Ù„Ø¨ ØªØ¹Ù„ÙŠÙ‚
                    </button>
                </div>
                {% endif %}
                
                {% if task_item.status == 'completed' and task_item.waiting_approval %}
                <div class="bg-yellow-100 border border-yellow-300 rounded-xl p-6 text-center w-full">
                    <div class="flex items-center justify-center gap-3 mb-3">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                        <div class="text-yellow-800 font-semibold text-lg">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
                    </div>
                    <div class="text-yellow-700">Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>
                </div>
                {% endif %}
            </div>

            <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
            {% if task_item.notes %}
            <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                <div class="flex items-start gap-3">
                    <i class="fas fa-sticky-note text-yellow-600 mt-1"></i>
                    <div>
                        <div class="text-yellow-800 font-semibold text-sm mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                        <p class="text-yellow-700">{{ task_item.notes }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ -->
            {% if task_item.status == 'suspended' %}
            <div class="mt-6 p-4 bg-red-50 rounded-xl border border-red-200">
                <div class="flex items-center gap-3">
                    <i class="fas fa-pause-circle text-red-600 text-xl"></i>
                    <div>
                        <h4 class="font-semibold text-red-800 text-lg">Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø¹Ù„Ù‚Ø©</h4>
                        <p class="text-red-700 mt-1">{{ task_item.notes }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù‡Ø§Ù… -->
        <div class="text-center py-16">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-12 max-w-md mx-auto">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-tasks text-blue-600 text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                <p class="text-gray-600 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø®ØµØµØ© Ù„Ùƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© -->
    {% if pending_approval_tasks %}
    <div class="mt-12">
        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2>
        <div class="grid gap-6">
            {% for task_item in pending_approval_tasks %}
            <div class="bg-yellow-50 rounded-2xl shadow-sm border border-yellow-300 p-6">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-4 mb-4">
                            <h3 class="text-xl font-semibold text-yellow-900">{{ task_item.title }}</h3>
                            <span class="px-4 py-2 bg-yellow-200 text-yellow-800 rounded-full text-sm font-medium">
                                Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
                            </span>
                        </div>
                        
                        {% if task_item.completion_notes %}
                        <div class="mb-6">
                            <p class="text-yellow-800 font-medium text-base mb-3">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡:</p>
                            <p class="text-yellow-700 bg-yellow-100 p-4 rounded-xl text-base">{{ task_item.completion_notes }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="text-base text-yellow-700 flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙÙŠ: {{ task_item.completed_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ -->
<div id="completion-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-check text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">âœ… ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
            </div>
            
            <form id="completion-form">
                <input type="hidden" id="task-id">
                
                <div class="mb-6">
                    <label class="block text-lg font-medium text-gray-700 mb-4">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</label>
                    <textarea id="completion-notes" rows="5" 
                              class="w-full border border-gray-300 rounded-xl px-4 py-4 bg-white text-gray-900 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
                              placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª..."></textarea>
                    <p class="text-sm text-gray-500 mt-3">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                    <button type="button" onclick="hideCompletionModal()" 
                            class="px-8 py-4 border border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors order-2 sm:order-1 text-lg">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-3 text-lg order-1 sm:order-2">
                        <i class="fas fa-paper-plane"></i>
                        Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ -->
<div id="suspension-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-pause text-orange-600 text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">â¸ï¸ Ø·Ù„Ø¨ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
            </div>
            
            <form id="suspension-form">
                <input type="hidden" id="suspension-task-id">
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-3">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù†Ø§Ù‚Øµ</label>
                        <input type="text" id="product-search" 
                               class="w-full border border-gray-300 rounded-xl px-4 py-4 bg-white text-gray-900 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬...">
                        <div id="product-suggestions" class="hidden mt-3 border border-gray-300 rounded-xl max-h-40 overflow-y-auto bg-white shadow-lg"></div>
                    </div>
                    
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-3">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù†Ø§Ù‚ØµØ©</label>
                        <input type="number" id="missing-quantity" 
                               class="w-full border border-gray-300 rounded-xl px-4 py-4 bg-white text-gray-900 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©" min="1">
                    </div>
                    
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-3">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                        <textarea id="issue-description" rows="4"
                                  class="w-full border border-gray-300 rounded-xl px-4 py-4 bg-white text-gray-900 text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                  placeholder="ØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-end mt-8">
                    <button type="button" onclick="hideSuspensionModal()" 
                            class="px-8 py-4 border border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors text-lg">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" 
                            class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-xl font-semibold transition-all flex items-center justify-center gap-3 text-lg">
                        <i class="fas fa-paper-plane"></i>
                        Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
function startTask(taskId) {
    showToast('Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©...', 'info');
    
    fetch(`/api/worker/tasks/${taskId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ù…Ø©', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
    });
}

function completeTask(taskId) {
    document.getElementById('task-id').value = taskId;
    document.getElementById('completion-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideCompletionModal() {
    document.getElementById('completion-modal').classList.add('hidden');
    document.getElementById('completion-form').reset();
    document.body.style.overflow = 'auto';
}

// Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
document.getElementById('completion-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('task-id').value;
    const notes = document.getElementById('completion-notes').value;
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    submitBtn.disabled = true;
    
    // âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ JSON
    fetch(`/api/worker/tasks/${taskId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',  // âœ… Ù…Ù‡Ù…
        },
        body: JSON.stringify({ 
            notes: notes,
            completion_notes: notes  // âœ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„
        })  // âœ… ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'success');
            hideCompletionModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Ø¯ÙˆØ§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
function showSuspensionModal(taskId) {
    document.getElementById('suspension-task-id').value = taskId;
    document.getElementById('suspension-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideSuspensionModal() {
    document.getElementById('suspension-modal').classList.add('hidden');
    document.getElementById('suspension-form').reset();
    document.getElementById('product-suggestions').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById('product-search').addEventListener('input', function(e) {
    const query = e.target.value;
    const suggestions = document.getElementById('product-suggestions');
    
    if (query.length < 2) {
        suggestions.classList.add('hidden');
        return;
    }
    
    fetch(`/api/products/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.products.length > 0) {
                suggestions.innerHTML = data.products.map(product => `
                    <div class="p-4 hover:bg-blue-50 cursor-pointer border-b border-gray-200 text-base transition-colors" 
                         onclick="selectProduct('${product.name.replace(/'/g, "\\'")}')">
                        <div class="font-semibold">${product.name}</div>
                        <div class="text-gray-500 text-sm">${product.category}</div>
                    </div>
                `).join('');
                suggestions.classList.remove('hidden');
            } else {
                suggestions.innerHTML = '<div class="p-4 text-gray-500 text-base text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                suggestions.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            suggestions.classList.add('hidden');
        });
});

function selectProduct(productName) {
    document.getElementById('product-search').value = productName;
    document.getElementById('product-suggestions').classList.add('hidden');
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
document.getElementById('suspension-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('suspension-task-id').value;
    const productName = document.getElementById('product-search').value;
    const quantity = document.getElementById('missing-quantity').value;
    const description = document.getElementById('issue-description').value;
    
    if (!productName || !quantity) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    submitBtn.disabled = true;
    
    fetch(`/api/worker/tasks/${taskId}/suspend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_name: productName,
            quantity: quantity,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©', 'success');
            hideSuspensionModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
document.getElementById('completion-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCompletionModal();
    }
});

document.getElementById('suspension-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideSuspensionModal();
    }
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', function(e) {
    const suggestions = document.getElementById('product-suggestions');
    const searchInput = document.getElementById('product-search');
    
    if (suggestions && !suggestions.contains(e.target) && e.target !== searchInput) {
        suggestions.classList.add('hidden');
    }
});
function connectWebSocket() {
    const ws = new WebSocket('ws://localhost:5000/ws/tasks');
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'task_updated') {
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©', 'info');
            location.reload();
        }
    };
}
// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-6 left-6 z-50 p-4 rounded-xl shadow-2xl text-white max-w-xs md:max-w-sm text-base transform transition-all duration-300 ${
        type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :
        type === 'error' ? 'bg-gradient-to-r from-red-500 to-pink-600' :
        type === 'info' ? 'bg-gradient-to-r from-blue-500 to-indigo-600' :
        'bg-gradient-to-r from-yellow-500 to-orange-600'
    }`;
    
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} ml-3 text-lg"></i>
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="text-white/80 hover:text-white mr-2 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 4000);
}
</script>

<style>
/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .grid-cols-1 > * {
        margin-bottom: 16px;
    }
    
    .text-2xl {
        font-size: 1.5rem;
    }
    
    .text-xl {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}