[file name]: orders.html
[file content begin]
{% extends "base.html" %}
{% block content %}

<!-- ======================= -->
<!-- ๐ฏ MAIN CONTAINER -->
<!-- ======================= -->
<div class="max-w-full">
  
  <!-- ======================= -->
  <!-- ๐ HEADER SECTION -->
  <!-- ======================= -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <!-- Page Title -->
    <div>
      <h2 class="text-3xl font-bold text-gray-900">๐ฆ ุงูุทูุจูุงุช โ <span class="text-blue-700">SOFAZI</span></h2>
      <p class="text-sm text-gray-500">ุฅุฏุงุฑุฉ ุงูุทูุจุงุชุ ุงูููุชุฑุฉุ ูุงูุณุฌู ุงูุฏุงุฎูู.</p>
    </div>

    <!-- Filters & Actions -->
    <div class="flex items-center gap-3 flex-wrap">
      <!-- Search Input -->
      <div class="relative">
        <input id="searchInput" type="text" placeholder="๐ ุจุญุซ ุจุงูุงุณูุ ุงููุงุชูุ ุงูููุงูุฉุ ุงูููุชุฌ..." 
               class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-72"
               aria-label="ุจุญุซ ูู ุงูุทูุจูุงุช">
        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
          <i class="fa-solid fa-magnifying-glass"></i>
        </span>
      </div>

      <!-- Status Filter -->
      <select id="statusFilter" class="py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm shadow-sm" aria-label="ุชุตููุฉ ุญุณุจ ุงูุญุงูุฉ">
        <option value="">ูู ุงูุญุงูุงุช</option>
        {% for s in statuses %}
          <option value="{{ s.name }}">{{ s.name }}</option>
        {% endfor %}
      </select>

      <!-- Worker Filter -->
      <select id="workerFilter" class="py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm shadow-sm" aria-label="ุชุตููุฉ ุญุณุจ ุงูุนุงูู">
        <option value="">ูู ุงูุนูุงู</option>
        {% for worker in workers %}
          <option value="{{ worker.id }}">{{ worker.name }}</option>
        {% endfor %}
      </select>

      <!-- Health Filter -->
      <select id="healthFilter" class="py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm shadow-sm" aria-label="ุชุตููุฉ ุญุณุจ ุงูุตุญุฉ ุงููุงููุฉ">
        <option value="">ูู ุงูุทูุจูุงุช</option>
        <option value="healthy">ุทูุจูุงุช ุณูููุฉ</option>
        <option value="debt">ุทูุจูุงุช ุจูุง ุฏููู</option>
        <option value="completed_with_debt">ููุชููุฉ ูุน ุฏููู</option>
      </select>

      <!-- Show/Hide Paid Orders -->
      <a href="{{ url_for('orders', show_paid=not show_paid) }}" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white text-sm hover:bg-gray-50 transition-colors shadow-sm" aria-label="{{ 'ุฅุฎูุงุก ุงููุฏููุนุฉ' if show_paid else 'ุฅุธูุงุฑ ุงููุฏููุนุฉ' }}">
        <i class="fas {% if show_paid %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
        {{ 'ุฅุฎูุงุก ุงููุฏููุนุฉ' if show_paid else 'ุฅุธูุงุฑ ุงููุฏููุนุฉ' }}
      </a>
    </div>
    
    <!-- Add New Order Button -->
    <div class="flex justify-center">
      <button id="btnAdd" class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105" aria-label="ุฅุถุงูุฉ ุทูุจูุฉ ุฌุฏูุฏุฉ">
        <i class="fa-solid fa-plus text-lg"></i> 
        <span class="font-semibold">ุฅุถุงูุฉ ุทูุจูุฉ ุฌุฏูุฏุฉ</span>
      </button>
    </div>
  </div>

  <!-- ======================= -->
  <!-- ๐ STATISTICS CARDS -->
  <!-- ======================= -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 mb-6">
    <!-- Total Orders -->
    <div class="card p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-90">ุฅุฌูุงูู ุงูุทูุจูุงุช</p>
          <p class="text-2xl font-bold">{{ orders|length }}</p>
        </div>
        <i class="fas fa-box text-2xl opacity-80" aria-hidden="true"></i>
      </div>
    </div>
    
    <!-- Total Amount -->
    <div class="card p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-90">ุงูุฅุฌูุงูู</p>
          <p class="text-2xl font-bold">{{ "%.0f"|format(orders|sum(attribute='total')) }} ุฏุฌ</p>
        </div>
        <i class="fas fa-money-bill-wave text-2xl opacity-80" aria-hidden="true"></i>
      </div>
    </div>
    
    <!-- Total Costs -->
    <div class="card p-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">ุฅุฌูุงูู ุงูุชูุงููู</p>
                <p class="text-2xl font-bold">{{ "%.0f"|format(orders|sum(attribute='total_costs')) }} ุฏุฌ</p>
            </div>
            <i class="fas fa-receipt text-2xl opacity-80" aria-hidden="true"></i>
        </div>
    </div>

    <!-- Healthy Orders -->
    <div class="card p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-90">ุทูุจูุงุช ุณูููุฉ</p>
          <p class="text-2xl font-bold" id="healthyOrdersCount">0</p>
          <p class="text-xs opacity-80 mt-1">ุจุฏูู ุฏููู</p>
        </div>
        <i class="fas fa-check-circle text-2xl opacity-80" aria-hidden="true"></i>
      </div>
    </div>

    <!-- Orders with Debts -->
    <div class="card p-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl shadow-lg cursor-pointer" 
         onclick="showOrdersWithDebts()" id="ordersDebtsCard">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-90">ุทูุจูุงุช ุจูุง ุฏููู</p>
          <p class="text-2xl font-bold" id="ordersDebtsTotal">0 ุฏุฌ</p>
          <p class="text-xs opacity-80 mt-1">
            <span id="affectedOrdersCount">0</span> ุทูุจูุฉ ูุชุฃุซุฑุฉ
          </p>
        </div>
        <div class="text-right">
          <i class="fas fa-file-invoice-dollar text-2xl opacity-80 mb-2"></i>
          <div class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full">
            ๐๏ธ ุนุฑุถ ุงูุชูุงุตูู
          </div>
        </div>
      </div>
    </div>
    
    <!-- Total Profit -->
    <div class="card p-4 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-xl shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm opacity-90">ุฅุฌูุงูู ุงูุฃุฑุจุงุญ</p>
                <p class="text-2xl font-bold">{{ "%.0f"|format(orders|sum(attribute='profit')) }} ุฏุฌ</p>
            </div>
            <i class="fas fa-chart-line text-2xl opacity-80" aria-hidden="true"></i>
        </div>
    </div>
    
    <!-- Remaining Amount -->
    <div class="card p-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm opacity-90">ุงููุจูุบ ุงููุชุจูู</p>
          <p class="text-2xl font-bold">{{ "%.0f"|format(orders|sum(attribute='remaining')) }} ุฏุฌ</p>
        </div>
        <i class="fas fa-clock text-2xl opacity-80" aria-hidden="true"></i>
      </div>
    </div>
  </div>

  <!-- ======================= -->
  <!-- ๐ฐ TOTAL COSTS SUMMARY -->
  <!-- ======================= -->
  <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl shadow-lg p-6 mb-6 text-white">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="text-center md:text-right">
        <h3 class="text-xl md:text-2xl font-bold mb-2">๐ฐ ุงูุชูุงููู ุงูุฅุฌูุงููุฉ ููุทูุจูุงุช</h3>
        <p class="text-purple-100 text-sm">ูุฌููุน ุชูุงููู ุงููุดุชุฑูุงุช ูุงูููู ูุฌููุน ุงูุทูุจูุงุช</p>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1 max-w-2xl">
        <!-- ุชูุงููู ุงููุดุชุฑูุงุช -->
        <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center backdrop-blur-sm">
          <div class="text-2xl font-bold mb-1" id="totalPurchasesCost">0 ุฏุฌ</div>
          <div class="text-purple-100 text-xs">ุชูุงููู ุงููุดุชุฑูุงุช</div>
        </div>
        
        <!-- ุชูุงููู ุงูููู -->
        <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center backdrop-blur-sm">
          <div class="text-2xl font-bold mb-1" id="totalTransportCost">0 ุฏุฌ</div>
          <div class="text-purple-100 text-xs">ุชูุงููู ุงูููู</div>
        </div>
        
        <!-- ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ -->
        <div class="bg-white bg-opacity-30 rounded-xl p-4 text-center backdrop-blur-sm border-2 border-white border-opacity-30">
          <div class="text-2xl font-bold mb-1" id="totalCombinedCost">0 ุฏุฌ</div>
          <div class="text-purple-100 text-xs font-semibold">ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ</div>
        </div>
        
        <!-- ูุชูุณุท ุงูุชูููุฉ ููู ุทูุจูุฉ -->
        <div class="bg-white bg-opacity-20 rounded-xl p-4 text-center backdrop-blur-sm">
          <div class="text-2xl font-bold mb-1" id="averageCostPerOrder">0 ุฏุฌ</div>
          <div class="text-purple-100 text-xs">ูุชูุณุท ุงูุชูููุฉ</div>
        </div>
      </div>
    </div>
    
    <!-- ุดุฑูุท ุงูุชูุฏู ุงููุฑุฆู -->
    <div class="mt-4 bg-white bg-opacity-20 rounded-full h-3 backdrop-blur-sm">
      <div class="h-3 rounded-full bg-gradient-to-r from-green-400 to-cyan-400 transition-all duration-1000" 
           id="costProgressBar" style="width: 0%"></div>
    </div>
    
    <!-- ุชูุงุตูู ุงูุชูุฒูุน -->
    <div class="mt-3 flex justify-between text-xs text-purple-200">
      <span>ุงููุดุชุฑูุงุช</span>
      <span id="costDistribution">0% ูุดุชุฑูุงุช | 0% ููู</span>
      <span>ุงูููู</span>
    </div>
  </div>

  <!-- ======================= -->
  <!-- ๐ ORDERS TABLE -->
  <!-- ======================= -->
  <div class="bg-white rounded-2xl shadow-md overflow-hidden">
    <!-- Desktop Table -->
    <div class="block md:block overflow-x-auto">
      <table class="w-full text-sm text-right">
        <thead class="bg-gray-100 border-b">
          <tr class="text-gray-700 font-medium">
            <th class="p-3">#</th>
            <th class="p-3">ุงูุงุณู</th>
            <th class="p-3">ุงููุงุชู</th>
            <th class="p-3">ุงูููุงูุฉ</th>
            <th class="p-3">ุงูููุชุฌ</th>
            <th class="p-3">ุงูุฅุฌูุงูู</th>
            <th class="p-3">ุงููุฏููุน</th>
            <th class="p-3">ุงููุชุจูู</th>
            <th class="p-3">ุงูุญุงูุฉ</th>
            <th class="p-3">ุงูุตุญุฉ ุงููุงููุฉ</th>
            <th class="p-3">ุงูุนูุงู</th>
            <th class="p-3">ุงูุฑุจุญูุฉ</th>
            <th class="p-3">ุงูุนูููุงุช</th>
          </tr>
        </thead>
        <tbody id="ordersTable">
          {% for o in orders %}
          <tr class="border-b hover:bg-gray-50 transition" 
              data-order-id="{{ o.id }}"
              data-status="{{ o.status.name if o.status else '' }}"
              data-worker-ids="{{ o.assigned_workers|map(attribute='id')|join(',') }}"
              data-health-status="{{ 'healthy' if o.remaining <= 0 else 'debt' }}"
              data-search-index="{{ o.name.lower() }} {{ o.wilaya.lower() }} {{ o.product.lower() }} {{ o.phones[0].number if o.phones else '' }}">
            <td class="p-3 text-gray-700">{{ o.id }}</td>
            <td class="p-3 font-medium text-gray-900">{{ o.name }}</td>

            <!-- Phone Cell -->
            <td class="p-3">
              {% if o.phones and o.phones|length > 0 %}
                {% set phone = o.phones[0] %}
                <div class="phone-display-container">
                  <div class="phone-number-display cursor-pointer" onclick="togglePhoneOptions('{{ phone.number }}')" role="button" aria-label="ุฎูุงุฑุงุช ุงููุงุชู">
                    {{ phone.number }}
                    <i class="fas fa-chevron-down ml-1 text-xs"></i>
                  </div>
                  
                  <div id="phoneOptions-{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                       class="phone-options-popup hidden">
                    <div class="flex gap-2 p-2 bg-white rounded-lg shadow-lg border">
                      <a href="tel:{{ phone.number }}" class="phone-btn bg-green-500 text-white" aria-label="ุงุชุตุงู">
                        <i class="fas fa-phone"></i>
                      </a>
                      <a href="https://wa.me/{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                         target="_blank" class="phone-btn bg-green-600 text-white" aria-label="ูุงุชุณุงุจ">
                        <i class="fab fa-whatsapp"></i>
                      </a>
                      <button onclick="copyPhoneNumber('{{ phone.number }}')" 
                              class="phone-btn bg-blue-500 text-white" aria-label="ูุณุฎ ุงูุฑูู">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% else %}
                <span class="text-gray-400 text-xs">ูุง ููุฌุฏ</span>
              {% endif %}
            </td>

            <td class="p-3 text-gray-700">{{ o.wilaya }}</td>
            <td class="p-3 text-gray-700">{{ o.product }}</td>
            
            <!-- Total Amount -->
            <td class="p-3">
              <div class="text-right">
                <span class="font-bold text-lg text-purple-700">{{ "%.0f"|format(o.total) }}</span>
                <span class="text-xs text-purple-600 block">ุฏุฌ</span>
              </div>
            </td>
            
            <!-- Paid Amount -->
            <td class="p-3">
              <div class="text-right">
                <span class="font-bold text-lg text-green-600">{{ "%.0f"|format(o.paid) }}</span>
                <span class="text-xs text-green-600 block">ุฏุฌ</span>
              </div>
            </td>

            <td class="p-3 {% if o.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %} font-semibold">
              {{ "%.0f"|format(o.remaining) }} ุฏุฌ
            </td>

            <!-- Status -->
            <td class="p-3">
              {% if o.status %}
                <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold"
                      style="background: {{ o.status.color }}22; color: {{ o.status.color }}">
                  {{ o.status.name }}
                </span>
              {% else %}
                <span class="inline-block px-3 py-1 rounded-full text-xs bg-gray-100 text-gray-700">ุจุฏูู ุญุงูุฉ</span>
              {% endif %}
            </td>

            <!-- Health Status -->
            <td class="p-3">
              {% if o.remaining <= 0 %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                  <i class="fas fa-check-circle ml-1"></i>
                  ุณูููุฉ
                </span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                  <i class="fas fa-exclamation-triangle ml-1"></i>
                  ุจูุง ุฏููู
                </span>
              {% endif %}
            </td>

            <!-- Workers -->
            <td class="p-3">
              {% if o.assigned_workers %}
                <div class="flex flex-wrap gap-1">
                  {% for worker in o.assigned_workers %}
                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full" 
                          data-worker-id="{{ worker.id }}">
                      {{ worker.name }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-gray-400 text-xs">ุบูุฑ ูุนูู</span>
              {% endif %}
            </td>

            <!-- Profitability -->
            <td class="p-3">
              {% set profit_info = calculate_order_profitability(o.id) if calculate_order_profitability %}
              {% if profit_info %}
                <div class="flex items-center gap-2">
                  <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-{{ 'green' if profit_info.is_profitable else 'red' }}-500 h-2 rounded-full" 
                         style="width: {{ profit_info.profit_percentage|abs|int }}%"></div>
                  </div>
                  <span class="text-xs {{ 'text-green-600' if profit_info.is_profitable else 'text-red-600' }}">
                    {{ "%.1f"|format(profit_info.profit_percentage) }}%
                  </span>
                </div>
              {% else %}
                <span class="text-gray-400 text-sm">-</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td class="p-3">
              <div class="flex gap-2 flex-wrap">
                <!-- Details Button -->
                <button class="details-btn text-purple-600 hover:text-purple-800" 
                        title="ุชูุงุตูู ูุชุนููู"
                        data-id="{{ o.id }}"
                        onclick="showOrderDetails({{ o.id }})"
                        aria-label="ุชูุงุตูู ุงูุทูุจูุฉ">
                  <i class="fa-solid fa-list text-lg"></i>
                </button>

                <!-- Edit Button -->
                <button class="edit-btn text-blue-600 hover:text-blue-800" 
                        title="ุชุนุฏูู"
                        data-id="{{ o.id }}"
                        data-name="{{ o.name }}"
                        data-wilaya="{{ o.wilaya }}"
                        data-product="{{ o.product }}"
                        data-paid="{{ '%.0f'|format(o.paid) }}"
                        data-total="{{ '%.0f'|format(o.total) }}"
                        data-note="{{ o.note }}"
                        data-phones="{{ o.phones[0].number if o.phones else '' }}"
                        data-status="{{ o.status.id if o.status else '' }}"
                        onclick="editOrder(this)"
                        aria-label="ุชุนุฏูู ุงูุทูุจูุฉ">
                  <i class="fa-solid fa-pen-to-square text-lg"></i>
                </button>

                <!-- History Button -->
                <button class="history-btn text-gray-600 hover:text-gray-800" 
                        title="ุงูุณุฌู ูุงูุฏูุนุงุช" 
                        data-id="{{ o.id }}"
                        onclick="showHistory({{ o.id }})"
                        aria-label="ุณุฌู ุงูุทูุจูุฉ">
                  <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                </button>
                
                <!-- Attachments Button -->
                <button class="attachments-btn text-purple-600 hover:text-purple-800" 
                        title="ูุนุงููุฉ ุงููุฑููุงุช"
                        data-id="{{ o.id }}"
                        onclick="showAttachments({{ o.id }})"
                        aria-label="ูุฑููุงุช ุงูุทูุจูุฉ">
                  <i class="fa-solid fa-paperclip text-lg"></i>
                </button>

                <!-- Payment Button -->
                {% if o.remaining > 0 %}
                <button class="payment-btn text-green-600 hover:text-green-800" 
                        title="ุฅุถุงูุฉ ุฏูุนุฉ" 
                        data-id="{{ o.id }}" 
                        data-remaining="{{ o.remaining }}"
                        onclick="showPaymentModal({{ o.id }}, {{ o.remaining }})"
                        aria-label="ุฅุถุงูุฉ ุฏูุนุฉ">
                  <i class="fa-solid fa-money-bill-wave text-lg"></i>
                </button>
                {% endif %}

                <!-- Delete Button -->
                <a href="{{ url_for('delete_order', id=o.id) }}"
                   class="text-red-600 hover:text-red-800"
                   title="ุญุฐู"
                   onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุทูุจูุฉุ');"
                   aria-label="ุญุฐู ุงูุทูุจูุฉ">
                  <i class="fa-solid fa-trash text-lg"></i>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="13" class="p-6 text-center text-gray-500">
              <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
              <p>ูุง ุชูุฌุฏ ุทูุจูุงุช ุจุนุฏ</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile Cards -->
    <div class="md:hidden space-y-4 p-4">
      {% for o in orders %}
      <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 order-card" 
           data-order-id="{{ o.id }}"
           data-status="{{ o.status.name if o.status else '' }}"
           data-worker-ids="{{ o.assigned_workers|map(attribute='id')|join(',') }}"
           data-health-status="{{ 'healthy' if o.remaining <= 0 else 'debt' }}"
           data-search-index="{{ o.name.lower() }} {{ o.wilaya.lower() }} {{ o.product.lower() }} {{ o.phones[0].number if o.phones else '' }}">
        
        <!-- Header -->
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-bold text-gray-900 text-lg">#{{ o.id }} - {{ o.name }}</h3>
            <p class="text-sm text-gray-600">{{ o.product }}</p>
          </div>
          <div class="flex flex-col items-end gap-1">
            {% if o.status %}
            <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold"
                  style="background: {{ o.status.color }}22; color: {{ o.status.color }}">
              {{ o.status.name }}
            </span>
            {% endif %}
            <!-- Health Status Badge -->
            {% if o.remaining <= 0 %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
              <i class="fas fa-check-circle ml-1"></i>
              ุณูููุฉ
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
              <i class="fas fa-exclamation-triangle ml-1"></i>
              ุจูุง ุฏููู
            </span>
            {% endif %}
          </div>
        </div>

        <!-- Details -->
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <p class="text-xs text-gray-500">ุงูููุงูุฉ</p>
            <p class="text-sm font-medium">{{ o.wilaya }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500">ุงููุงุชู</p>
            {% if o.phones and o.phones|length > 0 %}
            <div class="flex items-center gap-1">
              <p class="text-sm font-medium">{{ o.phones[0].number }}</p>
              <button onclick="toggleMobilePhoneOptions('{{ o.phones[0].number }}', {{ o.id }})" 
                      class="text-blue-500 text-xs">
                <i class="fas fa-ellipsis-h"></i>
              </button>
            </div>
            {% else %}
            <p class="text-sm text-gray-400">ูุง ููุฌุฏ</p>
            {% endif %}
          </div>
        </div>

        <!-- Financial -->
        <div class="grid grid-cols-3 gap-2 mb-3 p-3 bg-gray-50 rounded-lg">
          <div class="text-center">
            <p class="text-xs text-gray-500">ุงูุฅุฌูุงูู</p>
            <p class="text-sm font-bold text-purple-700">{{ "%.0f"|format(o.total) }} ุฏุฌ</p>
          </div>
          <div class="text-center">
            <p class="text-xs text-gray-500">ุงููุฏููุน</p>
            <p class="text-sm font-bold text-green-600">{{ "%.0f"|format(o.paid) }} ุฏุฌ</p>
          </div>
          <div class="text-center">
            <p class="text-xs text-gray-500">ุงููุชุจูู</p>
            <p class="text-sm font-bold {% if o.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %}">
              {{ "%.0f"|format(o.remaining) }} ุฏุฌ
            </p>
          </div>
        </div>

        <!-- Workers -->
        <div class="mb-3">
          <p class="text-xs text-gray-500 mb-1">ุงูุนูุงู ุงููุนูููู</p>
          {% if o.assigned_workers %}
          <div class="flex flex-wrap gap-1">
            {% for worker in o.assigned_workers %}
            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
              {{ worker.name }}
            </span>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-sm text-gray-400">ุบูุฑ ูุนูู</p>
          {% endif %}
        </div>

        <!-- Profitability -->
        <div class="mb-4">
          <p class="text-xs text-gray-500 mb-1">ุงูุฑุจุญูุฉ</p>
          {% set profit_info = calculate_order_profitability(o.id) if calculate_order_profitability %}
          {% if profit_info %}
          <div class="flex items-center gap-2">
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-{{ 'green' if profit_info.is_profitable else 'red' }}-500 h-2 rounded-full" 
                   style="width: {{ profit_info.profit_percentage|abs|int }}%"></div>
            </div>
            <span class="text-xs {{ 'text-green-600' if profit_info.is_profitable else 'text-red-600' }}">
              {{ "%.1f"|format(profit_info.profit_percentage) }}%
            </span>
          </div>
          {% else %}
          <p class="text-sm text-gray-400">-</p>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center border-t pt-3">
          <div class="flex gap-2">
            <button onclick="showOrderDetails({{ o.id }})" 
                    class="text-purple-600 p-2 rounded-lg hover:bg-purple-50 transition-colors"
                    title="ุชูุงุตูู">
              <i class="fa-solid fa-list"></i>
            </button>
            <button onclick="editMobileOrder({{ o.id }})" 
                    class="text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition-colors"
                    title="ุชุนุฏูู">
              <i class="fa-solid fa-pen-to-square"></i>
            </button>
            <button onclick="showHistory({{ o.id }})" 
                    class="text-gray-600 p-2 rounded-lg hover:bg-gray-50 transition-colors"
                    title="ุงูุณุฌู">
              <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
          </div>
          <div class="flex gap-2">
            {% if o.remaining > 0 %}
            <button onclick="showPaymentModal({{ o.id }}, {{ o.remaining }})" 
                    class="text-green-600 p-2 rounded-lg hover:bg-green-50 transition-colors"
                    title="ุฏูุนุฉ">
              <i class="fa-solid fa-money-bill-wave"></i>
            </button>
            {% endif %}
            <a href="{{ url_for('delete_order', id=o.id) }}"
               class="text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors"
               onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุทูุจูุฉุ');"
               title="ุญุฐู">
              <i class="fa-solid fa-trash"></i>
            </a>
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
        <p>ูุง ุชูุฌุฏ ุทูุจูุงุช ุจุนุฏ</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- ๐ซ MODALS SECTION -->
<!-- ======================= -->

<!-- Order Add/Edit Modal -->
<div id="orderModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-content modern-modal">
    <div class="modal-header">
      <h3 id="modalTitle" class="text-xl font-bold text-gray-900">โ ุฅุถุงูุฉ ุทูุจูุฉ ุฌุฏูุฏุฉ</h3>
      <button type="button" onclick="hideModal('orderModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form id="orderForm" method="POST" class="modal-body">
      <input type="hidden" name="id" id="order_id">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="order_name" class="form-label">ุงูุงุณู *</label>
          <input name="name" id="order_name" required class="form-input">
        </div>
        <div class="form-group">
          <label for="order_phone" class="form-label">ุฑูู ุงููุงุชู *</label>
          <input type="tel" name="phones" id="order_phone" required class="form-input" placeholder="+213 XXX XX XX XX">
        </div>
        <div class="form-group">
          <label for="order_wilaya" class="form-label">ุงูููุงูุฉ *</label>
          <input name="wilaya" id="order_wilaya" required class="form-input">
        </div>
        <div class="form-group">
          <label for="order_product" class="form-label">ุงูููุชุฌ *</label>
          <input name="product" id="order_product" required class="form-input">
        </div>
        <div class="form-group">
          <label for="order_paid" class="form-label">ุงููุฏููุน *</label>
          <input name="paid" id="order_paid" type="number" step="0.01" required class="form-input" value="0">
        </div>
        <div class="form-group">
          <label for="order_total" class="form-label">ุงูุฅุฌูุงูู *</label>
          <input name="total" id="order_total" type="number" step="0.01" required class="form-input" value="0">
        </div>
        <div class="form-group">
          <label for="expected_cost" class="form-label">ุงูุชูููุฉ ุงููุชููุนุฉ</label>
          <input name="expected_cost" id="expected_cost" type="number" step="0.01" class="form-input" placeholder="ุณูุชู ุงุญุชุณุงุจูุง ุชููุงุฆูุงู">
        </div>
        <div class="form-group">
          <label for="estimated_days" class="form-label">ุงูุฃูุงู ุงููุชููุนุฉ</label>
          <input name="estimated_days" id="estimated_days" type="number" class="form-input" placeholder="ุนุฏุฏ ุฃูุงู ุงูุชูููุฐ ุงููุชููุนุฉ">
        </div>
        <div class="md:col-span-2 form-group">
          <label for="order_note" class="form-label">ุงูููุงุญุธุงุช</label>
          <textarea name="note" id="order_note" rows="3" class="form-textarea"></textarea>
        </div>
        <div class="md:col-span-2 form-group">
          <label for="order_status" class="form-label">ุงูุญุงูุฉ</label>
          <div class="flex gap-2">
            <select name="status" id="order_status" class="form-select flex-1">
              <option value="">-- ุงุฎุชุฑ ุงูุญุงูุฉ --</option>
              {% for s in statuses %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
            </select>
            <button type="button" onclick="showAddStatusModal()" class="form-action-btn" aria-label="ุฅุถุงูุฉ ุญุงูุฉ ุฌุฏูุฏุฉ">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" onclick="hideModal('orderModal')" class="btn-secondary">ุฅูุบุงุก</button>
        <button type="submit" class="btn-primary">ุญูุธ ุงูุทูุจูุฉ</button>
      </div>
    </form>
  </div>
</div>

<!-- Mobile Phone Options Modal -->
<div id="mobilePhoneModal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-content modern-modal compact">
    <div class="modal-header">
      <h3 class="text-lg font-bold text-gray-900">ุฎูุงุฑุงุช ุงููุงุชู</h3>
      <button type="button" onclick="hideModal('mobilePhoneModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="flex justify-center gap-6 py-4">
        <a id="mobileCallBtn" href="#" class="action-btn success large" aria-label="ุงุชุตุงู">
          <i class="fas fa-phone"></i>
        </a>
        <a id="mobileWhatsappBtn" href="#" target="_blank" class="action-btn whatsapp large" aria-label="ูุงุชุณุงุจ">
          <i class="fab fa-whatsapp"></i>
        </a>
        <button id="mobileCopyBtn" class="action-btn primary large" aria-label="ูุณุฎ ุงูุฑูู">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div id="detailsModal" class="modal" role="dialog" aria-labelledby="detailsOrderId" aria-hidden="true">
  <div class="modal-content modern-modal large">
    <div class="modal-header">
      <div>
        <h3 class="text-xl font-bold text-gray-900">๐ ุชูุงุตูู ุงูุทูุจูุฉ #<span id="detailsOrderId"></span></h3>
        <p class="text-sm text-gray-500 mt-1" id="detailsCustomerName"></p>
      </div>
      <button type="button" onclick="hideModal('detailsModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Worker Assignment Section -->
        <div class="space-y-6">
          <div class="feature-section blue">
            <h4 class="section-title">
              <i class="fas fa-users"></i>
              ๐ฅ ุฅุฏุงุฑุฉ ุชุนููู ุงูุนูุงู
            </h4>
            
            <!-- Current Assignments -->
            <div class="mb-6">
              <h5 class="section-subtitle">ุงูุชุนูููุงุช ุงููุดุทุฉ:</h5>
              <div id="currentAssignments" class="space-y-3">
                <div class="empty-state">
                  <i class="fas fa-user-clock"></i>
                  <p>ูุง ุชูุฌุฏ ุชุนูููุงุช ุญุงููุฉ</p>
                  <p class="text-xs">ุงุณุชุฎุฏู ุงููููุฐุฌ ุฃุฏูุงู ูุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ</p>
                </div>
              </div>
            </div>
            
            <!-- New Assignment Form -->
            <div class="form-container">
              <h5 class="section-subtitle">ุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ:</h5>
              <form id="assignWorkerForm" class="space-y-4">
                <input type="hidden" id="assign_order_id">
                
                <div class="form-group">
                  <label for="assign_worker_id" class="form-label">ุงุฎุชุฑ ุงูุนุงูู</label>
                  <select id="assign_worker_id" class="form-select" required>
                    <option value="">-- ุงุฎุชุฑ ุงูุนุงูู --</option>
                    {% for worker in workers %}
                      <option value="{{ worker.id }}">{{ worker.name }} - {{ worker.phone }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="assign_type" class="form-label">ููุน ุงููููุฉ</label>
                  <select id="assign_type" class="form-select" required>
                    <option value="workshop">ุนูู ุฏุงุฎู ุงููุฑุดุฉ</option>
                    <option value="travel">ุณูุฑ ูุชุฑููุจ</option>
                    <option value="installation">ุชุฑููุจ ููุท</option>
                    <option value="maintenance">ุตูุงูุฉ ูุฅุตูุงุญ</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="assign_notes" class="form-label">ููุงุญุธุงุช ุงูุชุนููู</label>
                  <textarea id="assign_notes" rows="3" class="form-textarea" placeholder="ุฃุถู ุชูุงุตูู ุนู ุงููููุฉ..."></textarea>
                </div>
                
                <button type="submit" class="btn-success w-full">
                  <i class="fas fa-user-plus ml-2"></i>
                  ุชุนููู ุงูุนุงูู
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Additional Details Section -->
        <div class="space-y-6">
          <div class="feature-section purple">
            <h4 class="section-title">
              <i class="fas fa-clipboard-list"></i>
              ๐ ุงูุชูุงุตูู ุงูุฅุถุงููุฉ
            </h4>
            
            <div class="space-y-4">
              <div class="form-group">
                <label for="production_details" class="form-label">ุชูุงุตูู ุงูุฅูุชุงุฌ</label>
                <textarea id="production_details" rows="4" class="form-textarea" placeholder="ุฃุถู ุชูุงุตูู ุนู ุณูุฑ ุงูุนููุ ุงูููุงุฏ ุงููุณุชุฎุฏูุฉุ ุงูููุงุญุธุงุช ุงููููุฉ..."></textarea>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="start_date" class="form-label">ุชุงุฑูุฎ ุงูุจุฏุก</label>
                  <input type="date" id="start_date" class="form-input">
                </div>
                <div class="form-group">
                  <label for="expected_delivery" class="form-label">ุชุงุฑูุฎ ุงูุชุณููู ุงููุชููุน</label>
                  <input type="date" id="expected_delivery" class="form-input">
                </div>
              </div>
              
              <div class="form-group">
                <label for="actual_delivery" class="form-label">ุชุงุฑูุฎ ุงูุชุณููู ุงููุนูู</label>
                <input type="date" id="actual_delivery" class="form-input">
              </div>
            </div>
          </div>
          
          <!-- Quick Attachments Access -->
          <div class="feature-section orange">
            <h4 class="section-title">
              <i class="fas fa-paperclip"></i>
              ๐ ุงููุตูู ุงูุณุฑูุน ูููุฑููุงุช
            </h4>
            <div class="text-center">
              <button onclick="showAttachments(currentOrderId)" class="btn-warning w-full">
                <i class="fas fa-external-link-alt ml-2"></i>
                ูุชุญ ูุงูุฐุฉ ุงููุฑููุงุช
              </button>
              <p class="text-xs text-gray-500 mt-2">ุฅุฏุงุฑุฉ ูุงููุฉ ูุฌููุน ุงููุฑููุงุช ูุงูุตูุฑ</p>
            </div>
          </div>
        </div>

        <!-- Performance Evaluation Section -->
        <div class="space-y-6">
          <div class="feature-section green">
            <h4 class="section-title">
              <i class="fas fa-chart-line"></i>
              โญ ุชูููู ุฃุฏุงุก ุงูุทูุจูุฉ
            </h4>
            
            <div class="space-y-4">
              <!-- Auto Performance Evaluation -->
              <div class="form-group">
                <label class="form-label">๐ ุงูุชูููู ุงูุชููุงุฆู</label>
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-blue-600" id="autoTimeScore">0%</div>
                      <div class="text-xs text-gray-600">ุงูุงูุชุฒุงู ุจุงูููุช</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-green-600" id="autoCostScore">0%</div>
                      <div class="text-xs text-gray-600">ุงูุงูุชุฒุงู ุจุงูููุฒุงููุฉ</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-purple-600" id="autoQualityScore">0%</div>
                      <div class="text-xs text-gray-600">ุฌูุฏุฉ ุงูุนูู</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-orange-600" id="autoWorkerScore">0%</div>
                      <div class="text-xs text-gray-600">ุฃุฏุงุก ุงูุนูุงู</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Performance Insights -->
              <div class="form-group">
                <label class="form-label">๐ก ุชุญููู ุงูุฃุฏุงุก</label>
                <div id="performanceInsights" class="space-y-2 text-sm">
                  <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>ุฌุงุฑู ุชุญููู ุฃุฏุงุก ุงูุทูุจูุฉ...</p>
                  </div>
                </div>
              </div>

              <!-- Post-Installation Issues -->
              <div class="form-group">
                <label class="form-label">โ๏ธ ูุดุงูู ูุง ุจุนุฏ ุงูุชุฑููุจ</label>
                <div class="space-y-3">
                  <div id="postInstallationIssues">
                    <div class="empty-state">
                      <i class="fas fa-tools"></i>
                      <p>ูุง ุชูุฌุฏ ูุดุงูู ูุณุฌูุฉ</p>
                    </div>
                  </div>
                  <button type="button" onclick="showIssueReportModal()" class="btn-warning w-full">
                    <i class="fas fa-exclamation-triangle ml-2"></i>
                    ุชุณุฌูู ูุดููุฉ ุฌุฏูุฏุฉ
                  </button>
                </div>
              </div>

              <!-- Root Cause Analysis -->
              <div class="form-group">
                <label class="form-label">๐ ุชุญููู ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉ</label>
                <div id="rootCauseAnalysis" class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                  <p class="text-sm text-yellow-800 text-center">ุณูุธูุฑ ุชุญููู ุงูุฃุณุจุงุจ ููุง ุนูุฏ ุชุณุฌูู ุงููุดุงูู</p>
                </div>
              </div>

              <!-- Overall Score -->
              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                  <span class="font-semibold">ุงูุชูููู ุงูููุงุฆู:</span>
                  <span id="overall_score" class="text-2xl font-bold text-green-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                  <div id="score_progress" class="h-2 rounded-full bg-green-500 transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2 text-center" id="performanceSummary">ุฌุงุฑู ุงูุชูููู...</div>
              </div>

              <button type="button" onclick="refreshAutoEvaluation()" class="btn-success w-full">
                <i class="fas fa-sync-alt ml-2"></i>
                ุชุญุฏูุซ ุงูุชูููู ุงูุชููุงุฆู
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="button" onclick="hideModal('detailsModal')" class="btn-secondary">
        <i class="fas fa-times ml-2"></i>
        ุฅุบูุงู
      </button>
      <button type="button" onclick="saveOrderDetails()" class="btn-primary">
        <i class="fas fa-save ml-2"></i>
        ุญูุธ ุฌููุน ุงูุชุบููุฑุงุช
      </button>
    </div>
  </div>
</div>

<!-- Issue Report Modal -->
<div id="issueReportModal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-content modern-modal">
    <div class="modal-header">
      <h3 class="text-xl font-bold text-gray-900">โ๏ธ ุชุณุฌูู ูุดููุฉ ุจุนุฏ ุงูุชุฑููุจ</h3>
      <button type="button" onclick="hideModal('issueReportModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="issueReportForm" class="modal-body">
      <input type="hidden" id="issue_order_id">
      
      <div class="space-y-4">
        <div class="form-group">
          <label for="issue_type" class="form-label">ููุน ุงููุดููุฉ *</label>
          <select id="issue_type" class="form-select" required>
            <option value="">-- ุงุฎุชุฑ ููุน ุงููุดููุฉ --</option>
            <option value="welding_issue">ูุดููุฉ ูู ุงููุญุงู</option>
            <option value="material_issue">ูุดููุฉ ูู ุงูููุงุฏ</option>
            <option value="design_issue">ูุดููุฉ ูู ุงูุชุตููู</option>
            <option value="installation_issue">ูุดููุฉ ูู ุงูุชุฑููุจ</option>
            <option value="finishing_issue">ูุดููุฉ ูู ุงูุชุดุทูุจ</option>
            <option value="transport_issue">ูุดููุฉ ูู ุงูููู</option>
            <option value="other">ุฃุฎุฑู</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="issue_severity" class="form-label">ุดุฏุฉ ุงููุดููุฉ *</label>
          <select id="issue_severity" class="form-select" required>
            <option value="low">ููุฎูุถุฉ</option>
            <option value="medium">ูุชูุณุทุฉ</option>
            <option value="high">ุนุงููุฉ</option>
            <option value="critical">ุญุฑุฌุฉ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="issue_description" class="form-label">ูุตู ุงููุดููุฉ *</label>
          <textarea id="issue_description" rows="4" class="form-textarea" placeholder="ุตู ุงููุดููุฉ ุจุงูุชูุตูู..." required></textarea>
        </div>
        
        <div class="form-group">
          <label for="issue_cause" class="form-label">ุงูุณุจุจ ุงููุญุชูู</label>
          <textarea id="issue_cause" rows="3" class="form-textarea" placeholder="ูุง ูู ุงูุณุจุจ ุงููุญุชูู ูููุดููุฉุ"></textarea>
        </div>
        
        <div class="form-group">
          <label for="issue_solution" class="form-label">ุงูุญู ุงูููุชุฑุญ</label>
          <textarea id="issue_solution" rows="3" class="form-textarea" placeholder="ูุง ูู ุงูุญู ุงูููุชุฑุญุ"></textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label for="issue_date" class="form-label">ุชุงุฑูุฎ ุงูุชุดุงู ุงููุดููุฉ</label>
            <input type="date" id="issue_date" class="form-input" required>
          </div>
          <div class="form-group">
            <label for="estimated_repair_time" class="form-label">ุงูููุช ุงููุชููุน ููุฅุตูุงุญ (ุฃูุงู)</label>
            <input type="number" id="estimated_repair_time" class="form-input" min="1" value="1">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">ูู ุชู ุฅุตูุงุญ ุงููุดููุฉุ</label>
          <div class="flex gap-4">
            <label class="flex items-center">
              <input type="radio" name="issue_resolved" value="yes" class="mr-2">
              <span>ูุนู</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="issue_resolved" value="no" checked class="mr-2">
              <span>ูุง</span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="hideModal('issueReportModal')" class="btn-secondary">ุฅูุบุงุก</button>
        <button type="submit" class="btn-primary">ุญูุธ ุงููุดููุฉ</button>
      </div>
    </form>
  </div>
</div>

<!-- ุจุงูู ุงูููุฏุงูุงุช ุชุจูู ููุง ูู ูุน ุชุนุฏููุงุช ุจุณูุทุฉ -->
<!-- Order History Modal -->
<div id="historyModal" class="modal" role="dialog" aria-labelledby="historyOrderId" aria-hidden="true">
  <div class="modal-content modern-modal xlarge">
    <div class="modal-header">
      <div>
        <h3 class="text-xl font-bold text-gray-900">๐ ุงูุณุฌู ุงููุงูู ููุทูุจูุฉ #<span id="historyOrderId"></span></h3>
        <p class="text-sm text-gray-500 mt-1" id="historyOrderInfo"></p>
      </div>
      <button type="button" onclick="hideModal('historyModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="grid grid-cols-2 md:grid-cols-7 gap-3 mb-6">
        <!-- Total -->
        <div class="stat-card purple">
            <div class="stat-label">ุงูุฅุฌูุงูู</div>
            <div class="stat-value" id="historyTotalAmount">0 ุฏุฌ</div>
        </div>
        
        <!-- Paid -->
        <div class="stat-card green">
            <div class="stat-label">ุงููุฏููุน</div>
            <div class="stat-value" id="historyPaidAmount">0 ุฏุฌ</div>
        </div>
        
        <!-- Remaining -->
        <div class="stat-card orange">
            <div class="stat-label">ุงููุชุจูู</div>
            <div class="stat-value" id="historyRemainingAmount">0 ุฏุฌ</div>
        </div>
        
        <!-- Cost -->
        <div class="stat-card red">
            <div class="stat-label">ุงูุชูููุฉ</div>
            <div class="stat-value" id="historyCostAmount">0 ุฏุฌ</div>
        </div>
        
        <!-- Debt Card -->
        <div class="stat-card bg-gradient-to-r from-red-500 to-pink-600 text-white cursor-pointer"
             onclick="showDebtDetails(currentOrderId)"
             id="orderDebtCard">
          <div class="stat-label">
            ุฏููู ุงูุทูุจูุฉ 
            <i class="fas fa-sync-alt ml-1 text-xs" id="debtRefreshIcon"></i>
          </div>
          <div class="stat-value" id="historyOrderDebt">0 ุฏุฌ</div>
          <div class="text-xs opacity-80 mt-1" id="debtStatusText">ุฌุงุฑู ุงูุชุญุฏูุซ...</div>
        </div>

        <!-- Profit -->
        <div class="stat-card green">
            <div class="stat-label">ุงูุฑุจุญ</div>
            <div class="stat-value" id="historyProfitAmount">0 ุฏุฌ</div>
        </div>
        
        <!-- Profit Percentage -->
        <div class="stat-card blue">
            <div class="stat-label">ูุณุจุฉ ุงูุฑุจุญ</div>
            <div class="stat-value" id="historyProfitPercentage">0%</div>
        </div>
      </div>

      <!-- Visual Progress Bar -->
      <div class="progress-section">
          <div class="progress-labels">
              <span>ุงูุชูููุฉ</span>
              <span>ุงูุฅุฌูุงูู</span>
              <span>ุงูุฑุจุญ</span>
          </div>
          <div class="progress-bar-container">
              <div class="absolute left-0 top-0 h-4 bg-red-500 rounded-l-full" id="costBar"></div>
              <div class="absolute left-0 top-0 h-4 bg-green-500" id="profitBar"></div>
          </div>
          <div class="progress-percentages">
              <span id="costPercentage">0%</span>
              <span id="profitPercentage">0%</span>
          </div>
      </div>
      
      <!-- ๐ ุญููู ุงูุชุตููุฉ -->
      <div class="filters-section mb-6">
        <div class="section-header">
            <h4 class="section-title">
                <i class="fas fa-filter"></i>
                ๐ ุชุตููุฉ ุงูุณุฌู
            </h4>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
            <!-- ููุชุฑ ุญุณุจ ุงููุณุชุฎุฏู -->
            <div class="form-group">
                <label for="historyUserFilter" class="form-label">ุงููุณุชุฎุฏู</label>
                <select id="historyUserFilter" class="form-select" onchange="applyHistoryFilters()">
                    <option value="">ุฌููุน ุงููุณุชุฎุฏููู</option>
                    {% for user in all_users %}
                    <option value="{{ user.username }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- ููุชุฑ ููุน ุงูุนูููุฉ -->
            <div class="form-group">
                <label for="historyTypeFilter" class="form-label">ููุน ุงูุนูููุฉ</label>
                <select id="historyTypeFilter" class="form-select" onchange="applySmartHistoryFilters()">
                    <option value="">ุฌููุน ุงูุนูููุงุช</option>
                    <option value="ุฏูุนุฉ">ุฏูุนุงุช ูุงููุฉ</option>
                    <option value="ูุตุฑูู">ูุตุงุฑูู</option>
                    <option value="ููู">ุชูุงููู ููู</option>
                    <option value="ุฏููู">ุงูุฏููู</option>
                    <option value="ุชุนููู">ุชุนูููุงุช ุนูุงู</option>
                    <option value="ุชุนุฏูู">ุชุนุฏููุงุช</option>
                    <option value="ุฅูุดุงุก">ุฅูุดุงุก ุทูุจูุงุช</option>
                    <option value="ุญุฐู">ุนูููุงุช ุญุฐู</option>
                    <option value="ุชูููู">ุชููููุงุช ุฃุฏุงุก</option>
                    <option value="ูุดููุฉ">ูุดุงูู ูุง ุจุนุฏ ุงูุชุฑููุจ</option>
                    <option value="ุฃุฎุฑู">ุนูููุงุช ุฃุฎุฑู</option>
                </select>
            </div>
            
            <!-- ุฒุฑ ุฅุนุงุฏุฉ ุงูุชุนููู -->
            <div class="form-group flex items-end">
                <button type="button" onclick="resetHistoryFilters()" class="btn-outline w-full">
                    <i class="fas fa-refresh ml-2"></i>
                    ุฅุนุงุฏุฉ ุงูุชุนููู
                </button>
            </div>
        </div>
      </div>

      <!-- ุงูุณุฌู ุงูููุญุฏ -->
      <div class="history-section">
        <div class="section-header">
          <h4 class="section-title">
            <i class="fas fa-stream"></i>
            ุงูุณุฌู ุงูุฒููู ุงูููุญุฏ
          </h4>
          <span class="history-stats" id="historyStats">0 ุนูููุฉ</span>
        </div>
        <div id="unifiedHistoryContent" class="history-content">
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>ุฌุงุฑู ุชุญููู ุงูุณุฌู...</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="button" onclick="hideModal('historyModal')" class="btn-secondary">
        ุฅุบูุงู ุงูุณุฌู
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal" role="dialog" aria-labelledby="paymentTitle" aria-hidden="true">
  <div class="modal-content modern-modal compact">
    <form id="paymentForm" method="POST" class="modal-body">
      <div class="modal-header">
        <h3 class="text-lg font-bold text-gray-900">๐ฐ ุฅุถุงูุฉ ุฏูุนุฉ</h3>
        <button type="button" onclick="hideModal('paymentModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <input type="hidden" name="order_id" id="payment_order_id">
      
      <div class="info-banner blue">
        <p class="text-sm">ุงููุจูุบ ุงููุชุจูู: <span id="remainingAmount" class="font-bold">0</span> ุฏุฌ</p>
      </div>

      <div class="form-group">
        <label for="payment_amount" class="form-label">ูุจูุบ ุงูุฏูุนุฉ *</label>
        <input type="number" name="amount" id="payment_amount" step="0.01" required 
               class="form-input"
               placeholder="ุฃุฏุฎู ูุจูุบ ุงูุฏูุนุฉ">
      </div>

      <div class="form-group">
        <label for="payment_date" class="form-label">ุชุงุฑูุฎ ุงูุฏูุนุฉ</label>
        <input type="date" name="payment_date" id="payment_date" required 
               class="form-input"
               value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
      </div>

      <div class="form-group">
        <label for="payment_method" class="form-label">ุทุฑููุฉ ุงูุฏูุน</label>
        <select name="payment_method" id="payment_method" class="form-select">
            <option value="ููุฏู">ููุฏู</option>
            <option value="ุชุญููู ุจููู">ุชุญููู ุจููู</option>
            <option value="ุดูู">ุดูู</option>
        </select>
      </div>

      <div class="form-group">
        <label for="payment_notes" class="form-label">ููุงุญุธุงุช</label>
        <textarea name="notes" id="payment_notes" rows="2" class="form-textarea" placeholder="ููุงุญุธุงุช ุญูู ุงูุฏูุนุฉ..."></textarea>
      </div>

      <div class="modal-actions">
        <button type="button" onclick="hideModal('paymentModal')" class="btn-secondary">ุฅูุบุงุก</button>
        <button type="submit" class="btn-success">ุฅุถุงูุฉ ุงูุฏูุนุฉ</button>
      </div>
    </form>
  </div>
</div>

<!-- Attachments Modal -->
<div id="attachmentsModal" class="modal" role="dialog" aria-labelledby="attachmentsOrderId" aria-hidden="true">
  <div class="modal-content modern-modal large">
    <div class="modal-header">
      <div>
        <h3 class="text-xl font-bold text-gray-900">๐ ูุฑููุงุช ุงูุทูุจูุฉ #<span id="attachmentsOrderId"></span></h3>
        <p class="text-sm text-gray-500 mt-1">ุฅุฏุงุฑุฉ ูุฑููุงุช ุงูุทูุจูุฉ</p>
      </div>
      <button type="button" onclick="hideModal('attachmentsModal')" class="modal-close-btn" aria-label="ุฅุบูุงู">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- File Upload Area -->
      <div class="upload-section">
        <input type="file" id="newFileInput" multiple accept="image/*,video/*,.pdf,.doc,.docx" class="hidden">
        <div class="upload-content">
          <i class="fas fa-cloud-upload-alt"></i>
          <div>
            <button type="button" onclick="document.getElementById('newFileInput').click()" class="btn-primary">
              ุงุฎุชุฑ ุงููููุงุช ููุฑูุน
            </button>
            <p class="upload-hint">ุงุณุญุจ ูุฃููุช ุงููููุงุช ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
            <p class="upload-info">PDF, ุตูุฑ, ููุฏูู, ูุณุชูุฏุงุช - ุงูุญุฏ ุงูุฃูุตู 10MB</p>
          </div>
        </div>
      </div>

      <!-- Upload Preview -->
      <div id="uploadPreview" class="preview-section hidden">
        <h4 class="section-title">๐ธ ุงููุนุงููุฉ ุงููุจุงุดุฑุฉ</h4>
        <div id="previewContainer" class="preview-grid">
          <!-- Previews will appear here -->
        </div>
      </div>

      <!-- Current Attachments List -->
      <div class="attachments-section">
        <h4 class="section-title">
          <i class="fas fa-files"></i>
          ุงููุฑููุงุช ุงูุญุงููุฉ (<span id="attachmentsCount">0</span>)
        </h4>
        <div id="currentAttachmentsList" class="attachments-list">
          <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <p>ูุง ุชูุฌุฏ ูุฑููุงุช ุญุงููุฉ</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" onclick="hideModal('attachmentsModal')" class="btn-secondary">
        ุฅุบูุงู
      </button>
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- ๐ฐ ORDERS DEBTS MODAL  -->
<!-- ======================= -->
<div id="ordersDebtsModal" class="modal">
  <div class="modal-content modern-modal xlarge">
    <div class="modal-header">
      <div>
        <h3 class="text-xl font-bold text-white">๐ ุงูุทูุจูุงุช ุงููุชุฃุซุฑุฉ ุจุงูุฏููู</h3>
        <p class="text-sm text-purple-100 mt-1" id="ordersDebtsSummary">0 ุทูุจูุฉ ุจุฅุฌูุงูู 0 ุฏุฌ ุฏููู</p>
      </div>
      <button type="button" onclick="hideModal('ordersDebtsModal')" class="modal-close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat-card bg-red-500">
          <div class="stat-label">ุฅุฌูุงูู ุงูุฏููู</div>
          <div class="stat-value" id="modalTotalDebts">0 ุฏุฌ</div>
        </div>
        <div class="stat-card bg-orange-500">
          <div class="stat-label">ุงูุทูุจูุงุช ุงููุชุฃุซุฑุฉ</div>
          <div class="stat-value" id="modalAffectedOrders">0</div>
        </div>
        <div class="stat-card bg-yellow-500">
          <div class="stat-label">ูุชูุณุท ุงูุฏูู</div>
          <div class="stat-value" id="modalAverageDebt">0 ุฏุฌ</div>
        </div>
        <div class="stat-card bg-green-500">
          <div class="stat-label">ุทูุจูุงุช ุจุฏูู ุฏููู</div>
          <div class="stat-value" id="modalDebtFreeOrders">0</div>
        </div>
      </div>

      <!-- ุฌุฏูู ุงูุทูุจูุงุช -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="table-header">
            <tr>
              <th class="p-3"># ุงูุทูุจูุฉ</th>
              <th class="p-3">ุงูุนููู</th>
              <th class="p-3">ุฅุฌูุงูู ุงูุทูุจูุฉ</th>
              <th class="p-3">ูุจูุบ ุงูุฏูู</th>
              <th class="p-3">ูุณุจุฉ ุงูุฏูู</th>
              <th class="p-3">ุงูุญุงูุฉ</th>
              <th class="p-3">ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="ordersDebtsList">
            <!-- ุณูุชู ููุคู ุจุงูุฌุงูุงุณูุฑูุจุช -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ุดุฑูุท ุงูุชุญููู ููููุงุชู -->
<div id="mobileLoader" class="mobile-loader hidden">
  <div class="loader-content">
    <div class="loader-spinner"></div>
    <p class="loader-text">ุฌุงุฑู ุงูุชุญููู...</p>
  </div>
</div>

<!-- ุฒุฑ ุงูุนูุฏุฉ ููุฃุนูู ููููุงุชู -->
<button id="scrollToTop" class="scroll-to-top hidden" aria-label="ุงูุนูุฏุฉ ููุฃุนูู">
  <i class="fas fa-arrow-up"></i>
</button>

<!-- ======================= -->
<!-- ๐ JAVASCRIPT SECTION -->
<!-- ======================= -->
<script>
// ======================= //
// ๐ฆ GLOBAL VARIABLES     //
// ======================= //
let originalHistoryData = null;
let currentOrderId = null;
let currentRemaining = 0;
let currentUploadedFiles = [];
let activeModals = new Set();
let isInitialized = false;
let currentHistoryData = [];
let debtMonitoringInterval = null;

// ุญุงูุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ
const appState = {
    currentOrderId: null,
    activeFilters: {},
    pendingOperations: 0,
    isOnline: navigator.onLine,
    timeouts: {}
};

// ุญุงูุฉ ููุงุชุฑ ุงูุณุฌู
const historyFiltersState = {
    user: '',
    type: '',
    dateFrom: '',
    dateTo: '',
    searchText: ''
};

// ======================= //
// ๐ฏ CORE FUNCTIONS       //
// ======================= //

// ุฅุฏุงุฑุฉ ุงูููุงูุฐ ุงููุญุณูุฉ
function showModal(modalId) {
    if (activeModals.size >= 3) {
        showToast('ููุฌุฏ ุงูุนุฏูุฏ ูู ุงูููุงูุฐ ุงูููุชูุญุฉ', 'warning');
        return;
    }
    
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        activeModals.add(modalId);
        
        // ุชุญุณููุงุช ุงูุฌูุงู
        if (isMobileDevice()) {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.margin = '1rem';
                modalContent.style.maxHeight = 'calc(100vh - 2rem)';
            }
        }
    } else {
        console.error(`Modal ${modalId} not found`);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        activeModals.delete(modalId);
        
        if (activeModals.size === 0) {
            document.body.style.overflow = 'auto';
        }
    }
}

// ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุญุณู
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${getToastColor(type)}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

function getToastColor(type) {
    const colors = {
        'success': 'toast-success',
        'warning': 'toast-warning',
        'error': 'toast-error',
        'info': 'toast-info'
    };
    return colors[type] || colors.info;
}

// ======================= //
// ๐ฑ MOBILE ENHANCEMENTS  //
// ======================= //

function isMobileDevice() {
    return window.innerWidth <= 768;
}

function toggleMobilePhoneOptions(phoneNumber, orderId) {
    const callBtn = document.getElementById('mobileCallBtn');
    const whatsappBtn = document.getElementById('mobileWhatsappBtn');
    const copyBtn = document.getElementById('mobileCopyBtn');
    
    if (callBtn) callBtn.href = `tel:${phoneNumber}`;
    if (whatsappBtn) whatsappBtn.href = `https://wa.me/${phoneNumber.replace('+', '').replace(' ', '')}`;
    
    if (copyBtn) {
        copyBtn.onclick = () => {
            copyPhoneNumber(phoneNumber);
        };
    }
    
    showModal('mobilePhoneModal');
}

function editMobileOrder(orderId) {
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    fetch(`/api/orders/${orderId}/basic-info`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                document.getElementById('modalTitle').textContent = 'โ๏ธ ุชุนุฏูู ุงูุทูุจูุฉ';
                document.getElementById('orderForm').action = '/orders/edit/' + orderId;
                document.getElementById('order_id').value = orderId;
                
                document.getElementById('order_name').value = data.order.name || '';
                document.getElementById('order_wilaya').value = data.order.wilaya || '';
                document.getElementById('order_product').value = data.order.product || '';
                document.getElementById('order_paid').value = data.order.paid || '0';
                document.getElementById('order_total').value = data.order.total || '0';
                document.getElementById('order_note').value = data.order.note || '';
                document.getElementById('order_status').value = data.order.status_id || '';
                document.getElementById('order_phone').value = data.order.phone || '';

                showModal('orderModal');
            } else {
                showToast('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุทูุจูุฉ', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading order data:', error);
            showToast('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุทูุจูุฉ', 'error');
        });
}

function initScrollToTop() {
    const scrollButton = document.getElementById('scrollToTop');
    if (scrollButton) {
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                scrollButton.classList.remove('hidden');
            } else {
                scrollButton.classList.add('hidden');
            }
        });
        
        scrollButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
}

function showMobileLoader() {
    const loader = document.getElementById('mobileLoader');
    if (loader) loader.classList.remove('hidden');
}

function hideMobileLoader() {
    const loader = document.getElementById('mobileLoader');
    if (loader) loader.classList.add('hidden');
}

// ======================= //
// ๐ SMART SEARCH & FILTERS //
// ======================= //

function setupSearchAndFilters() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const workerFilter = document.getElementById('workerFilter');
    const healthFilter = document.getElementById('healthFilter');
    
    if (!searchInput) {
        console.error('Search input not found');
        return;
    }
    
    // ุจุญุซ ุฐูู ูุน ุชุฃุฎูุฑ
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => performSmartSearch(), 300);
    });
    
    if (statusFilter) {
        statusFilter.addEventListener('change', performSmartSearch);
    }
    
    if (workerFilter) {
        workerFilter.addEventListener('change', performSmartSearch);
    }
    
    if (healthFilter) {
        healthFilter.addEventListener('change', performSmartSearch);
    }
    
    setupWorkerFilter();
}

function setupWorkerFilter() {
    const workerFilter = document.getElementById('workerFilter');
    if (workerFilter) {
        workerFilter.addEventListener('change', function() {
            performSmartSearch();
        });
    }
}

function performSmartSearch() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const workerFilter = document.getElementById('workerFilter');
    const healthFilter = document.getElementById('healthFilter');
    
    if (!searchInput || !statusFilter || !workerFilter || !healthFilter) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    const statusValue = statusFilter.value;
    const workerValue = workerFilter.value;
    const healthValue = healthFilter.value;
    
    const rows = document.querySelectorAll('#ordersTable tr[data-order-id], .md\\:hidden .order-card');
    let visibleCount = 0;
    
    if (rows.length === 0) return;
    
    requestAnimationFrame(() => {
        rows.forEach(row => {
            const searchIndex = row.getAttribute('data-search-index') || '';
            const rowStatus = row.dataset.status || '';
            const rowWorkerIds = row.dataset.workerIds || '';
            const rowHealthStatus = row.dataset.healthStatus || '';
            
            const matchesSearch = searchTerm === '' || searchIndex.includes(searchTerm);
            const matchesStatus = statusValue === '' || rowStatus === statusValue;
            const matchesWorker = workerValue === '' || rowWorkerIds.includes(workerValue);
            const matchesHealth = healthValue === '' || rowHealthStatus === healthValue;
            
            if (matchesSearch && matchesStatus && matchesWorker && matchesHealth) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // ุนุฑุถ ูุชุงุฆุฌ ุงูุจุญุซ
        if (searchTerm || statusValue || workerValue || healthValue) {
            showToast(`ุนูุซุฑ ุนูู ${visibleCount} ุทูุจูุฉ`, visibleCount > 0 ? 'success' : 'warning');
        }
    });
}

// ======================= //
// ๐ฐ COST CALCULATION     //
// ======================= //

async function loadTotalCosts() {
    try {
        showMobileLoader();
        
        const response = await fetch('/api/orders/total-costs');
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateCostsDisplay(data.costs);
        } else {
            console.error('Error loading costs:', data.error);
            showToast('ุฎุทุฃ ูู ุชุญููู ุงูุชูุงููู', 'error');
        }
    } catch (error) {
        console.error('Error fetching total costs:', error);
        showToast('ุฎุทุฃ ูู ุชุญููู ุงูุชูุงููู', 'error');
    } finally {
        hideMobileLoader();
    }
}

function updateCostsDisplay(costs) {
    if (!costs) return;
    
    const purchasesCost = document.getElementById('totalPurchasesCost');
    const transportCost = document.getElementById('totalTransportCost');
    const combinedCost = document.getElementById('totalCombinedCost');
    const averageCost = document.getElementById('averageCostPerOrder');
    const progressBar = document.getElementById('costProgressBar');
    const distribution = document.getElementById('costDistribution');
    
    if (purchasesCost) purchasesCost.textContent = formatCurrency(costs.total_purchases);
    if (transportCost) transportCost.textContent = formatCurrency(costs.total_transport);
    if (combinedCost) combinedCost.textContent = formatCurrency(costs.total_combined);
    if (averageCost) averageCost.textContent = formatCurrency(costs.average_per_order);
    
    const total = costs.total_combined || 1;
    const purchasesPercentage = total > 0 ? (costs.total_purchases / total) * 100 : 0;
    const transportPercentage = total > 0 ? (costs.total_transport / total) * 100 : 0;
    
    if (progressBar) {
        progressBar.style.width = purchasesPercentage + '%';
    }
    
    if (distribution) {
        distribution.textContent = 
            `${purchasesPercentage.toFixed(1)}% ูุดุชุฑูุงุช | ${transportPercentage.toFixed(1)}% ููู`;
    }
    
    updateProgressBarColor(purchasesPercentage);
}

function updateProgressBarColor(percentage) {
    const progressBar = document.getElementById('costProgressBar');
    if (!progressBar) return;
    
    if (percentage < 30) {
        progressBar.className = 'h-3 rounded-full bg-gradient-to-r from-green-400 to-cyan-400 transition-all duration-1000';
    } else if (percentage < 60) {
        progressBar.className = 'h-3 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400 transition-all duration-1000';
    } else {
        progressBar.className = 'h-3 rounded-full bg-gradient-to-r from-red-400 to-pink-400 transition-all duration-1000';
    }
}

function formatCurrency(amount) {
    const numAmount = parseFloat(amount) || 0;
    return new Intl.NumberFormat('ar-DZ', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(numAmount) + ' ุฏุฌ';
}

// ======================= //
// ๐ REAL-TIME UPDATES    //
// ======================= //

function setupCostsAutoRefresh() {
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', function() {
            setTimeout(loadTotalCosts, 1000);
        });
    }
    
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function() {
            setTimeout(loadTotalCosts, 1000);
        });
    }
    
    // ุชุญุฏูุซ ูู 30 ุซุงููุฉ
    setInterval(loadTotalCosts, 30000);
}

// ======================= //
// ๐ ORDER MANAGEMENT     //
// ======================= //

function showAddForm() {
    const modalTitle = document.getElementById('modalTitle');
    const orderForm = document.getElementById('orderForm');
    
    if (modalTitle) modalTitle.textContent = 'โ ุฅุถุงูุฉ ุทูุจูุฉ ุฌุฏูุฏุฉ';
    if (orderForm) {
        orderForm.action = "{{ url_for('add_order') }}";
        orderForm.reset();
    }
    
    const statusSelect = document.getElementById('order_status');
    const orderId = document.getElementById('order_id');
    
    if (statusSelect) statusSelect.value = '';
    if (orderId) orderId.value = '';
    
    showModal('orderModal');
}

function editOrder(button) {
    if (!button) return;
    
    const orderId = button.dataset.id;
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    const modalTitle = document.getElementById('modalTitle');
    const orderForm = document.getElementById('orderForm');
    
    if (modalTitle) modalTitle.textContent = 'โ๏ธ ุชุนุฏูู ุงูุทูุจูุฉ';
    if (orderForm) orderForm.action = '/orders/edit/' + orderId;
    
    const orderIdInput = document.getElementById('order_id');
    if (orderIdInput) orderIdInput.value = orderId;
    
    // ุชุนุจุฆุฉ ุงูุจูุงูุงุช
    const fields = ['name', 'wilaya', 'product', 'paid', 'total', 'note', 'status', 'phones'];
    fields.forEach(field => {
        const element = document.getElementById('order_' + field);
        if (element) {
            element.value = button.dataset[field] || '';
        }
    });

    showModal('orderModal');
}

function showOrderDetails(orderId) {
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    currentOrderId = orderId;
    const detailsOrderId = document.getElementById('detailsOrderId');
    const assignOrderId = document.getElementById('assign_order_id');
    
    if (detailsOrderId) detailsOrderId.textContent = orderId;
    if (assignOrderId) assignOrderId.value = orderId;
    
    loadOrderDetails(orderId);
    showModal('detailsModal');
}

function loadOrderDetails(orderId) {
    showMobileLoader();
    fetch(`/api/orders/${orderId}/details`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                updateDetailsUI(data);
                loadAutoPerformanceEvaluation(orderId);
                loadPostInstallationIssues(orderId);
            } else {
                showToast('ุฎุทุฃ ูู ุชุญููู ุงูุชูุงุตูู', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading order details:', error);
            showToast('ุฎุทุฃ ูู ุชุญููู ุงูุชูุงุตูู', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
}

function updateDetailsUI(data) {
    if (!data || !data.order) return;
    
    const detailsOrderId = document.getElementById('detailsOrderId');
    const detailsCustomerName = document.getElementById('detailsCustomerName');
    
    if (detailsOrderId) detailsOrderId.textContent = data.order.id;
    if (detailsCustomerName) detailsCustomerName.textContent = data.order.customer_name || 'ุบูุฑ ูุญุฏุฏ';
    
    // ุชุนุจุฆุฉ ุงูุญููู
    const fields = {
        'production_details': data.order.production_details,
        'start_date': data.order.start_date,
        'expected_delivery': data.order.expected_delivery,
        'actual_delivery': data.order.actual_delivery
    };
    
    Object.keys(fields).forEach(field => {
        const element = document.getElementById(field);
        if (element) element.value = fields[field] || '';
    });
    
    updateAssignmentsUI(data.assignments || []);
}

function updateAssignmentsUI(assignments) {
    const container = document.getElementById('currentAssignments');
    if (!container) return;
    
    if (assignments && assignments.length > 0) {
        let html = '';
        assignments.forEach(assignment => {
            const assignmentType = getAssignmentTypeText(assignment.assignment_type);
            
            html += `
                <div class="assignment-item">
                    <div class="assignment-content">
                        <div class="assignment-avatar">
                            ${assignment.worker_name?.charAt(0) || '?'}
                        </div>
                        <div class="assignment-details">
                            <div class="assignment-name">${assignment.worker_name || 'ุบูุฑ ูุนุฑูู'}</div>
                            <div class="assignment-meta">
                                <span class="assignment-type">${assignmentType}</span>
                                <span class="assignment-date">${assignment.assigned_date || ''}</span>
                            </div>
                            ${assignment.notes ? `<div class="assignment-notes">${assignment.notes}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="deassignWorker(${assignment.id})" class="assignment-action">
                        <i class="fas fa-user-times"></i>
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-user-clock"></i>
                <p>ูุง ุชูุฌุฏ ุชุนูููุงุช ุญุงููุฉ</p>
                <p class="text-xs">ุงุณุชุฎุฏู ุงููููุฐุฌ ุฃุฏูุงู ูุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ</p>
            </div>
        `;
    }
}

function getAssignmentTypeText(type) {
    const types = {
        'workshop': 'ูุฑุดุฉ',
        'travel': 'ุณูุฑ',
        'installation': 'ุชุฑููุจ',
        'maintenance': 'ุตูุงูุฉ'
    };
    return types[type] || type;
}

// ุฅุฏุงุฑุฉ ุชุนููู ุงูุนูุงู
document.addEventListener('DOMContentLoaded', function() {
    const assignForm = document.getElementById('assignWorkerForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            assignWorker();
        });
    }
});

function assignWorker() {
    const formData = new FormData();
    const orderId = document.getElementById('assign_order_id');
    const workerId = document.getElementById('assign_worker_id');
    const assignmentType = document.getElementById('assign_type');
    const notes = document.getElementById('assign_notes');
    
    if (!orderId || !workerId || !assignmentType) {
        showToast('ุจูุงูุงุช ุงูุชุนููู ุบูุฑ ููุชููุฉ', 'error');
        return;
    }
    
    formData.append('order_id', orderId.value);
    formData.append('worker_id', workerId.value);
    formData.append('assignment_type', assignmentType.value);
    formData.append('notes', notes?.value || '');
    
    showMobileLoader();
    fetch('/api/orders/assign-worker', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ุชู ุชุนููู ุงูุนุงูู ุจูุฌุงุญ');
            loadOrderDetails(currentOrderId);
            const form = document.getElementById('assignWorkerForm');
            if (form) form.reset();
        } else {
            showToast(data.error || 'ุฎุทุฃ ูู ุงูุชุนููู', 'error');
        }
    })
    .catch(error => {
        console.error('Error assigning worker:', error);
        showToast('ุฎุทุฃ ูู ุงูุชุนููู', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

function deassignWorker(assignmentId) {
    if (!assignmentId) return;
    
    if (confirm('ูู ุชุฑูุฏ ุฅูุบุงุก ุชุนููู ูุฐุง ุงูุนุงููุ')) {
        showMobileLoader();
        fetch(`/api/orders/deassign-worker/${assignmentId}`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('ุชู ุฅูุบุงุก ุงูุชุนููู ุจูุฌุงุญ');
                loadOrderDetails(currentOrderId);
            } else {
                showToast(data.error || 'ุฎุทุฃ ูู ุฅูุบุงุก ุงูุชุนููู', 'error');
            }
        })
        .catch(error => {
            console.error('Error deassigning worker:', error);
            showToast('ุฎุทุฃ ูู ุฅูุบุงุก ุงูุชุนููู', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
    }
}

function saveOrderDetails() {
    const formData = new FormData();
    formData.append('order_id', currentOrderId);
    
    const fields = ['production_details', 'start_date', 'expected_delivery', 'actual_delivery'];
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) formData.append(field, element.value);
    });
    
    showMobileLoader();
    fetch('/api/orders/update-details', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ุชู ุญูุธ ุงูุชูุงุตูู ุจูุฌุงุญ');
            hideModal('detailsModal');
        } else {
            showToast(data.error || 'ุฎุทุฃ ูู ุญูุธ ุงูุชูุงุตูู', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving details:', error);
        showToast('ุฎุทุฃ ูู ุญูุธ ุงูุชูุงุตูู', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// โญ AUTO PERFORMANCE EVALUATION //
// ======================= //

async function loadAutoPerformanceEvaluation(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/auto-evaluation`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateAutoPerformanceUI(data.evaluation);
        }
    } catch (error) {
        console.error('Error loading auto performance evaluation:', error);
    }
}

function updateAutoPerformanceUI(evaluation) {
    if (!evaluation) return;
    
    // ุชุญุฏูุซ ุงูููุงุท ุงูุชููุงุฆูุฉ
    const scores = {
        'autoTimeScore': evaluation.time_score || 0,
        'autoCostScore': evaluation.cost_score || 0,
        'autoQualityScore': evaluation.quality_score || 0,
        'autoWorkerScore': evaluation.worker_score || 0
    };
    
    Object.keys(scores).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = scores[id] + '%';
            // ุชุญุฏูุซ ุงูุฃููุงู ุญุณุจ ุงูููุงุท
            if (scores[id] >= 80) {
                element.className = element.className.replace(/(text-(red|yellow|orange))-600/, 'text-green-600');
            } else if (scores[id] >= 60) {
                element.className = element.className.replace(/(text-(red|green|orange))-600/, 'text-yellow-600');
            } else {
                element.className = element.className.replace(/(text-(green|yellow|orange))-600/, 'text-red-600');
            }
        }
    });
    
    // ุชุญุฏูุซ ุงูุชูููู ุงูููุงุฆู
    const overallScore = evaluation.overall_score || 0;
    const scoreElement = document.getElementById('overall_score');
    const progressElement = document.getElementById('score_progress');
    const summaryElement = document.getElementById('performanceSummary');
    
    if (scoreElement) scoreElement.textContent = overallScore + '%';
    if (progressElement) progressElement.style.width = overallScore + '%';
    
    // ุชุญุฏูุซ ููู ุงูุชูููู ุงูููุงุฆู
    if (overallScore >= 80) {
        scoreElement.className = 'text-2xl font-bold text-green-600';
        progressElement.className = 'h-2 rounded-full bg-green-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'ุฃุฏุงุก ููุชุงุฒ - ุงูุทูุจูุฉ ุชุณูุฑ ุจุดูู ุฌูุฏ';
    } else if (overallScore >= 60) {
        scoreElement.className = 'text-2xl font-bold text-yellow-600';
        progressElement.className = 'h-2 rounded-full bg-yellow-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'ุฃุฏุงุก ููุจูู - ููุงู ูุฌุงู ููุชุญุณูู';
    } else {
        scoreElement.className = 'text-2xl font-bold text-red-600';
        progressElement.className = 'h-2 rounded-full bg-red-500 transition-all duration-500';
        if (summaryElement) summaryElement.textContent = 'ุฃุฏุงุก ูุญุชุงุฌ ุชุญุณูู - ููุงู ูุดุงูู ุชุญุชุงุฌ ุงููุนุงูุฌุฉ';
    }
    
    // ุชุญุฏูุซ ุชุญููู ุงูุฃุฏุงุก
    updatePerformanceInsights(evaluation.insights || []);
}

function updatePerformanceInsights(insights) {
    const container = document.getElementById('performanceInsights');
    if (!container) return;
    
    if (insights && insights.length > 0) {
        let html = '';
        insights.forEach(insight => {
            const icon = getInsightIcon(insight.type);
            const color = getInsightColor(insight.severity);
            
            html += `
                <div class="flex items-start gap-2 p-2 bg-white rounded-lg border ${color}">
                    <i class="fas fa-${icon} mt-1 text-sm"></i>
                    <div class="flex-1">
                        <div class="text-sm font-medium">${insight.title}</div>
                        <div class="text-xs text-gray-600">${insight.description}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-bar"></i>
                <p>ูุง ุชูุฌุฏ ุชุญูููุงุช ุญุงููุงู</p>
            </div>
        `;
    }
}

function getInsightIcon(type) {
    const icons = {
        'time': 'clock',
        'cost': 'money-bill-wave',
        'quality': 'star',
        'worker': 'user',
        'material': 'box',
        'transport': 'truck'
    };
    return icons[type] || 'info-circle';
}

function getInsightColor(severity) {
    const colors = {
        'high': 'border-red-200 bg-red-50',
        'medium': 'border-yellow-200 bg-yellow-50',
        'low': 'border-green-200 bg-green-50',
        'info': 'border-blue-200 bg-blue-50'
    };
    return colors[severity] || 'border-gray-200 bg-gray-50';
}

function refreshAutoEvaluation() {
    if (!currentOrderId) return;
    
    showMobileLoader();
    fetch(`/api/orders/${currentOrderId}/refresh-evaluation`, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ุชู ุชุญุฏูุซ ุงูุชูููู ุงูุชููุงุฆู ุจูุฌุงุญ');
            loadAutoPerformanceEvaluation(currentOrderId);
        } else {
            showToast('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุชูููู', 'error');
        }
    })
    .catch(error => {
        console.error('Error refreshing evaluation:', error);
        showToast('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุชูููู', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// โ๏ธ POST-INSTALLATION ISSUES SYSTEM //
// ======================= //

async function loadPostInstallationIssues(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}/post-installation-issues`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updatePostInstallationIssuesUI(data.issues);
            updateRootCauseAnalysis(data.analysis);
        }
    } catch (error) {
        console.error('Error loading post-installation issues:', error);
    }
}

function updatePostInstallationIssuesUI(issues) {
    const container = document.getElementById('postInstallationIssues');
    if (!container) return;
    
    if (issues && issues.length > 0) {
        let html = '';
        issues.forEach(issue => {
            const severityColor = getIssueSeverityColor(issue.severity);
            const statusIcon = issue.resolved ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
            
            html += `
                <div class="issue-item p-3 bg-white rounded-lg border border-gray-200 mb-2">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-medium">${issue.type}</span>
                            <span class="text-xs ${severityColor} ml-2 px-2 py-1 rounded-full">${getSeverityText(issue.severity)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas ${statusIcon}"></i>
                            <span class="text-xs text-gray-500">${formatDate(issue.issue_date)}</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${issue.description}</div>
                    ${issue.cause ? `<div class="text-xs text-gray-500 mb-1"><strong>ุงูุณุจุจ:</strong> ${issue.cause}</div>` : ''}
                    ${issue.solution ? `<div class="text-xs text-green-600"><strong>ุงูุญู:</strong> ${issue.solution}</div>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tools"></i>
                <p>ูุง ุชูุฌุฏ ูุดุงูู ูุณุฌูุฉ</p>
            </div>
        `;
    }
}

function updateRootCauseAnalysis(analysis) {
    const container = document.getElementById('rootCauseAnalysis');
    if (!container) return;
    
    if (analysis && analysis.issues_count > 0) {
        let html = `
            <div class="mb-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">ุชุญููู ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉ</span>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${analysis.issues_count} ูุดููุฉ</span>
                </div>
        `;
        
        if (analysis.common_causes && analysis.common_causes.length > 0) {
            html += `<div class="space-y-1">`;
            analysis.common_causes.forEach(cause => {
                html += `
                    <div class="flex items-center gap-2 text-sm">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        <span>${cause}</span>
                    </div>
                `;
            });
                        html += `</div>`;
        }
        
        if (analysis.recommendations && analysis.recommendations.length > 0) {
            html += `<div class="mt-3 pt-2 border-t border-yellow-200">`;
            analysis.recommendations.forEach(rec => {
                html += `
                    <div class="flex items-center gap-2 text-sm text-green-700">
                        <i class="fas fa-lightbulb"></i>
                        <span>${rec}</span>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        html += `</div>`;
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <p class="text-sm text-yellow-800 text-center">ุณูุธูุฑ ุชุญููู ุงูุฃุณุจุงุจ ููุง ุนูุฏ ุชุณุฌูู ุงููุดุงูู</p>
        `;
    }
}

function getIssueSeverityColor(severity) {
    const colors = {
        'critical': 'bg-red-100 text-red-800',
        'high': 'bg-orange-100 text-orange-800',
        'medium': 'bg-yellow-100 text-yellow-800',
        'low': 'bg-green-100 text-green-800'
    };
    return colors[severity] || 'bg-gray-100 text-gray-800';
}

function getSeverityText(severity) {
    const texts = {
        'critical': 'ุญุฑุฌุฉ',
        'high': 'ุนุงููุฉ',
        'medium': 'ูุชูุณุทุฉ',
        'low': 'ููุฎูุถุฉ'
    };
    return texts[severity] || 'ุบูุฑ ูุญุฏุฏ';
}

function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG');
    } catch {
        return dateString;
    }
}

function showIssueReportModal() {
    if (!currentOrderId) {
        showToast('ูุฑุฌู ุชุญุฏูุฏ ุทูุจูุฉ ุฃููุงู', 'error');
        return;
    }
    
    const issueOrderId = document.getElementById('issue_order_id');
    if (issueOrderId) issueOrderId.value = currentOrderId;
    
    // ุชุนููู ุชุงุฑูุฎ ุงูููู ูุงูุชุฑุงุถู
    const issueDate = document.getElementById('issue_date');
    if (issueDate) {
        const today = new Date().toISOString().split('T')[0];
        issueDate.value = today;
    }
    
    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
    const form = document.getElementById('issueReportForm');
    if (form) form.reset();
    
    showModal('issueReportModal');
}

// ุฅุฏุงุฑุฉ ูููุฐุฌ ุชุณุฌูู ุงููุดุงูู
document.addEventListener('DOMContentLoaded', function() {
    const issueForm = document.getElementById('issueReportForm');
    if (issueForm) {
        issueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitIssueReport();
        });
    }
});

function submitIssueReport() {
    const formData = new FormData();
    formData.append('order_id', currentOrderId);
    
    const fields = ['issue_type', 'issue_severity', 'issue_description', 'issue_cause', 'issue_solution', 'issue_date', 'estimated_repair_time'];
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) formData.append(field, element.value);
    });
    
    const resolved = document.querySelector('input[name="issue_resolved"]:checked');
    if (resolved) {
        formData.append('resolved', resolved.value);
    }
    
    showMobileLoader();
    fetch('/api/orders/report-issue', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ุชู ุชุณุฌูู ุงููุดููุฉ ุจูุฌุงุญ');
            hideModal('issueReportModal');
            loadPostInstallationIssues(currentOrderId);
            refreshAutoEvaluation(); // ุชุญุฏูุซ ุงูุชูููู ุงูุชููุงุฆู
        } else {
            showToast(data.error || 'ุฎุทุฃ ูู ุชุณุฌูู ุงููุดููุฉ', 'error');
        }
    })
    .catch(error => {
        console.error('Error reporting issue:', error);
        showToast('ุฎุทุฃ ูู ุชุณุฌูู ุงููุดููุฉ', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// ๐ฐ PAYMENT MANAGEMENT   //
// ======================= //

function showPaymentModal(orderId, remaining) {
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    currentOrderId = orderId;
    currentRemaining = parseFloat(remaining) || 0;
    
    const paymentOrderId = document.getElementById('payment_order_id');
    const remainingAmount = document.getElementById('remainingAmount');
    const paymentAmount = document.getElementById('payment_amount');
    
    if (paymentOrderId) paymentOrderId.value = orderId;
    if (remainingAmount) remainingAmount.textContent = currentRemaining.toFixed(2);
    if (paymentAmount) {
        paymentAmount.value = '';
        paymentAmount.max = currentRemaining;
    }
    
    showModal('paymentModal');
}

// ุฅุฏุงุฑุฉ ูููุฐุฌ ุงูุฏูุน
document.addEventListener('DOMContentLoaded', function() {
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitPayment();
        });
    }
});

function submitPayment() {
    const paymentAmount = document.getElementById('payment_amount');
    const amount = parseFloat(paymentAmount?.value) || 0;
    
    if (amount <= 0) {
        showToast('ูุฑุฌู ุฅุฏุฎุงู ูุจูุบ ุฏูุนุฉ ุตุญูุญ', 'error');
        return;
    }
    
    if (amount > currentRemaining) {
        showToast('ุงููุจูุบ ุงููุฏุฎู ุฃูุจุฑ ูู ุงููุจูุบ ุงููุชุจูู', 'error');
        return;
    }
    
    const formData = new FormData(document.getElementById('paymentForm'));
    
    showMobileLoader();
    fetch(`/orders/payment/${currentOrderId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('ุชู ุฅุถุงูุฉ ุงูุฏูุนุฉ ุจูุฌุงุญ');
            hideModal('paymentModal');
            
            // ุชุญุฏูุซ ุงูุตู
            updateOrderRow(currentOrderId, {
                new_paid: data.new_paid,
                new_remaining: data.new_remaining,
                is_paid: data.is_paid
            });
            
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            updateStatisticsAfterPayment(data.new_paid, data.new_remaining);
            
        } else {
            showToast(data.error || 'ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฏูุนุฉ', 'error');
        }
    })
    .catch(error => {
        console.error('Payment error:', error);
        showToast('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฏูุนุฉ', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

function updateOrderRow(orderId, newData) {
    const row = document.querySelector(`tr[data-order-id="${orderId}"], .md\\:hidden .order-card[data-order-id="${orderId}"]`);
    
    if (row) {
        // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุชุญุฏูุซ
        row.classList.add('order-row-updating');
        
        // ุชุญุฏูุซ ุงููุจูุบ ุงููุฏููุน
        if (newData.new_paid !== undefined) {
            const paidElements = row.querySelectorAll('.text-green-600');
            paidElements.forEach(el => {
                if (el.textContent.includes('ุฏุฌ') && el.textContent.includes('ุงููุฏููุน')) {
                    el.innerHTML = `<span class="font-bold text-lg text-green-600">${newData.new_paid.toFixed(0)}</span><span class="text-xs text-green-600 block">ุฏุฌ</span>`;
                }
            });
        }
        
        // ุชุญุฏูุซ ุงููุจูุบ ุงููุชุจูู
        if (newData.new_remaining !== undefined) {
            const remainingElements = row.querySelectorAll('td:nth-child(8), .bg-gray-50 .text-center:nth-child(3)');
            remainingElements.forEach(el => {
                if (el.textContent.includes('ุฏุฌ')) {
                    if (newData.new_remaining > 0) {
                        el.innerHTML = `<span class="font-semibold text-red-600">${newData.new_remaining.toFixed(0)} ุฏุฌ</span>`;
                    } else {
                        el.innerHTML = `<span class="font-semibold text-green-600">0 ุฏุฌ</span>`;
                    }
                }
            });
            
            // ุชุญุฏูุซ ุญุงูุฉ ุงูุตุญุฉ ุงููุงููุฉ
            const healthStatusElements = row.querySelectorAll('td:nth-child(10), .flex-col .bg-green-100, .flex-col .bg-red-100');
            healthStatusElements.forEach(el => {
                if (newData.new_remaining <= 0) {
                    el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                        <i class="fas fa-check-circle ml-1"></i>
                        ุณูููุฉ
                    </span>`;
                    row.dataset.healthStatus = 'healthy';
                } else {
                    el.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                        <i class="fas fa-exclamation-triangle ml-1"></i>
                        ุจูุง ุฏููู
                    </span>`;
                    row.dataset.healthStatus = 'debt';
                }
            });
            
            // ุฅุฎูุงุก ุฒุฑ ุงูุฏูุน ุฅุฐุง ุชู ุงูุณุฏุงุฏ ุจุงููุงูู
            const paymentButton = row.querySelector('.payment-btn');
            if (paymentButton && newData.new_remaining <= 0) {
                paymentButton.style.display = 'none';
            }
        }
        
        // ุฅุฒุงูุฉ ุชุฃุซูุฑ ุงูุชุญุฏูุซ ุจุนุฏ ูุชุฑุฉ
        setTimeout(() => {
            row.classList.remove('order-row-updating');
        }, 1000);
        
        // ุฅุนุงุฏุฉ ุชุทุจูู ุงูููุงุชุฑ
        reapplyFiltersToRow(row);
    }
}

function updateStatisticsAfterPayment(newPaid, newRemaining) {
    // ุชุญุฏูุซ ุจุทุงูุฉ ุงููุฏููุน
    const paidCard = document.querySelector('.bg-gradient-to-r.from-green-500.to-green-600 .text-2xl');
    if (paidCard) {
        const currentPaid = parseFloat(paidCard.textContent.replace(' ุฏุฌ', '')) || 0;
        paidCard.textContent = (currentPaid + newPaid).toFixed(0) + ' ุฏุฌ';
    }
    
    // ุชุญุฏูุซ ุจุทุงูุฉ ุงููุชุจูู
    const remainingCard = document.querySelector('.bg-gradient-to-r.from-indigo-500.to-indigo-600 .text-2xl');
    if (remainingCard) {
        const currentRemaining = parseFloat(remainingCard.textContent.replace(' ุฏุฌ', '')) || 0;
        remainingCard.textContent = (currentRemaining - newPaid).toFixed(0) + ' ุฏุฌ';
    }
    
    // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุทูุจูุงุช ุงูุณูููุฉ
    updateOrdersHealthStats();
}

// ======================= //
// ๐ HEALTH STATISTICS    //
// ======================= //

function updateOrdersHealthStats() {
    const rows = document.querySelectorAll('#ordersTable tr[data-order-id], .md\\:hidden .order-card');
    let healthyCount = 0;
    let debtCount = 0;
    let totalDebt = 0;
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const healthStatus = row.dataset.healthStatus;
            if (healthStatus === 'healthy') {
                healthyCount++;
            } else if (healthStatus === 'debt') {
                debtCount++;
                // ุญุณุงุจ ุฅุฌูุงูู ุงูุฏููู
                const remainingElement = row.querySelector('td:nth-child(8), .bg-gray-50 .text-center:nth-child(3)');
                if (remainingElement) {
                    const remainingText = remainingElement.textContent;
                    const remainingAmount = parseFloat(remainingText.replace(' ุฏุฌ', '')) || 0;
                    totalDebt += remainingAmount;
                }
            }
        }
    });
    
    // ุชุญุฏูุซ ุงูุจุทุงูุงุช
    const healthyOrdersCount = document.getElementById('healthyOrdersCount');
    const ordersDebtsTotal = document.getElementById('ordersDebtsTotal');
    const affectedOrdersCount = document.getElementById('affectedOrdersCount');
    
    if (healthyOrdersCount) healthyOrdersCount.textContent = healthyCount;
    if (ordersDebtsTotal) ordersDebtsTotal.textContent = totalDebt.toFixed(0) + ' ุฏุฌ';
    if (affectedOrdersCount) affectedOrdersCount.textContent = debtCount;
}

// ======================= //
// ๐ HISTORY SYSTEM       //
// ======================= //

async function showHistory(orderId) {
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    showMobileLoader();
    
    try {
        const response = await fetch(`/orders/history/${orderId}`);
        if (!response.ok) throw new Error('Network error');
        
        const historyData = await response.json();
        
        console.log('๐ ุจูุงูุงุช ุงูุณุฌู ุงููุณุชููุฉ:', historyData);
        
        const historyOrderId = document.getElementById('historyOrderId');
        if (historyOrderId) historyOrderId.textContent = orderId;
        
        if (historyData.order_info) {
            updateHistoryStatistics(historyData.order_info);
        }
        
        // ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุนุงูููุฉ
        window.originalHistoryData = historyData.history || [];
        window.currentHistoryData = [...window.originalHistoryData];
        
        console.log(`โ ุชู ุชุญููู ${window.originalHistoryData.length} ุณุฌู`);
        
        // ุชุญููู ุจูุงูุงุช ุงูุฏููู
        try {
            const debtsResponse = await fetch(`/api/orders/${orderId}/debts`);
            if (debtsResponse.ok) {
                const debtsData = await debtsResponse.json();
                
                if (debtsData.success && debtsData.debts_info.has_debts) {
                    // ุฅุถุงูุฉ ุณุฌูุงุช ุงูุฏููู ููุจูุงูุงุช ุงูุฃุตููุฉ
                    debtsData.debts_info.debt_records.forEach(debt => {
                        const debtRecord = {
                            change_type: "ุฏูู",
                            details: `${debt.type}: ${debt.description} - ุงููุจูุบ: ${debt.debt_amount} ุฏุฌ - ุงููุฏููุน: ${debt.paid_amount} ุฏุฌ - ุงููุชุจูู: ${debt.remaining} ุฏุฌ`,
                            timestamp: debt.date,
                            user: "ุงููุธุงู",
                            debt_data: debt,
                            is_debt: true
                        };
                        window.originalHistoryData.push(debtRecord);
                    });
                    
                    console.log(`โ ุชู ุฅุถุงูุฉ ${debtsData.debts_info.debt_records.length} ุณุฌู ุฏููู`);
                }
            }
        } catch (debtError) {
            console.error('Error loading debts:', debtError);
        }
        
        // ุชุญุฏูุซ ุงููุงุฌูุฉ
        updateUnifiedHistoryUI(window.currentHistoryData);
        
        // ุฅุนุฏุงุฏ ุงูููุงุชุฑ
        setupEnhancedHistoryFilters();
        resetHistoryFilters(true);
        
        // ุจุฏุก ูุฑุงูุจุฉ ุชุญุฏูุซุงุช ุงูุฏููู
        startDebtMonitoring(orderId);
        
        showModal('historyModal');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู:', error);
        showToast('ุฎุทุฃ ูู ุชุญููู ุงูุณุฌู', 'error');
        updateUnifiedHistoryUI([]);
    } finally {
        hideMobileLoader();
    }
}

function updateHistoryStatistics(orderInfo) {
    if (!orderInfo) return;
    
    const total = orderInfo.total_amount || 0;
    const paid = orderInfo.paid_amount || 0;
    const remaining = orderInfo.remaining_amount || 0;
    const costs = orderInfo.total_costs || 0;
    const profit = total - costs;
    const profitPercentage = total > 0 ? (profit / total) * 100 : 0;
    const costPercentage = total > 0 ? (costs / total) * 100 : 0;
    
    // ุชุญุฏูุซ ุงูุนูุงุตุฑ
    const elements = {
        'historyTotalAmount': total.toFixed(0) + ' ุฏุฌ',
        'historyPaidAmount': paid.toFixed(0) + ' ุฏุฌ',
        'historyRemainingAmount': remaining.toFixed(0) + ' ุฏุฌ',
        'historyCostAmount': costs.toFixed(0) + ' ุฏุฌ',
        'historyProfitAmount': profit.toFixed(0) + ' ุฏุฌ',
        'historyProfitPercentage': profitPercentage.toFixed(1) + '%',
        'costPercentage': costPercentage.toFixed(1) + '%',
        'profitPercentage': profitPercentage.toFixed(1) + '%'
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = elements[id];
    });
    
    // ุชุญุฏูุซ ุฃุดุฑุทุฉ ุงูุชูุฏู
    const costBar = document.getElementById('costBar');
    const profitBar = document.getElementById('profitBar');
    
    if (costBar) costBar.style.width = costPercentage + '%';
    if (profitBar) {
        profitBar.style.width = profitPercentage + '%';
        profitBar.style.left = costPercentage + '%';
    }
}

// ======================= //
// ๐ ENHANCED HISTORY FILTERS //
// ======================= //

function setupEnhancedHistoryFilters() {
    console.log('๐ฏ ุชููุฆุฉ ุงูููุงุชุฑ ุงูุฐููุฉ ุงููุญุณูุฉ...');
    
    const userFilter = document.getElementById('historyUserFilter');
    const typeFilter = document.getElementById('historyTypeFilter');
    const searchText = document.getElementById('historySearchText');
    const dateFrom = document.getElementById('historyDateFrom');
    const dateTo = document.getElementById('historyDateTo');
    
    // ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงููุณุชูุนูู
    [userFilter, typeFilter, searchText, dateFrom, dateTo].forEach(element => {
        if (element) {
            element.replaceWith(element.cloneNode(true));
        }
    });
    
    // ุงูุญุตูู ุนูู ุงูุนูุงุตุฑ ุงูุฌุฏูุฏุฉ
    const newUserFilter = document.getElementById('historyUserFilter');
    const newTypeFilter = document.getElementById('historyTypeFilter');
    const newSearchText = document.getElementById('historySearchText');
    const newDateFrom = document.getElementById('historyDateFrom');
    const newDateTo = document.getElementById('historyDateTo');
    
    // ุฅุนุฏุงุฏ ุงููุณุชูุนูู ุงูุฌุฏุฏ
    if (newUserFilter) {
        newUserFilter.addEventListener('change', function() {
            console.log('๐ค ุชุบููุฑ ููุชุฑ ุงููุณุชุฎุฏู:', this.value);
            historyFiltersState.user = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newTypeFilter) {
        newTypeFilter.addEventListener('change', function() {
            console.log('๐ฏ ุชุบููุฑ ููุชุฑ ุงูููุน:', this.value);
            historyFiltersState.type = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newSearchText) {
        newSearchText.addEventListener('input', function() {
            historyFiltersState.searchText = this.value.toLowerCase().trim();
            applySmartHistoryFilters();
        });
    }
    
    if (newDateFrom) {
        newDateFrom.addEventListener('change', function() {
            historyFiltersState.dateFrom = this.value;
            applySmartHistoryFilters();
        });
    }
    
    if (newDateTo) {
        newDateTo.addEventListener('change', function() {
            historyFiltersState.dateTo = this.value;
            applySmartHistoryFilters();
        });
    }
    
    // ุชุญููู ุงููุณุชุฎุฏููู ููููุชุฑ
    loadRealUsersForFilter();
    
    console.log('โ ุชู ุชููุฆุฉ ุงูููุงุชุฑ ุจูุฌุงุญ');
}

function applySmartHistoryFilters() {
    console.log('๐ฏ ุชุทุจูู ุงูููุงุชุฑ:', historyFiltersState);
    
    if (!window.originalHistoryData || window.originalHistoryData.length === 0) {
        console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุตููุฉ ููุชุตููุฉ');
        return;
    }
    
    const filteredData = window.originalHistoryData.filter(item => {
        // โ ููุชุฑุฉ ุงููุณุชุฎุฏู
        if (historyFiltersState.user && historyFiltersState.user !== '') {
            const userName = extractReliableUserName(item);
            if (userName !== historyFiltersState.user) {
                return false;
            }
        }
        
        // โ ููุชุฑุฉ ุงูููุน
        if (historyFiltersState.type && historyFiltersState.type !== '') {
            const itemType = getSmartItemType(item);
            if (itemType !== historyFiltersState.type) {
                return false;
            }
        }
        
        // โ ููุชุฑุฉ ุงูุชุงุฑูุฎ
        if (historyFiltersState.dateFrom || historyFiltersState.dateTo) {
            const itemDate = new Date(item.timestamp);
            
            if (historyFiltersState.dateFrom) {
                const fromDate = new Date(historyFiltersState.dateFrom);
                if (itemDate < fromDate) return false;
            }
            
            if (historyFiltersState.dateTo) {
                const toDate = new Date(historyFiltersState.dateTo);
                toDate.setHours(23, 59, 59, 999);
                if (itemDate > toDate) return false;
            }
        }
        
        // โ ููุชุฑุฉ ุงููุต
        if (historyFiltersState.searchText && historyFiltersState.searchText.trim() !== '') {
            const searchableText = [
                item.details || '',
                item.description || '',
                item.change_type || '',
                extractReliableUserName(item)
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(historyFiltersState.searchText.toLowerCase())) {
                return false;
            }
        }
        
        return true;
    });
    
    console.log(`๐ ูุชุงุฆุฌ ุงูููุชุฑุฉ: ${filteredData.length} ูู ${window.originalHistoryData.length}`);
    
    // โ ุชุญุฏูุซ ุงูุจูุงูุงุช ูุงูุนุฑุถ
    window.currentHistoryData = filteredData;
    updateUnifiedHistoryUI(window.currentHistoryData);
    updateFilterStats(filteredData.length, window.originalHistoryData.length);
}

function getSmartItemType(item) {
    if (!item) return 'other';
    
    const changeType = (item.change_type || '').toLowerCase();
    const details = (item.details || '').toLowerCase();
    
    console.log('๐ ุชุญููู ููุน ุงูุนูููุฉ:', { changeType, details });
    
    // โ ุงูุชุนุฑู ุนูู ุงูุฏููู
    if (changeType.includes('ุฏูู') || details.includes('ุฏูู') || item.is_debt || item.debt_data) {
        return 'ุฏููู';
    }
    // โ ุงูุชุนุฑู ุนูู ุงููุดุงูู
    else if (changeType.includes('ูุดููุฉ') || details.includes('ูุดููุฉ') || details.includes('ุฅุตูุงุญ')) {
        return 'ูุดููุฉ';
    }
    // ุจุงูู ุงูุฃููุงุน
    else if (changeType.includes('ุฏูุนุฉ') || details.includes('ุฏูุนุฉ') || details.includes('ุฏูุน')) {
        return 'ุฏูุนุฉ';
    }
    else if (changeType.includes('ูุตุฑูู') || details.includes('ูุตุฑูู') || details.includes('ุชูููุฉ')) {
        return 'ูุตุฑูู';
    }
    else if (changeType.includes('ููู') || details.includes('ููู') || details.includes('ุดุญู')) {
        return 'ููู';
    }
    else if (changeType.includes('ุชุนููู') || details.includes('ุนุงูู') || details.includes('ุนูุงู')) {
        return 'ุชุนููู';
    }
    else if (changeType.includes('ุชุนุฏูู') || details.includes('ุชุนุฏูู') || details.includes('ุชุบููุฑ')) {
        return 'ุชุนุฏูู';
    }
    else if (changeType.includes('ุฅูุดุงุก') || details.includes('ุฅูุดุงุก') || details.includes('ุฌุฏูุฏ')) {
        return 'ุฅูุดุงุก';
    }
    else if (changeType.includes('ุญุฐู') || details.includes('ุญุฐู') || details.includes('ูุณุญ')) {
        return 'ุญุฐู';
    }
    else if (changeType.includes('ุชูููู') || details.includes('ุชูููู') || details.includes('ุชูููู')) {
        return 'ุชูููู';
    }
    else {
        return 'ุฃุฎุฑู';
    }
}

function updateFilterStats(filteredCount, totalCount) {
    const statsElement = document.getElementById('filterStats');
    if (!statsElement) return;
    
    if (filteredCount === totalCount) {
        statsElement.textContent = `ุนุฑุถ ${totalCount} ุนูููุฉ`;
        statsElement.className = 'text-green-600 font-medium text-xs';
    } else {
        const percentage = ((filteredCount / totalCount) * 100).toFixed(1);
        statsElement.textContent = `ุนุฑุถ ${filteredCount} ูู ${totalCount} ุนูููุฉ (${percentage}%)`;
        statsElement.className = 'text-blue-600 font-medium text-xs';
    }
}

function resetHistoryFilters(silent = false) {
    console.log('๐ ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุชุฑ');
    
    // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูููุงุชุฑ
    Object.keys(historyFiltersState).forEach(key => {
        historyFiltersState[key] = '';
    });
    
    // ุฅุนุงุฏุฉ ุชุนููู ูุงุฌูุฉ ุงููุณุชุฎุฏู
    const elements = {
        'historyUserFilter': '',
        'historyTypeFilter': '',
        'historySearchText': '',
        'historyDateFrom': '',
        'historyDateTo': ''
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = elements[id];
    });
    
    // โ ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ูู ุงูุฃุตููุฉ
    if (window.originalHistoryData) {
        window.currentHistoryData = [...window.originalHistoryData];
        updateUnifiedHistoryUI(window.currentHistoryData);
        updateFilterStats(window.currentHistoryData.length, window.originalHistoryData.length);
    }
    
    if (!silent) {
        showToast('ุชู ูุณุญ ุฌููุน ุงูููุงุชุฑ ูุนุฑุถ ุฌููุน ุงูุณุฌูุงุช', 'success');
    }
    
    console.log('โ ุชู ุฅุนุงุฏุฉ ุงูุชุนููู ุจูุฌุงุญ');
}

function toggleAdvancedFilters() {
    const advancedFilters = document.getElementById('advancedFilters');
    const toggleBtn = document.querySelector('[onclick="toggleAdvancedFilters()"]');
    
    if (!advancedFilters || !toggleBtn) return;
    
    if (advancedFilters.classList.contains('hidden')) {
        advancedFilters.classList.remove('hidden');
        toggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i> ููุงุชุฑ ุจุณูุทุฉ';
    } else {
        advancedFilters.classList.add('hidden');
        toggleBtn.innerHTML = '<i class="fas fa-sliders-h"></i> ููุงุชุฑ ูุชูุฏูุฉ';
    }
}

function exportFilteredHistory() {
    if (!window.currentHistoryData || window.currentHistoryData.length === 0) {
        showToast('ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ', 'warning');
        return;
    }
    
    const filteredData = window.currentHistoryData.filter(item => {
        if (historyFiltersState.user && !checkUserFilter(item, historyFiltersState.user)) return false;
        if (historyFiltersState.type && !checkTypeFilter(item, historyFiltersState.type)) return false;
        if (historyFiltersState.dateFrom || historyFiltersState.dateTo) {
            if (!checkDateFilter(item, historyFiltersState.dateFrom, historyFiltersState.dateTo)) return false;
        }
        if (historyFiltersState.searchText && !checkTextFilter(item, historyFiltersState.searchText)) return false;
        return true;
    });
    
    if (filteredData.length === 0) {
        showToast('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุทุงุจูุฉ ููููุชุฑ', 'warning');
        return;
    }
    
    // ุฅูุดุงุก ูุญุชูู CSV
    let csvContent = "ุชุงุฑูุฎ,ููุน ุงูุนูููุฉ,ุงูุชูุงุตูู,ุงููุณุชุฎุฏู\n";
    
    filteredData.forEach(item => {
        const date = formatHistoryDate(item.timestamp);
        const type = getSmartItemType(item);
        const details = cleanDescription(item.details || item.description || '');
        const user = extractReliableUserName(item);
        
        csvContent += `"${date}","${type}","${details}","${user}"\n`;
    });
    
    // ุชุญููู ุงูููู
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    link.setAttribute("href", url);
    link.setAttribute("download", `ุณุฌู_ุงูุทูุจูุฉ_${currentOrderId}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast(`ุชู ุชุตุฏูุฑ ${filteredData.length} ุนูููุฉ`, 'success');
}

function clearAllFilters() {
    resetHistoryFilters();
}

// ======================= //
// ๐ฏ ENHANCED HISTORY DISPLAY //
// ======================= //

function updateUnifiedHistoryUI(history) {
    const container = document.getElementById('unifiedHistoryContent');
    const statsElement = document.getElementById('historyStats');
    
    if (!container) return;
    
    // โ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูููุฑุฑุฉ ูุจุงุดุฑุฉ
    const displayData = Array.isArray(history) ? history : [];
    
    if (displayData.length > 0) {
        let html = '';
        
        displayData.forEach((item, index) => {
            const userName = extractReliableUserName(item);
            const itemType = getSmartItemType(item);
            const itemIcon = getSmartHistoryIcon(item);
            const itemColor = getSmartHistoryColor(itemType);
            
            // โ ูุนุงูุฌุฉ ุฎุงุตุฉ ููุฏููู
            if (item.change_type === "ุฏูู" || item.is_debt || item.debt_data) {
                const debt = item.debt_data;
                const status = debt.status === 'paid' ? 'ูุฏููุน' : 'ุบูุฑ ูุฏููุน';
                const statusColor = debt.status === 'paid' ? 'text-green-600' : 'text-red-600';
                const statusBadge = debt.status === 'paid' ? 'badge-success' : 'badge-danger';
                
                html += `
                    <div class="history-item history-item-debt">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas fa-file-invoice-dollar ${statusColor}"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">ุฏูู ${debt.type}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">
                                    <strong>${debt.description}</strong>
                                    <div class="grid grid-cols-3 gap-2 mt-2 text-xs">
                                        <div class="text-center">
                                            <div class="text-gray-600">ุงููุจูุบ</div>
                                            <div class="font-bold text-red-600">${debt.debt_amount} ุฏุฌ</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-gray-600">ุงููุฏููุน</div>
                                            <div class="font-bold text-green-600">${debt.paid_amount} ุฏุฌ</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-gray-600">ุงููุชุจูู</div>
                                            <div class="font-bold text-orange-600">${debt.remaining} ุฏุฌ</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        ุงููุธุงู
                                    </div>
                                    <span class="history-badge ${statusBadge}">
                                        ${status}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } 
            // โ ูุนุงูุฌุฉ ุฎุงุตุฉ ูููุดุงูู
            else if (itemType === 'ูุดููุฉ') {
                const severity = item.severity || 'medium';
                const severityColor = getIssueSeverityColor(severity);
                const resolved = item.resolved || false;
                const statusIcon = resolved ? 'fa-check-circle text-green-500' : 'fa-exclamation-circle text-red-500';
                
                html += `
                    <div class="history-item history-item-issue">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas fa-exclamation-triangle text-orange-500"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">ูุดููุฉ ${item.issue_type}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">
                                    <strong>${item.issue_description}</strong>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-xs ${severityColor} px-2 py-1 rounded-full">${getSeverityText(severity)}</span>
                                        <i class="fas ${statusIcon}"></i>
                                    </div>
                                    ${item.issue_cause ? `<div class="text-xs text-gray-600 mt-1"><strong>ุงูุณุจุจ:</strong> ${item.issue_cause}</div>` : ''}
                                    ${item.issue_solution ? `<div class="text-xs text-green-600 mt-1"><strong>ุงูุญู:</strong> ${item.issue_solution}</div>` : ''}
                                </div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        ${userName}
                                    </div>
                                    <span class="history-badge ${resolved ? 'badge-success' : 'badge-warning'}">
                                        ${resolved ? 'ุชู ุงูุฅุตูุงุญ' : 'ููุฏ ุงููุนุงูุฌุฉ'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            else {
                // ุงูุจููุฉ ุงูุนุงุฏูุฉ ููุนูุงุตุฑ ุงูุฃุฎุฑู
                html += `
                    <div class="history-item ${itemColor}" 
                         data-type="${itemType}" 
                         data-user="${userName}"
                         data-date="${item.timestamp}">
                        <div class="history-content">
                            <div class="history-icon">
                                <i class="fas ${itemIcon}"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-header">
                                    <div class="history-title">${getActionTitle(item)}</div>
                                    <div class="history-date">${formatHistoryDate(item.timestamp)}</div>
                                </div>
                                <div class="history-description">${cleanDescription(item.details || item.description)}</div>
                                <div class="history-footer">
                                    <div class="history-user">
                                        <i class="fas fa-user"></i>
                                        ุจูุงุณุทุฉ: ${userName}
                                    </div>
                                    <span class="history-badge ${getTypeBadgeColor(itemType)}">
                                        ${getTypeArabicName(itemType)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        if (statsElement) {
            statsElement.textContent = `${displayData.length} ุนูููุฉ`;
        }
        
        // โ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ูุงูุฃุตููุฉ
        if (window.originalHistoryData) {
            updateFilterStats(displayData.length, window.originalHistoryData.length);
        }
        
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>ูุง ุชูุฌุฏ ุณุฌูุงุช ููุนุฑุถ</p>
                ${window.originalHistoryData && window.originalHistoryData.length > 0 ? 
                  '<p class="text-sm text-gray-400 mt-1">ุฌุฑุจ ุชุนุฏูู ุงูููุงุชุฑ ูุนุฑุถ ุงููุฒูุฏ ูู ุงููุชุงุฆุฌ</p>' : 
                  '<p class="text-sm text-gray-400 mt-1">ูุง ุชูุฌุฏ ุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</p>'}
            </div>
        `;
        if (statsElement) {
            statsElement.textContent = '0 ุนูููุฉ';
        }
        if (window.originalHistoryData) {
            updateFilterStats(0, window.originalHistoryData.length);
        }
    }
}

function getActionTitle(item) {
    const changeType = item.change_type || '';
    if (changeType) return changeType;
    
    const type = getSmartItemType(item);
    const typeTitles = {
        'ุฏูุนุฉ': 'ุฏูุนุฉ ูุงููุฉ',
        'ูุตุฑูู': 'ูุตุฑูู',
        'ููู': 'ุชูููุฉ ููู',
        'ุชุนููู': 'ุชุนููู ุนุงูู',
        'ุชุนุฏูู': 'ุชุนุฏูู',
        'ุฅูุดุงุก': 'ุฅูุดุงุก ุทูุจูุฉ',
        'ุญุฐู': 'ุญุฐู',
        'ุชูููู': 'ุชูููู ุฃุฏุงุก',
        'ุฏููู': 'ุณุฌู ุงูุฏููู',
        'ูุดููุฉ': 'ูุดููุฉ ุจุนุฏ ุงูุชุฑููุจ'
    };
    
    return typeTitles[type] || 'ุนูููุฉ';
}

function getSmartHistoryIcon(item) {
    const type = getSmartItemType(item);
    const icons = {
        'ุฏูุนุฉ': 'fa-money-bill-wave',
        'ูุตุฑูู': 'fa-receipt',
        'ููู': 'fa-truck',
        'ุชุนููู': 'fa-user-plus',
        'ุชุนุฏูู': 'fa-edit',
        'ุฅูุดุงุก': 'fa-plus-circle',
        'ุญุฐู': 'fa-trash',
        'ุชูููู': 'fa-star',
        'ุฏููู': 'fa-file-invoice-dollar',
        'ูุดููุฉ': 'fa-exclamation-triangle'
    };
    return icons[type] || 'fa-history';
}

function getSmartHistoryColor(type) {
    const colors = {
        'ุฏูุนุฉ': 'history-item-payment',
        'ูุตุฑูู': 'history-item-expense',
        'ููู': 'history-item-transport',
        'ุชุนููู': 'history-item-assignment',
        'ุชุนุฏูู': 'history-item-modification',
        'ุฅูุดุงุก': 'history-item-creation',
        'ุญุฐู': 'history-item-deletion',
        'ุชูููู': 'history-item-evaluation',
        'ุฏููู': 'history-item-debt',
        'ูุดููุฉ': 'history-item-issue'
    };
    return colors[type] || 'history-item-modification';
}

function getTypeBadgeColor(type) {
    const colors = {
        'ุฏูุนุฉ': 'badge-success',
        'ูุตุฑูู': 'badge-error',
        'ููู': 'badge-warning',
        'ุชุนููู': 'badge-info',
        'ุชุนุฏูู': 'badge-primary',
        'ุฅูุดุงุก': 'badge-success',
        'ุญุฐู': 'badge-error',
        'ุชูููู': 'badge-warning',
        'ุฏููู': 'badge-danger',
        'ูุดููุฉ': 'badge-danger'
    };
    return colors[type] || 'badge-primary';
}

function getTypeArabicName(type) {
    const names = {
        'ุฏูุนุฉ': 'ุฏูุนุฉ',
        'ูุตุฑูู': 'ูุตุฑูู',
        'ููู': 'ููู',
        'ุชุนููู': 'ุชุนููู',
        'ุชุนุฏูู': 'ุชุนุฏูู',
        'ุฅูุดุงุก': 'ุฅูุดุงุก',
        'ุญุฐู': 'ุญุฐู',
        'ุชูููู': 'ุชูููู',
        'ุฏููู': 'ุฏููู',
        'ูุดููุฉ': 'ูุดููุฉ'
    };
    return names[type] || 'ุนูููุฉ';
}

function extractReliableUserName(item) {
    if (!item) return 'ุงููุธุงู';
    
    // ุงููุญุงููุฉ 1: ูู ุญูู user ูุจุงุดุฑุฉ
    if (item.user && item.user !== 'ุงููุธุงู' && item.user !== 'undefined' && item.user !== 'null') {
        return item.user;
    }
    
    // ุงููุญุงููุฉ 2: ูู ุญูู user_name ุฅุฐุง ูุงู ููุฌูุฏุงู
    if (item.user_name && item.user_name !== 'ุงููุธุงู') {
        return item.user_name;
    }
    
    // ุงููุญุงููุฉ 3: ุงุณุชุฎุฑุงุฌ ูู ุงูุชูุงุตูู
    if (item.details) {
        const userMatch = item.details.match(/ุจูุงุณุทุฉ[:\s]*([^.-]+)/);
        if (userMatch && userMatch[1]) {
            return userMatch[1].trim();
        }
    }
    
    return 'ุงููุธุงู';
}

function cleanDescription(description) {
    if (!description) return '';
    // ุฅุฒุงูุฉ "ุจูุงุณุทุฉ" ูุฃู ูุนูููุงุช ูุณุชุฎุฏู ูู ุงูุชูุงุตูู ููุนุฑุถ ุงููุธูู
    return description.replace(/ุจูุงุณุทุฉ[^.]*\.?/g, '').trim();
}

function formatHistoryDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString;
    }
}

async function loadRealUsersForFilter() {
    try {
        const userFilter = document.getElementById('historyUserFilter');
        if (!userFilter) return;

        // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ ูุน ุงูุญูุงุธ ุนูู "ุฌููุน ุงููุณุชุฎุฏููู"
        const allUsersOption = userFilter.querySelector('option[value=""]');
        userFilter.innerHTML = '';
        if (allUsersOption) {
            userFilter.appendChild(allUsersOption);
        } else {
            userFilter.innerHTML = '<option value="">ุฌููุน ุงููุณุชุฎุฏููู</option>';
        }

        // ุฌูุจ ุฌููุน ุงููุณุชุฎุฏููู ูู API
        const response = await fetch('/api/users/all');
        if (response.ok) {
            const usersData = await response.json();
            
            if (usersData.success && usersData.users) {
                // ุฅุถุงูุฉ ุงููุณุชุฎุฏููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                usersData.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    userFilter.appendChild(option);
                });
                
                console.log('โ ุชู ุชุญููู ููุชุฑ ุงููุณุชุฎุฏููู ูู API:', usersData.users.length + ' ูุณุชุฎุฏู');
            }
        } else {
            // ุฅุฐุง ูุดู APIุ ุงุณุชุฎุฏู ุงูุทุฑููุฉ ุงููุฏููุฉ ูู ุงูุณุฌู
            const historyItems = document.querySelectorAll('.history-item');
            const usersFromHistory = new Set();
            
            historyItems.forEach(item => {
                const user = item.getAttribute('data-user');
                if (user && user !== 'ุงููุธุงู' && user !== 'undefined' && user !== 'null') {
                    usersFromHistory.add(user);
                }
            });

            // ุฅุถุงูุฉ ุงููุณุชุฎุฏููู ูู ุงูุณุฌู
            usersFromHistory.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });

            console.log('โ ุชู ุชุญููู ููุชุฑ ุงููุณุชุฎุฏููู ูู ุงูุณุฌู:', Array.from(usersFromHistory));
        }

    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ููุชุฑ ุงููุณุชุฎุฏููู:', error);
        // ุงูุทุฑููุฉ ุงูุงุญุชูุงุทูุฉ: ุงุณุชุฎุฏุงู ุงููุณุชุฎุฏููู ูู ุงูุณุฌู
        const userFilter = document.getElementById('historyUserFilter');
        if (userFilter) {
            const historyItems = document.querySelectorAll('.history-item');
            const usersFromHistory = new Set();
            
            historyItems.forEach(item => {
                const user = item.getAttribute('data-user');
                if (user && user !== 'ุงููุธุงู' && user !== 'undefined' && user !== 'null') {
                    usersFromHistory.add(user);
                }
            });

            usersFromHistory.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });
        }
    }
}

// ุฏูุงู ุงููุณุงุนุฏุฉ ููููุงุชุฑ
function checkUserFilter(item, selectedUser) {
    const userName = extractReliableUserName(item);
    return userName === selectedUser;
}

function checkTypeFilter(item, selectedType) {
    const itemType = getSmartItemType(item);
    return itemType === selectedType;
}

function checkDateFilter(item, dateFrom, dateTo) {
    const itemDate = new Date(item.timestamp);
    
    if (dateFrom) {
        const fromDate = new Date(dateFrom);
        if (itemDate < fromDate) return false;
    }
    
    if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
        if (itemDate > toDate) return false;
    }
    
    return true;
}

function checkTextFilter(item, searchText) {
    const searchableText = [
        item.details || '',
        item.description || '',
        item.change_type || '',
        extractReliableUserName(item)
    ].join(' ').toLowerCase();
    
    return searchableText.includes(searchText.toLowerCase());
}

// ======================= //
// ๐ ATTACHMENTS SYSTEM   //
// ======================= //

function showAttachments(orderId) {
    if (!orderId) {
        showToast('ูุนุฑู ุงูุทูุจูุฉ ุบูุฑ ุตุงูุญ', 'error');
        return;
    }
    
    currentOrderId = orderId;
    const attachmentsOrderId = document.getElementById('attachmentsOrderId');
    if (attachmentsOrderId) attachmentsOrderId.textContent = orderId;
    
    loadCurrentAttachments(orderId);
    showModal('attachmentsModal');
}

function loadCurrentAttachments(orderId) {
    showMobileLoader();
    fetch(`/api/orders/${orderId}/attachments`)
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('currentAttachmentsList');
            const countElement = document.getElementById('attachmentsCount');
            
            if (!container || !countElement) return;
            
            if (data.success && data.attachments && data.attachments.length > 0) {
                countElement.textContent = data.attachments.length;
                let html = '';
                
                data.attachments.forEach(attachment => {
                    const fileIcon = getFileIcon(attachment.file_type);
                    const fileSize = formatFileSize(attachment.file_size);
                    const isImage = attachment.file_type === 'image';
                    
                    html += `
                        <div class="attachment-item">
                            <div class="attachment-content">
                                <div class="attachment-icon">
                                    <i class="fas fa-${fileIcon}"></i>
                                </div>
                                <div class="attachment-details">
                                    <div class="attachment-name">${attachment.original_filename}</div>
                                    <div class="attachment-meta">
                                        <span>${fileSize}</span>
                                        <span>โข</span>
                                        <span>${attachment.captured_at}</span>
                                    </div>
                                    <div class="attachment-user">ุจูุงุณุทุฉ: ${attachment.captured_by}</div>
                                </div>
                            </div>
                            <div class="attachment-actions">
                                ${isImage ? `
                                <button onclick="previewAttachmentDirectly(${attachment.id})" class="attachment-action view">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ` : ''}
                                <a href="/api/attachments/${attachment.id}/download" class="attachment-action download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <button onclick="deleteAttachmentPermanently(${attachment.id})" class="attachment-action delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } else {
                countElement.textContent = '0';
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>ูุง ุชูุฌุฏ ูุฑููุงุช ุญุงููุฉ</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading attachments:', error);
            const container = document.getElementById('currentAttachmentsList');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช</p>
                    </div>
                `;
            }
        })
        .finally(() => {
            hideMobileLoader();
        });
}

function previewAttachmentDirectly(attachmentId) {
    if (!attachmentId) return;
    window.open(`/api/attachments/${attachmentId}/view`, '_blank');
}

function deleteAttachmentPermanently(attachmentId) {
    if (!attachmentId) return;
    
    if (confirm('โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฑููุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
        showMobileLoader();
        fetch(`/api/attachments/${attachmentId}/delete`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('๐๏ธ ุชู ุญุฐู ุงููุฑูู ุจูุฌุงุญ');
                loadCurrentAttachments(currentOrderId);
            } else {
                showToast('โ ' + (data.error || 'ุฎุทุฃ ูู ุงูุญุฐู'), 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting attachment:', error);
            showToast('โ ุฎุทุฃ ูู ุญุฐู ุงููุฑูู', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
    }
}

// ุฅุฏุงุฑุฉ ุฑูุน ุงููููุงุช
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('newFileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                currentUploadedFiles = Array.from(files);
                showUploadPreview(currentUploadedFiles);
            }
        });
    }
});

function showUploadPreview(files) {
    const previewContainer = document.getElementById('previewContainer');
    const uploadPreviewSection = document.getElementById('uploadPreview');
    
    if (!previewContainer || !uploadPreviewSection) return;
    
    let html = '';
    files.forEach((file, index) => {
        const fileType = file.type.split('/')[0];
        const isImage = fileType === 'image';
        const isPDF = file.type === 'application/pdf';
        
        html += `
            <div class="preview-item">
                <div class="preview-content">
                    ${isImage ? `
                    <div class="preview-image">
                        <img src="${URL.createObjectURL(file)}" alt="ูุนุงููุฉ">
                    </div>
                    ` : `
                    <div class="preview-icon">
                        <i class="fas fa-${isPDF ? 'file-pdf' : 'file'}"></i>
                    </div>
                    `}
                    <div class="preview-details">
                        <div class="preview-name">${file.name}</div>
                        <div class="preview-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFileFromUpload(${index})" class="preview-remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    previewContainer.innerHTML = html;
    uploadPreviewSection.classList.remove('hidden');
    
    uploadFilesAutomatically(files);
}

function uploadFilesAutomatically(files) {
    const formData = new FormData();
    formData.append('order_id', currentOrderId);
    
    files.forEach(file => {
        formData.append('attachments', file);
    });
    
    const previewContainer = document.getElementById('previewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = `
            <div class="upload-progress">
                <i class="fas fa-spinner fa-spin"></i>
                <p>ุฌุงุฑู ุฑูุน ${files.length} ููู...</p>
            </div>
        `;
    }
    
    showMobileLoader();
    fetch('/api/orders/upload-attachments', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(`โ ุชู ุฑูุน ${files.length} ููู ุจูุฌุงุญ`);
            loadCurrentAttachments(currentOrderId);
            const uploadPreview = document.getElementById('uploadPreview');
            if (uploadPreview) uploadPreview.classList.add('hidden');
            currentUploadedFiles = [];
            const fileInput = document.getElementById('newFileInput');
            if (fileInput) fileInput.value = '';
        } else {
            showToast('โ ' + (data.error || 'ุฎุทุฃ ูู ุงูุฑูุน'), 'error');
            showUploadPreview(files);
        }
    })
    .catch(error => {
        console.error('Error uploading files:', error);
        showToast('โ ุฎุทุฃ ูู ุฑูุน ุงููููุงุช', 'error');
        showUploadPreview(files);
    })
    .finally(() => {
        hideMobileLoader();
    });
}

function removeFileFromUpload(index) {
    if (currentUploadedFiles.length > index) {
        currentUploadedFiles.splice(index, 1);
        if (currentUploadedFiles.length > 0) {
            showUploadPreview(currentUploadedFiles);
        } else {
            const uploadPreview = document.getElementById('uploadPreview');
            if (uploadPreview) uploadPreview.classList.add('hidden');
        }
    }
}

// ======================= //
// ๐ PHONE MANAGEMENT     //
// ======================= //

function togglePhoneOptions(phoneNumber) {
    if (!phoneNumber) return;
    
    const menuId = `phoneOptions-${phoneNumber.replace(/\+/g, '').replace(/ /g, '')}`;
    const menu = document.getElementById(menuId);
    
    // ุฅุฎูุงุก ุฌููุน ุงูููุงุฆู ุงูุฃุฎุฑู
    document.querySelectorAll('.phone-options-popup').forEach(popup => {
        if (popup.id !== menuId) {
            popup.classList.add('hidden');
        }
    });
    
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function copyPhoneNumber(phoneNumber) {
    if (!phoneNumber) return;
    
    navigator.clipboard.writeText(phoneNumber).then(() => {
        showToast('โ ุชู ูุณุฎ ุงูุฑูู: ' + phoneNumber);
        document.querySelectorAll('.phone-options-popup').forEach(menu => {
            menu.classList.add('hidden');
        });
        hideModal('mobilePhoneModal');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('โ ูุดู ูู ูุณุฎ ุงูุฑูู', 'error');
    });
}

// ======================= //
// ๐ง UTILITY FUNCTIONS    //
// ======================= //

function getFileIcon(fileType) {
    const icons = {
        'image': 'file-image',
        'video': 'file-video',
        'pdf': 'file-pdf',
        'document': 'file-word'
    };
    return icons[fileType] || 'file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showAddStatusModal() {
    const statusName = prompt('ุฃุฏุฎู ุงุณู ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:');
    if (statusName) {
        const formData = new FormData();
        formData.append('name', statusName);
        
        showMobileLoader();
        fetch('/api/status/add', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('ุชู ุฅุถุงูุฉ ุงูุญุงูุฉ ุจูุฌุงุญ');
                const select = document.getElementById('order_status');
                if (select) {
                    const newOption = new Option(data.status.name, data.status.id);
                    select.add(newOption);
                    select.value = data.status.id;
                }
            } else {
                showToast(data.error || 'ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุญุงูุฉ', 'error');
            }
        })
        .catch(error => {
            console.error('Error adding status:', error);
            showToast('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุญุงูุฉ', 'error');
        })
        .finally(() => {
            hideMobileLoader();
        });
    }
}

// ======================= //
// ๐ REFRESH & UPDATE SYSTEM //
// ======================= //

function updateOrdersAfterOperation(orderId, newData = null) {
    if (newData) {
        updateOrderRow(orderId, newData);
    } else {
        setTimeout(() => {
            location.reload();
        }, 500);
    }
    
    setTimeout(() => {
        preserveAndReapplyFilters();
        updateOrdersHealthStats();
    }, 1000);
}

function preserveAndReapplyFilters() {
    const searchTerm = document.getElementById('searchInput')?.value;
    const statusFilter = document.getElementById('statusFilter')?.value;
    const workerFilter = document.getElementById('workerFilter')?.value;
    const healthFilter = document.getElementById('healthFilter')?.value;
    
    setTimeout(() => {
        if (searchTerm || statusFilter || workerFilter || healthFilter) {
            performSmartSearch();
        }
    }, 300);
}

function reapplyFiltersToRow(row) {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const workerFilter = document.getElementById('workerFilter');
    const healthFilter = document.getElementById('healthFilter');
    
    if (!searchInput || !statusFilter || !workerFilter || !healthFilter) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const workerValue = workerFilter.value;
    const healthValue = healthFilter.value;
    
    const searchIndex = row.getAttribute('data-search-index') || '';
    const rowStatus = row.dataset.status || '';
    const rowWorkerIds = row.dataset.workerIds || '';
    const rowHealthStatus = row.dataset.healthStatus || '';
    
    const matchesSearch = searchTerm === '' || searchIndex.includes(searchTerm);
    const matchesStatus = statusValue === '' || rowStatus === statusValue;
    const matchesWorker = workerValue === '' || rowWorkerIds.includes(workerValue);
    const matchesHealth = healthValue === '' || rowHealthStatus === healthValue;
    
    if (matchesSearch && matchesStatus && matchesWorker && matchesHealth) {
        row.style.display = '';
    } else {
        row.style.display = 'none';
    }
}

// ======================= //
// ๐ ORDER FORM HANDLING  //
// ======================= //

document.addEventListener('DOMContentLoaded', function() {
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', handleOrderFormSubmit);
    }
});

function handleOrderFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const isEdit = !!document.getElementById('order_id')?.value;
    
    showMobileLoader();
    fetch(e.target.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(isEdit ? 'ุชู ุชุนุฏูู ุงูุทูุจูุฉ ุจูุฌุงุญ' : 'ุชู ุฅุถุงูุฉ ุงูุทูุจูุฉ ุจูุฌุงุญ');
            hideModal('orderModal');
            
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            showToast(data.error || 'ุญุฏุซ ุฎุทุฃ', 'error');
        }
    })
    .catch(error => {
        console.error('Order form error:', error);
        showToast('ุฎุทุฃ ูู ุญูุธ ุงูุทูุจูุฉ', 'error');
    })
    .finally(() => {
        hideMobileLoader();
    });
}

// ======================= //
// ๐ฐ ูุธุงู ุงูุฏููู ุงูุฌุฏูุฏ   //
// ======================= //

// ุชุญููู ุฅุญุตุงุฆูุงุช ุฏููู ุงูุทูุจูุงุช
async function loadOrdersDebtsStats() {
    try {
        const response = await fetch('/api/orders/related_debts');
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            const debtsTotal = document.getElementById('ordersDebtsTotal');
            const affectedOrders = document.getElementById('affectedOrdersCount');
            const debtCard = document.getElementById('ordersDebtsCard');
            
            if (debtsTotal) debtsTotal.textContent = data.total_debts.toFixed(2) + ' ุฏุฌ';
            if (affectedOrders) affectedOrders.textContent = data.affected_orders;
            
            // ุชุญุฏูุซ ููู ุงูุจุทุงูุฉ ุญุณุจ ุญุฌู ุงูุฏููู
            if (debtCard) {
                if (data.total_debts === 0) {
                    debtCard.className = debtCard.className.replace('from-orange-500.to-orange-600', 'from-green-500.to-green-600');
                } else if (data.total_debts > 10000) {
                    debtCard.className = debtCard.className.replace('from-orange-500.to-orange-600', 'from-red-500.to-red-600');
                } else {
                    debtCard.className = debtCard.className.replace('from-green-500.to-green-600', 'from-orange-500.to-orange-600');
                    debtCard.className = debtCard.className.replace('from-red-500.to-red-600', 'from-orange-500.to-orange-600');
                }
            }
        }
    } catch (error) {
        console.error('Error loading orders debts stats:', error);
    }
}

// ุนุฑุถ ุงูุทูุจูุงุช ุงููุชุฃุซุฑุฉ ุจุงูุฏููู
async function showOrdersWithDebts() {
    try {
        showMobileLoader();
        const response = await fetch('/api/orders/with_debts');
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            updateOrdersDebtsModal(data);
            showModal('ordersDebtsModal');
        } else {
            showToast('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุฏููู', 'error');
        }
    } catch (error) {
        console.error('Error loading orders with debts:', error);
        showToast('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุฏููู', 'error');
    } finally {
        hideMobileLoader();
    }
}

// ุชุญุฏูุซ ููุฏุงู ุงูุทูุจูุงุช ุงููุชุฃุซุฑุฉ
function updateOrdersDebtsModal(data) {
    if (!data || !data.statistics) return;
    
    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    const elements = {
        'modalTotalDebts': data.statistics.total_debts.toFixed(2) + ' ุฏุฌ',
        'modalAffectedOrders': data.statistics.affected_orders,
        'modalAverageDebt': data.statistics.average_debt.toFixed(2) + ' ุฏุฌ',
        'modalDebtFreeOrders': data.statistics.debt_free_orders
    };
    
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = elements[id];
    });
    
    // ุชุญุฏูุซ ุงูุนููุงู
    const summary = document.getElementById('ordersDebtsSummary');
    if (summary) {
        summary.textContent = 
            `${data.statistics.affected_orders} ุทูุจูุฉ ุจุฅุฌูุงูู ${data.statistics.total_debts.toFixed(2)} ุฏุฌ ุฏููู`;
    }
    
    // ุชุญุฏูุซ ุงููุงุฆูุฉ
    const tbody = document.getElementById('ordersDebtsList');
    if (!tbody) return;
    
    if (data.orders && data.orders.length > 0) {
        tbody.innerHTML = data.orders.map(order => `
            <tr class="border-b hover:bg-gray-50 transition-colors">
                <td class="p-3 font-mono text-sm">#${order.order_id}</td>
                <td class="p-3 font-medium">${order.customer_name}</td>
                <td class="p-3">${order.total_amount.toFixed(2)} ุฏุฌ</td>
                <td class="p-3 font-bold text-red-600">${order.debt_amount.toFixed(2)} ุฏุฌ</td>
                <td class="p-3">
                    <div class="flex items-center gap-2">
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${getDebtProgressClass(order.debt_percentage)}" 
                                 style="width: ${Math.min(order.debt_percentage, 100)}%"></div>
                        </div>
                        <span class="text-sm font-medium">${order.debt_percentage.toFixed(1)}%</span>
                    </div>
                </td>
                <td class="p-3">
                    <span class="badge ${getDebtStatusBadge(order.status)}">${order.status}</span>
                </td>
                <td class="p-3">
                    <button onclick="viewOrderWithDebt(${order.order_id})" class="btn-primary text-xs px-3 py-1">
                        <i class="fas fa-eye ml-1"></i>
                        ุนุฑุถ ุงูุณุฌู
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="p-8 text-center text-gray-500">
                    <i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i>
                    <p class="text-lg">๐ ูุง ุชูุฌุฏ ุฏููู ุนูู ุงูุทูุจูุงุช</p>
                    <p class="text-sm mt-2">ุฌููุน ุงูุทูุจูุงุช ุญุงููุงู ุฎุงููุฉ ูู ุงูุฏููู</p>
                </td>
            </tr>
        `;
    }
}

// ุงูุญุตูู ุนูู ููู ุดุฑูุท ุงูุชูุฏู ุญุณุจ ูุณุจุฉ ุงูุฏูู
function getDebtProgressClass(percentage) {
    if (percentage <= 30) return 'bg-green-500';
    if (percentage <= 60) return 'bg-yellow-500';
    return 'bg-red-500';
}

// ุงูุญุตูู ุนูู ููู ุงูุจุงุฏุฌ ุญุณุจ ุญุงูุฉ ุงูุฏูู
function getDebtStatusBadge(status) {
    const statusMap = {
        'ุฏููู ุนุงููุฉ': 'badge-danger',
        'ุฏููู ูุชูุณุทุฉ': 'badge-warning', 
        'ุฏููู ููููุฉ': 'badge-info',
        'ุจุฏูู ุฏููู': 'badge-success'
    };
    return statusMap[status] || 'badge-primary';
}

// ุนุฑุถ ุทูุจูุฉ ูุญุฏุฏุฉ ูู ูุงุฆูุฉ ุงูุฏููู
function viewOrderWithDebt(orderId) {
    if (!orderId) return;
    
    hideModal('ordersDebtsModal');
    showHistory(orderId);
}

// ุชุญุฏูุซ ุฏููู ุงูุทูุจูุฉ ูู ุงูุณุฌู
async function updateOrderDebtCard(orderId) {
    if (!orderId) return;
    
    try {
        const response = await fetch(`/api/orders/${orderId}/debts`);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        if (data.success) {
            const debtInfo = data.debts_info;
            const debtCard = document.getElementById('orderDebtCard');
            const statusText = document.getElementById('debtStatusText');
            const historyOrderDebt = document.getElementById('historyOrderDebt');
            
            if (historyOrderDebt) {
                historyOrderDebt.textContent = debtInfo.remaining_debt.toFixed(2) + ' ุฏุฌ';
            }
            
            if (debtCard && statusText) {
                // ุชุญุฏูุซ ุญุงูุฉ ุงูุจุทุงูุฉ
                if (debtInfo.remaining_debt === 0) {
                    debtCard.className = debtCard.className.replace('from-red-500.to-pink-600', 'from-green-500.to-green-600');
                    debtCard.className = debtCard.className.replace('from-yellow-500.to-orange-600', 'from-green-500.to-green-600');
                    statusText.textContent = 'โ ุฎุงููุฉ ูู ุงูุฏููู';
                } else if (debtInfo.remaining_debt < debtInfo.total_debt * 0.5) {
                    debtCard.className = debtCard.className.replace('from-red-500.to-pink-600', 'from-yellow-500.to-orange-600');
                    debtCard.className = debtCard.className.replace('from-green-500.to-green-600', 'from-yellow-500.to-orange-600');
                    statusText.textContent = '๐ก ุฏููู ุฌุฒุฆูุฉ';
                } else {
                    debtCard.className = debtCard.className.replace('from-yellow-500.to-orange-600', 'from-red-500.to-pink-600');
                    debtCard.className = debtCard.className.replace('from-green-500.to-green-600', 'from-red-500.to-pink-600');
                    statusText.textContent = '๐ด ุฏููู ูุณุชุญูุฉ';
                }
            }
        }
    } catch (error) {
        console.error('Error updating order debt card:', error);
    }
}

// ุจุฏุก ูุฑุงูุจุฉ ุชุญุฏูุซุงุช ุงูุฏููู
function startDebtMonitoring(orderId) {
    if (!orderId) return;
    
    // ุชุญุฏูุซ ููุฑู ุฃููู
    updateOrderDebtCard(orderId);
    
    // ุฅููุงู ุฃู ูุฑุงูุจุฉ ุณุงุจูุฉ
    if (debtMonitoringInterval) {
        clearInterval(debtMonitoringInterval);
    }
    
    // ุจุฏุก ูุฑุงูุจุฉ ุฌุฏูุฏุฉ ูู 15 ุซุงููุฉ
    debtMonitoringInterval = setInterval(() => {
        updateOrderDebtCard(orderId);
    }, 15000);
}

// ุฅููุงู ูุฑุงูุจุฉ ุงูุฏููู
function stopDebtMonitoring() {
    if (debtMonitoringInterval) {
        clearInterval(debtMonitoringInterval);
        debtMonitoringInterval = null;
    }
}

// ุนุฑุถ ุชูุงุตูู ุฏููู ุงูุทูุจูุฉ
function showDebtDetails(orderId) {
    if (orderId) {
        window.open(`/debts?order_id=${orderId}`, '_blank');
    } else {
        showToast('โ ูุง ุชูุฌุฏ ุทูุจูุฉ ูุญุฏุฏุฉ', 'error');
    }
}

// ูุฑุงูุจุฉ ุฅุบูุงู ุงูููุฏุงู ูุฅููุงู ุงููุฑุงูุจุฉ
function setupModalCloseMonitoring() {
    const modal = document.getElementById('historyModal');
    if (modal) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class' && !mutation.target.classList.contains('active')) {
                    stopDebtMonitoring();
                }
            });
        });
        
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
    }
}

// ======================= //
// ๐ฏ INITIALIZATION       //
// ======================= //

function initializeApplication() {
    if (isInitialized) return;
    
    console.log('๐ ุจุฏุก ุชููุฆุฉ ูุธุงู ุงูุทูุจูุงุช ุงููุชูุฏู...');
    
    // ุฅุนุฏุงุฏ ุฅุฏุงุฑุฉ ุงูููุงูุฐ
    setupModalManagement();
    
    // ุฅุนุฏุงุฏ ุงูุจุญุซ ูุงูููุงุชุฑ
    setupSearchAndFilters();
    
    // ุฅุนุฏุงุฏ ุชุญุณููุงุช ุงูุฌูุงู
    setupMobileOptimizations();
    
    // ุฅุนุฏุงุฏ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุดุจูุฉ
    setupNetworkErrorHandling();
    
    // ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ ููุฃุนูู
    initScrollToTop();
    
    // ุชุญููู ุงูุชูุงููู
    loadTotalCosts();
    
    // ุฅุนุฏุงุฏ ุงูุชุญุฏูุซ ุงูุชููุงุฆู
    setupCostsAutoRefresh();
    
    // โ ุชุญููู ุฅุญุตุงุฆูุงุช ุงูุฏููู
    loadOrdersDebtsStats();
    
    // โ ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุทูุจูุงุช ุงูุณูููุฉ
    updateOrdersHealthStats();
    
    // โ ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุฏููู ูู ุฏูููุฉ
    setInterval(loadOrdersDebtsStats, 60000);
    setInterval(updateOrdersHealthStats, 30000);
    
    // โ ุฅุนุฏุงุฏ ูุฑุงูุจุฉ ุฅุบูุงู ุงูููุฏุงู
    setupModalCloseMonitoring();
    
    // ุฅุนุฏุงุฏ ุฒุฑ ุงูุฅุถุงูุฉ
    const addButton = document.getElementById('btnAdd');
    if (addButton) {
        addButton.addEventListener('click', showAddForm);
    }
    
    isInitialized = true;
    console.log('โ ุชู ุชููุฆุฉ ุฌููุน ุงูุฃูุธูุฉ ุจูุฌุงุญ');
}

function setupModalManagement() {
    // ุฅุบูุงู ุงูููุงูุฐ ุจุงูููุฑ ุฎุงุฑุฌูุง
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            hideModal(event.target.id);
        }
    });

    // ุฅุบูุงู ุงูููุงูุฐ ุจุงูุฒุฑ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                hideModal(activeModal.id);
            }
        }
    });
}

function setupMobileOptimizations() {
    // ููุน ุงูุชูุจูุฑ ุงูุชููุงุฆู ุนูู ุญููู ุงูุฅุฏุฎุงู
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.style.fontSize = '16px';
        });
    });
    
    // ุชุญุณูู ุฃุฏุงุก ุงูุชูุฑูุฑ
    document.body.style.webkitOverflowScrolling = 'touch';
}

function setupNetworkErrorHandling() {
    window.addEventListener('online', function() {
        showToast('โ ุชู ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช', 'success');
        setTimeout(() => {
            loadTotalCosts();
            loadOrdersDebtsStats();
            updateOrdersHealthStats();
        }, 1000);
    });

    window.addEventListener('offline', function() {
        showToast('โ๏ธ ููุฏุงู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช', 'warning');
    });
}

// ุชุณุฌูู ุงูุฃุฎุทุงุก
function logError(error, context) {
    console.error(`Error in ${context}:`, error);
    
    if (appState.isOnline) {
        fetch('/api/log-error', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                error: error.message,
                context: context,
                timestamp: new Date().toISOString(),
                url: window.location.href
            })
        }).catch(e => console.error('Failed to log error:', e));
    }
}

// ุชูุธูู ุงูููุงุฑุฏ ุนูุฏ ุฅุบูุงู ุงูุตูุญุฉ
window.addEventListener('beforeunload', () => {
    if (debtMonitoringInterval) {
        clearInterval(debtMonitoringInterval);
    }
    
    // ุชูุธูู ุฌููุน ุงูู timeouts
    Object.keys(appState.timeouts).forEach(key => {
        clearTimeout(appState.timeouts[key]);
    });
});

// ุชููุฆุฉ ุงูุชุทุจูู
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApplication);
} else {
    initializeApplication();
}
</script>

<!-- ======================= -->
<!-- ๐จ MODERN STYLES -->
<!-- ======================= -->
<style>
/* Modern Modal System */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.active {
    display: flex;
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: modalSlideIn 0.3s ease-out;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-content.modern-modal {
    width: 100%;
    max-width: 500px;
}

.modal-content.compact {
    max-width: 400px;
}

.modal-content.large {
    max-width: 800px;
}

.modal-content.xlarge {
    max-width: 1000px;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.modal-body {
    padding: 1.5rem;
    flex: 1;
    overflow-y: auto;
}

.modal-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
}

/* Form Styles */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: white;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-action-btn {
    padding: 0.75rem;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.form-action-btn:hover {
    background: #e5e7eb;
}

/* Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-secondary {
    background: #6b7280;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #4b5563;
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-outline {
    background: transparent;
    color: #6b7280;
    border: 1px solid #d1d5db;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-outline:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Action Buttons */
.action-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    color: white;
    font-size: 1.25rem;
}

.action-btn.large {
    width: 64px;
    height: 64px;
    font-size: 1.5rem;
}

.action-btn.primary {
    background: #3b82f6;
}

.action-btn.success {
    background: #10b981;
}

.action-btn.whatsapp {
    background: #25d366;
}

.action-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

/* Feature Sections */
.feature-section {
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid;
}

.feature-section.blue {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    border-color: #bfdbfe;
}

.feature-section.purple {
    background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%);
    border-color: #e9d5ff;
}

.feature-section.orange {
    background: linear-gradient(135deg, #fed7aa 0%, #ffedd5 100%);
    border-color: #fdba74;
}

.feature-section.green {
    background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
    border-color: #a7f3d0;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1rem;
}

.section-subtitle {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.75rem;
}

/* Form Container */
.form-container {
    background: white;
    padding: 1.25rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state p {
    margin: 0.5rem 0;
}

.empty-state.error {
    color: #ef4444;
}

/* Assignment Items */
.assignment-item {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-bottom: 0.75rem;
}

.assignment-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.assignment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.125rem;
}

.assignment-details {
    flex: 1;
}

.assignment-name {
    font-weight: 500;
    color: #1f2937;
}

.assignment-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
}

.assignment-type {
    background: #dbeafe;
    color: #1e40af;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.assignment-date {
    font-size: 0.75rem;
    color: #6b7280;
}

.assignment-notes {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.4;
}

.assignment-action {
    background: none;
    border: none;
    color: #ef4444;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.assignment-action:hover {
    background: #fef2f2;
}

/* Stat Cards */
.stat-card {
    padding: 1rem;
    border-radius: 12px;
    color: white;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.stat-card.purple {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.stat-card.green {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.stat-card.orange {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.stat-card.red {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.stat-card.blue {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.stat-card.teal {
    background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
}

.stat-card.indigo {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
}

.stat-label {
    font-size: 0.75rem;
    opacity: 0.9;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 700;
}

/* Progress Section */
.progress-section {
    background: #f3f4f6;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.progress-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.progress-bar-container {
    width: 100%;
    height: 16px;
    background: #e5e7eb;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}

.progress-percentages {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

/* Filter Section */
.filter-section {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-group {
    margin-bottom: 1rem;
}

.filter-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
}

.filter-select,
.filter-input {
    width: 100%;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
}

.filter-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 0.875rem;
}

.advanced-filters {
    transition: all 0.3s ease;
}

/* History Section */
.history-section {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.history-stats {
    background: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    color: #6b7280;
    border: 1px solid #e5e7eb;
}

.history-content {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
}

/* History Items */
.history-item {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.history-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.history-item-payment {
    background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
    border: 1px solid #a7f3d0;
}

.history-item-expense {
    background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
    border: 1px solid #fca5a5;
}

.history-item-transport {
    background: linear-gradient(135deg, #fed7aa 0%, #ffedd5 100%);
    border: 1px solid #fdba74;
}

.history-item-assignment {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    border: 1px solid #93c5fd;
}

.history-item-modification {
    background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%);
    border: 1px solid #d8b4fe;
}

.history-item-creation {
    background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
    border: 1px solid #bbf7d0;
}

.history-item-deletion {
    background: linear-gradient(135deg, #fecaca 0%, #fef2f2 100%);
    border: 1px solid #fca5a5;
}

.history-item-evaluation {
    background: linear-gradient(135deg, #fef3c7 0%, #fefce8 100%);
    border: 1px solid #fcd34d;
}

.history-item-debt {
    background: linear-gradient(135deg, #fef3c7 0%, #fef7cd 100%);
    border: 1px solid #fcd34d;
    border-left: 4px solid #f59e0b;
}

.history-item-issue {
    background: linear-gradient(135deg, #ffedd5 0%, #fef3c7 100%);
    border: 1px solid #fdba74;
    border-left: 4px solid #f59e0b;
}

.history-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid;
    flex-shrink: 0;
}

.history-item-payment .history-icon {
    border-color: #10b981;
    color: #10b981;
}

.history-item-expense .history-icon {
    border-color: #ef4444;
    color: #ef4444;
}

.history-item-transport .history-icon {
    border-color: #f59e0b;
    color: #f59e0b;
}

.history-item-assignment .history-icon {
    border-color: #3b82f6;
    color: #3b82f6;
}

.history-item-modification .history-icon {
    border-color: #8b5cf6;
    color: #8b5cf6;
}

.history-item-creation .history-icon {
    border-color: #10b981;
    color: #10b981;
}

.history-item-deletion .history-icon {
    border-color: #ef4444;
    color: #ef4444;
}

.history-item-evaluation .history-icon {
    border-color: #f59e0b;
    color: #f59e0b;
}

.history-item-debt .history-icon {
    border-color: #f59e0b;
    color: #f59e0b;
}

.history-item-issue .history-icon {
    border-color: #f59e0b;
    color: #f59e0b;
}

.history-details {
    flex: 1;
    min-width: 0;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.history-title {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.875rem;
}

.history-date {
    font-size: 0.75rem;
    color: #6b7280;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.history-description {
    font-size: 0.875rem;
    color: #4b5563;
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.history-user {
    font-size: 0.75rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.history-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-error {
    background: #fee2e2;
    color: #991b1b;
}

.badge-warning {
    background: #fef3c7;
    color: #92400e;
}

.badge-info {
    background: #dbeafe;
    color: #1e40af;
}

.badge-primary {
    background: #f3e8ff;
    color: #6b21a8;
}

.badge-danger {
    background: #fee2e2;
    color: #dc2626;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid #fecaca;
}

/* Upload Section */
.upload-section {
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
}

.upload-section:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
}

.upload-content i {
    font-size: 3rem;
    color: #3b82f6;
    margin-bottom: 1rem;
}

.upload-hint {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.5rem 0;
}

.upload-info {
    font-size: 0.75rem;
    color: #9ca3af;
}

/* Preview Section */
.preview-section {
    margin-bottom: 1.5rem;
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}

.preview-item {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.preview-content {
    position: relative;
    padding: 0.75rem;
}

.preview-image {
    width: 100%;
    height: 100px;
    background: #f3f4f6;
    border-radius: 6px;
    overflow: hidden;
}

.preview-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.preview-icon {
    width: 100%;
    height: 100px;
    background: #f3f4f6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-size: 2rem;
}

.preview-details {
    margin-top: 0.5rem;
}

.preview-name {
    font-size: 0.75rem;
    font-weight: 500;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preview-size {
    font-size: 0.625rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.preview-remove {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.75rem;
}

.upload-progress {
    text-align: center;
    padding: 2rem;
    color: #3b82f6;
}

.upload-progress i {
    font-size: 2rem;
    margin-bottom: 1rem;
}

/* Attachments Section */
.attachments-section {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
}

.attachments-list {
    max-height: 300px;
    overflow-y: auto;
}

.attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-bottom: 0.75rem;
}

.attachment-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.attachment-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #dbeafe;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3b82f6;
    font-size: 1.25rem;
}

.attachment-details {
    flex: 1;
    min-width: 0;
}

.attachment-name {
    font-weight: 500;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.attachment-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.attachment-user {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 0.25rem;
}

.attachment-actions {
    display: flex;
    gap: 0.5rem;
}

.attachment-action {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    color: white;
}

.attachment-action.view {
    background: #3b82f6;
}

.attachment-action.download {
    background: #10b981;
}

.attachment-action.delete {
    background: #ef4444;
}

.attachment-action:hover {
    transform: scale(1.1);
}

/* Info Banner */
.info-banner {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.info-banner.blue {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #bfdbfe;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1100;
    animation: toastSlideIn 0.3s ease-out;
    max-width: 300px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.toast-notification.fade-out {
    animation: toastSlideOut 0.3s ease-in forwards;
}

.toast-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.toast-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.toast-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.toast-info {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

/* Mobile Loader */
.mobile-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    z-index: 1200;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loader-content {
    text-align: center;
}

.loader-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

.loader-text {
    color: #6b7280;
    font-weight: 500;
}

/* Scroll to Top */
.scroll-to-top {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
    z-index: 100;
}

.scroll-to-top:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

/* Phone Options */
.phone-options-popup {
    position: absolute;
    z-index: 10;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
}

.phone-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
    transition: all 0.2s ease;
}

.phone-btn:hover {
    transform: scale(1.1);
}

/* Issue Items */
.issue-item {
    border-left: 4px solid #f59e0b;
    transition: all 0.2s ease;
}

.issue-item:hover {
    transform: translateX(4px);
}

/* Performance Evaluation */
.performance-insight {
    border-left: 4px solid;
    padding-left: 1rem;
}

.performance-insight.high {
    border-left-color: #ef4444;
}

.performance-insight.medium {
    border-left-color: #f59e0b;
}

.performance-insight.low {
    border-left-color: #10b981;
}

.performance-insight.info {
    border-left-color: #3b82f6;
}

/* Animations */
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes toastSlideIn {
    from {
        opacity: 0;
        transform: translateX(-100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes toastSlideOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(-100%);
    }
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* ุชุญุณููุงุช ุฅุถุงููุฉ ููุฃุฏุงุก */
.order-row-updating {
    opacity: 0.7;
    background-color: #f0f9ff !important;
    transition: all 0.3s ease;
}

.search-active {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

.optimized-render {
    will-change: transform, opacity;
    backface-visibility: hidden;
}

/* ุชุฎุตูุตุงุช ุฅุถุงููุฉ ููุฏููู */
.debt-progress {
    background: #e5e7eb;
    border-radius: 10px;
    overflow: hidden;
    height: 8px;
}

.debt-progress-fill {
    height: 100%;
    transition: width 0.5s ease;
}

.debt-progress-low {
    background: linear-gradient(90deg, #10b981, #34d399);
}

.debt-progress-medium {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
}

.debt-progress-high {
    background: linear-gradient(90deg, #ef4444, #f87171);
}

/* ุชุญุณููุงุช ููุฌุฏูู ูู ููุฏุงู ุงูุฏููู */
#ordersDebtsList tr:hover {
    background: #f8fafc !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .modal {
        padding: 0.5rem;
    }
    
    .modal-content {
        margin: 0;
        border-radius: 12px;
        max-height: calc(100vh - 1rem);
    }
    
    .modal-header {
        padding: 1rem;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-actions {
        padding: 1rem;
        flex-direction: column;
    }
    
    .modal-actions button {
        width: 100%;
    }
    
    .grid.grid-cols-1.lg\:grid-cols-3 {
        grid-template-columns: 1fr;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .preview-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .attachment-item {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .attachment-actions {
        justify-content: center;
    }
    
    .history-content {
        flex-direction: column;
        text-align: center;
    }
    
    .history-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .history-footer {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-section .flex-col.md\:flex-row {
        flex-direction: column;
    }
    
    .advanced-filters .grid {
        grid-template-columns: 1fr;
    }
    
    .order-card.updating {
        transform: scale(0.98);
        opacity: 0.8;
        transition: all 0.3s ease;
    }
    
    .history-item-debt {
        margin: 0.5rem;
        padding: 1rem;
    }
    
    #ordersDebtsModal .modal-content {
        margin: 0.5rem;
        width: calc(100% - 1rem);
    }
    
    .stat-card {
        padding: 0.75rem;
    }
    
    .stat-value {
        font-size: 1.1rem;
    }
    
    .performance-insight {
        margin: 0.5rem;
        padding: 1rem;
    }
    
    .issue-item {
        margin: 0.5rem;
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .modal-content.modern-modal,
    .modal-content.compact,
    .modal-content.large,
    .modal-content.xlarge {
        max-width: none;
        width: 100%;
    }
    
    .preview-grid {
        grid-template-columns: 1fr;
    }
    
    .action-btn.large {
        width: 56px;
        height: 56px;
    }
    
    .stat-card {
        padding: 0.75rem;
    }
    
    .stat-value {
        font-size: 1rem;
    }
    
    .grid.grid-cols-7 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .performance-score {
        font-size: 1.5rem;
    }
}

/* Utility Classes */
.hidden {
    display: none !important;
}

.cursor-pointer {
    cursor: pointer;
}

/* Print Styles */
@media print {
    .modal,
    .scroll-to-top,
    .mobile-loader {
        display: none !important;
    }
}
</style>

{% endblock %}
[file content end]